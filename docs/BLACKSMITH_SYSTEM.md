# 铁匠与装备强化系统文档

## 概述

铁匠系统为游戏添加了装备强化和品质重铸功能，让玩家可以提升现有装备的属性，增加游戏深度和策略性。

## 核心功能

### 1. 装备品质系统

装备现在具有6个品质等级，每个品质都有不同的属性倍率和颜色：

| 品质 | 中文名 | 颜色 | 属性倍率 | 出现概率 |
|------|--------|------|----------|----------|
| COMMON | 普通 | 白色 (#ffffff) | 1.0x | 40% |
| UNCOMMON | 优秀 | 绿色 (#1eff00) | 1.2x | 30% |
| RARE | 稀有 | 蓝色 (#0070dd) | 1.5x | 15% |
| EPIC | 史诗 | 紫色 (#a335ee) | 2.0x | 10% |
| LEGENDARY | 传说 | 橙色 (#ff8000) | 3.0x | 4% |
| MYTHIC | 神话 | 金色 (#e6cc80) | 5.0x | 1% |

### 2. 装备强化系统

**功能描述：**
- 玩家可以消耗金币来强化装备，提升装备属性
- 每次强化增加 10% 的属性（复合增长）
- 最高可强化至 +15 级
- 强化成功率：100%（可在配置中调整）

**费用计算：**
```javascript
费用 = 基础费用 * (当前等级 + 1) * (倍率 ^ 当前等级)
基础费用 = 100 金币
倍率 = 1.5
```

**示例：**
- +0 → +1: 100 金币
- +1 → +2: 300 金币
- +2 → +3: 675 金币
- +3 → +4: 1,519 金币

### 3. 品质重铸系统

**功能描述：**
- 玩家可以消耗金币来重新随机装备的品质
- 品质按照权重随机选择
- 可能提升、降低或保持当前品质

**费用计算：**
```javascript
费用 = 基础费用 * 装备等级 * 倍率
基础费用 = 500 金币
倍率 = 2.0
```

**示例：**
- 1级装备: 1,000 金币
- 2级装备: 2,000 金币
- 3级装备: 3,000 金币

## 铁砧对象

### 生成规则

- 每 3 层出现一次（第 3、6、9、12... 层）
- 不与地精商人同层出现
- 随机生成在地板瓷砖上
- 使用资源：`https://i.postimg.cc/Hx8RjW5b/anvil.png`

### 交互方式

玩家走到铁砧旁边时，自动打开铁匠铺界面。

## UI 界面

### 铁匠铺界面布局

```
┌─────────────────────────────────────┐
│           铁匠铺 (标题)              │
├──────────────┬──────────────────────┤
│              │                      │
│  已装备物品  │    装备详情面板      │
│              │                      │
│  - 武器      │  品质: 稀有          │
│  - 护甲      │  强化等级: +3        │
│  - 头盔      │                      │
│  - 靴子      │  当前属性:           │
│  - 戒指      │  物攻: +9            │
│  - 护身符    │                      │
│              │  基础属性:           │
│              │  物攻: +6            │
│              │                      │
│              │  [强化 +4]  [重铸]   │
│              │  费用: 1519 费用: 2000│
└──────────────┴──────────────────────┘
```

### UI 特性

- 深色幻想风格，与游戏整体风格一致
- 金色边框和强调色
- 鼠标悬停效果
- 平滑的过渡动画
- 响应式布局

## 代码结构

### 文件组织

```
src/
├── constants.js              # 添加了品质常量和铁砧配置
├── systems/
│   ├── BlacksmithSystem.js  # 铁匠系统核心逻辑
│   └── MapSystem.js         # 添加了铁砧生成逻辑
├── ui/
│   └── ForgeUI.js           # 铁匠铺UI界面
├── entities.js              # 添加了装备初始化逻辑
└── main.js                  # 添加了铁砧交互处理
```

### 核心类

#### BlacksmithSystem

**职责：**
- 计算强化和重铸费用
- 执行强化和重铸操作
- 管理装备品质和属性
- 提供装备详情信息

**主要方法：**
- `enhanceItem(item, player)` - 强化装备
- `reforgeItem(item, player)` - 重铸品质
- `calculateEnhanceCost(item)` - 计算强化费用
- `calculateReforgeCost(item)` - 计算重铸费用
- `initializeItem(item)` - 初始化装备属性

#### ForgeUI

**职责：**
- 渲染铁匠铺界面
- 处理用户交互
- 显示装备列表和详情
- 提供视觉反馈

**主要方法：**
- `open()` - 打开界面
- `close()` - 关闭界面
- `renderItemList()` - 渲染装备列表
- `renderItemDetails(item)` - 渲染装备详情
- `handleEnhance()` - 处理强化操作
- `handleReforge()` - 处理重铸操作

## 装备数据结构

### 装备对象扩展

```javascript
{
  id: 'SWORD_1',
  name: 'Iron Sword',
  nameZh: '铁剑',
  type: 'WEAPON',
  tier: 2,
  
  // 新增字段
  quality: 'RARE',           // 品质
  enhanceLevel: 3,           // 强化等级
  baseStats: {               // 基础属性（用于计算）
    p_atk: 6
  },
  stats: {                   // 当前属性（经过品质和强化加成）
    p_atk: 9                 // 6 * 1.5 (稀有) * 1.3 (强化+3)
  },
  displayName: '稀有 铁剑 +3' // 显示名称
}
```

## 配置选项

### FORGE_CONFIG (constants.js)

```javascript
export const FORGE_CONFIG = {
  ENHANCE: {
    BASE_COST: 100,           // 基础强化费用
    COST_MULTIPLIER: 1.5,     // 每级费用倍率
    STAT_INCREASE: 0.1,       // 每级属性提升 (10%)
    MAX_LEVEL: 15,            // 最大强化等级
    SUCCESS_RATE: 1.0         // 成功率 (100%)
  },
  REFORGE: {
    BASE_COST: 500,           // 基础重铸费用
    COST_MULTIPLIER: 2.0      // 根据装备等级的费用倍率
  }
};
```

## 游戏平衡建议

### 强化系统

- 前期（+0 到 +5）：费用较低，鼓励玩家尝试
- 中期（+6 到 +10）：费用适中，需要权衡
- 后期（+11 到 +15）：费用极高，仅用于最好的装备

### 重铸系统

- 低级装备：重铸费用低，可以频繁尝试
- 高级装备：重铸费用高，需要谨慎选择
- 建议在获得新装备时先重铸品质，再进行强化

### 铁砧出现频率

- 每 3 层一次：确保玩家有足够的机会使用铁匠服务
- 不与商人同层：避免功能冲突，分散玩家注意力

## 未来扩展建议

1. **强化失败机制**
   - 在高等级强化时引入失败概率
   - 失败时装备等级降低或损坏
   - 添加保护道具防止失败

2. **特殊强化材料**
   - 引入强化石、祝福卷轴等材料
   - 不同材料提供不同的成功率加成
   - 稀有材料可以突破等级上限

3. **装备附魔系统**
   - 添加额外的属性（如吸血、暴击等）
   - 随机附魔或选择性附魔
   - 附魔可以独立于强化和品质

4. **铁匠NPC**
   - 添加铁匠角色和对话
   - 铁匠等级系统（解锁更高级功能）
   - 铁匠任务和奖励

5. **装备分解系统**
   - 分解不需要的装备获得材料
   - 材料可用于强化或重铸

## 测试建议

### 功能测试

1. 验证装备品质正确显示
2. 测试强化费用计算准确性
3. 测试重铸品质随机性
4. 验证属性计算正确性
5. 测试UI交互流畅性

### 平衡测试

1. 记录玩家金币获取速度
2. 统计强化和重铸使用频率
3. 分析玩家装备升级路径
4. 评估系统对游戏进度的影响

### 性能测试

1. 测试大量装备时的UI性能
2. 验证内存占用是否合理
3. 检查是否有内存泄漏

## 常见问题

**Q: 为什么我的装备没有显示品质？**
A: 旧装备需要通过 `blacksmithSystem.initializeItem()` 初始化。新装备会自动初始化。

**Q: 强化后属性没有变化？**
A: 检查装备是否有 `baseStats` 字段。如果没有，系统会自动创建。

**Q: 如何修改强化成功率？**
A: 在 `constants.js` 中修改 `FORGE_CONFIG.ENHANCE.SUCCESS_RATE`。

**Q: 铁砧不出现怎么办？**
A: 检查楼层数是否是3的倍数，且该层没有商人。

## 版本历史

- **v1.0.0** (2024-12-22)
  - 初始版本
  - 实现装备品质系统
  - 实现装备强化系统
  - 实现品质重铸系统
  - 添加铁匠铺UI界面
  - 添加铁砧对象生成

## 致谢

感谢提出这个功能建议！这个系统为游戏增加了很多深度和可玩性。

