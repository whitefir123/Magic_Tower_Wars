# 音效系统集成说明

## 概述

已成功将 Kenney 的 RPG Audio 资源包集成到游戏中。音效系统支持音效池、音调变化和音量控制。

## 文件结构

```
cursormota/
├── assets/audio/kenney_rpg-audio/Audio/
│   ├── doorOpen_1.ogg       # 开门音效
│   ├── handleCoins.ogg      # 金币/交易音效
│   ├── bookFlip2.ogg        # 翻页音效
│   ├── bookOpen.ogg         # 打开书本音效
│   ├── cloth1.ogg           # 布料/装备音效
│   ├── footstep00.ogg       # 脚步声 1
│   ├── footstep01.ogg       # 脚步声 2
│   ├── footstep02.ogg       # 脚步声 3
│   ├── chop.ogg             # 攻击音效
│   ├── metalPot1.ogg        # 受击音效
│   └── drawKnife1.ogg       # 拔刀音效
└── src/audio/
    └── AudioManager.js      # 音效管理器
```

## 核心功能

### 1. AudioManager 单例类

位置：`src/audio/AudioManager.js`

**主要特性：**
- **音效池 (Sound Pool)**：每个音效创建 5 个实例，支持快速连续播放
- **音调变化 (Pitch Variance)**：通过 `playbackRate` 实现随机音调变化
- **音量控制**：从 `Game.settings` 读取音量设置（支持主音量和音效音量）
- **预加载**：在游戏启动时预加载所有音频文件

**使用示例：**
```javascript
const audio = AudioManager.getInstance();

// 播放音效（基础）
audio.play('doorOpen');

// 播放音效（带音调变化）
audio.play('chop', { 
  volume: 0.6, 
  pitchVar: 0.1  // 音调范围：0.9 ~ 1.1
});

// 使用快捷方法
audio.playAttack();      // 攻击音效
audio.playCrit();        // 暴击音效（音调更高）
audio.playHit();         // 受击音效
audio.playDoorOpen();    // 开门音效
audio.playCoins();       // 金币音效
audio.playCloth();       // 布料音效
audio.playBookFlip();    // 翻页音效
audio.playFootstep();    // 脚步声（随机变体）
```

### 2. 集成点

#### a. 游戏主逻辑 (`src/main.js`)
- **初始化**：在 `Game` 构造函数中初始化 `AudioManager`
- **预加载**：在 `init()` 方法中预加载音频文件
- **开门**：打开门时播放 `doorOpen` 音效
- **拾取物品**：
  - 装备：播放 `cloth` 音效
  - 药水/消耗品：播放 `cloth` 音效
  - 钥匙/宝箱：播放 `handleCoins` 音效
- **打开背包**：播放 `cloth` 音效
- **打开商店**：播放 `bookFlip` 音效

#### b. 战斗系统 (`src/systems/CombatSystem.js`)
- **攻击**：
  - 普通攻击：播放 `chop` 音效（带随机音调）
  - 暴击：播放 `chop` 音效（音调更高、音量更大）
- **受击**：播放 `metalPot` 音效
- **获得金币**：播放 `handleCoins` 音效

#### c. 图鉴系统 (`src/ui/BestiaryUI.js`)
- **打开图鉴**：播放 `bookOpen` 音效
- **切换怪物**：播放 `bookFlip` 音效

#### d. 玩家实体 (`src/entities.js`)
- **脚步声**：玩家移动时每 400ms 播放一次脚步声
- **随机变体**：从 3 个脚步声文件中随机选择

## 音量控制

### 设置界面

用户可以在游戏设置界面 (`Settings > Audio`) 中调整音量：
- **Audio Enabled**：总开关
- **SFX Volume**：音效音量 (0-100%)
- **BGM Volume**：背景音乐音量 (0-100%)

### 代码中访问设置

```javascript
const game = window.game;
if (game && game.settings) {
  const audioEnabled = game.settings.audioEnabled;  // true/false
  const sfxVolume = game.settings.sfxVolume;        // 0-100
}
```

## 音调变化说明

音调变化通过 HTML5 Audio API 的 `playbackRate` 属性实现：

- **pitchVar = 0**：无变化，原始音调
- **pitchVar = 0.05**：微小变化 (0.95 ~ 1.05)
- **pitchVar = 0.1**：适中变化 (0.9 ~ 1.1) - **推荐用于攻击音效**
- **pitchVar = 0.15**：较大变化 (0.85 ~ 1.15) - **推荐用于脚步声**
- **pitchVar = 0.2**：显著变化 (0.8 ~ 1.2) - **推荐用于暴击音效**

## 扩展音效

如果你想添加更多音效：

### 1. 添加音频文件
将 `.ogg` 文件放入 `assets/audio/kenney_rpg-audio/Audio/` 目录

### 2. 在 AudioManager 中注册
编辑 `src/audio/AudioManager.js`：

```javascript
this.audioFiles = {
  // ... 现有音效 ...
  newSound: 'assets/audio/kenney_rpg-audio/Audio/newSound.ogg',
};
```

### 3. 使用音效
```javascript
const audio = AudioManager.getInstance();
audio.play('newSound', { volume: 0.5, pitchVar: 0.1 });
```

## 注意事项

1. **浏览器自动播放限制**：部分浏览器可能阻止自动播放音频。用户需要先与页面交互（点击按钮等）才能播放音效。

2. **性能优化**：
   - 音效池大小默认为 5，可以根据需要在 `AudioManager` 构造函数中调整
   - 脚步声播放间隔默认为 400ms，可以在 `entities.js` 中调整

3. **文件格式**：当前使用 `.ogg` 格式。如果需要更好的兼容性，可以考虑提供 `.mp3` 备选。

4. **音量平衡**：不同音效的默认音量已根据实际效果调整：
   - 攻击音效：0.6
   - 暴击音效：0.9
   - 受击音效：0.5
   - 脚步声：0.3
   - 开门：0.7
   - 金币：0.5
   - 布料：0.4
   - 书本：0.5-0.6

## 测试清单

- [x] 开门音效
- [x] 拾取金币音效
- [x] 拾取装备音效
- [x] 打开背包音效
- [x] 打开商店音效
- [x] 攻击音效（普通）
- [x] 攻击音效（暴击）
- [x] 受击音效
- [x] 打开图鉴音效
- [x] 图鉴翻页音效
- [x] 玩家脚步声

## 故障排除

### 问题：音效不播放

**可能原因：**
1. 浏览器阻止自动播放 → 需要用户先与页面交互
2. 音量设置为 0 → 检查游戏设置中的音量
3. `audioEnabled` 设置为 false → 在设置中启用音频

### 问题：音效延迟

**可能原因：**
1. 音频文件未完全预加载 → 等待游戏完全加载后再播放
2. 音效池不足 → 增加 `poolSize` 值

### 问题：音调变化过于明显

**解决方案：**
减小 `pitchVar` 参数值，例如从 0.2 改为 0.1

---

## 总结

音效系统已完全集成到游戏中，支持以下功能：
- ✅ 音效池系统（防止音效截断）
- ✅ 音调随机变化（避免机械感）
- ✅ 音量控制（支持游戏设置）
- ✅ 预加载系统（确保首次播放流畅）
- ✅ 快捷方法（简化常用音效播放）

所有音效都已在关键游戏事件中触发，为玩家提供丰富的听觉反馈。

