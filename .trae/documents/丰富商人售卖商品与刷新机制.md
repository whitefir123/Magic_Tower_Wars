# 丰富商人商店系统实现计划

我将为您丰富游戏中的商人系统，增加随机装备、消耗品、强化符文材料的售卖，并添加刷新功能。

## 1. 核心功能设计

### A. 商品池扩展
除了原有的固定属性提升（攻击/防御/HP/钥匙）外，新增 **"限时货物"** 栏位，包含：
*   **随机装备**：基于当前楼层生成的武器、防具、饰品（不同品质、词缀）。
*   **消耗品**：药水、卷轴（经验/火焰/传送等）。
*   **特殊道具**：打孔钻头 (`Drill`)、宝石 (`Gem`)。
*   **强化材料**：虽然目前没有独立的强化材料，但可以售卖高品质的 "底材" 或特殊消耗品。

### B. 刷新机制
*   玩家可以花费金币刷新 **"限时货物"** 列表。
*   刷新价格随楼层提升，避免前期过度滥用。
*   每次进入新楼层时，商店会自动刷新一次（或者首次打开时生成）。

### C. 动态定价
*   装备价格基于 **物品等级 (Item Power)** 和 **稀有度** 计算。
*   消耗品有固定基础价格。
*   支持遗物（如贪婪戒指）的折扣效果。

## 2. 技术实现步骤

### 第一步：扩展战利品生成系统 (`src/systems/LootGenerationSystem.js`)
*   **新增 `generateShopLoot(floor)` 方法**：
    *   复用现有的 `generate` 方法生成装备。
    *   新增 `generateGem(floor)` 逻辑，从 `EQUIPMENT_DB` 中随机抽取适合当前进度的宝石。
    *   打包返回一个包含多种类型商品的数组。

### 第二步：重构商店界面 (`src/ui/ShopUI.js`)
*   **数据结构升级**：
    *   在 `constructor` 中添加 `this.goods = []` 存储当前随机商品。
    *   添加 `this.refreshCost` 计算逻辑。
*   **界面布局调整 (`getHTML`)**：
    *   保留顶部的 "基础服务"（买属性/钥匙）。
    *   在中部新增 "精选货物" (`Featured Goods`) 网格区域。
    *   在底部新增 "刷新货物" 按钮及价格显示。
*   **逻辑实现**：
    *   `initGoods(floor)`: 初始化商品列表。
    *   `renderGoods()`: 动态生成商品卡片（图标、名称、品质颜色、价格）。
    *   `buyGood(index)`: 处理购买逻辑（扣钱 -> `player.addToInventory` -> 移除商品 -> 播放音效）。
    *   `refreshGoods()`: 扣钱 -> 重新生成 -> 重新渲染。

### 第三步：定价与购买逻辑
*   **价格公式**：
    *   装备：`Floor * 50 * RarityMultiplier` (普通x1, 稀有x2, 史诗x5...)。
    *   消耗品：基础价 ~100-300 金币。
*   **库存检查**：
    *   购买装备前检查玩家背包是否已满 (`player.inventory`)。

## 3. 预期效果
*   打开商店时，除了原本的 +3攻击/+3防御 等选项，下方会出现一排随机商品。
*   可能会刷出 **"传说级 破败王者之刃"** 或者 **"史诗级 火焰卷轴"**。
*   如果不满意，可以点击 "刷新 (100G)" 来重置商品列表。
