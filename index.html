<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- 
    ========================================================================
    Content Security Policy (CSP) - å·²ä¸´æ—¶ç§»é™¤
    ========================================================================
    ä¸ºäº†ä¿®å¤ Supabase SDK åŠ è½½é—®é¢˜ï¼Œå·²æš‚æ—¶ç§»é™¤ CSP é™åˆ¶
    åç»­å¯ä»¥é‡æ–°é…ç½®æ›´å®½æ¾çš„ CSP ç­–ç•¥
    ========================================================================
  -->
  <title>é­”æ³•å¡” RPG - é»‘æš—å¹»æƒ³ UI</title>
  <!-- 
    ========================================================================
    å¥å£®å±å¹•ç¼©æ”¾ç³»ç»Ÿ (Robust Screen Scaling System)
    ========================================================================
    
    åŠŸèƒ½: ç¡®ä¿æ¸¸æˆ UI åœ¨ä»»ä½•å±å¹•å°ºå¯¸ä¸Šä¿æŒå®Œç¾çš„å®½é«˜æ¯”å’Œå¸ƒå±€
    
    è®¾è®¡åˆ†è¾¨ç‡ (Design Resolution): 1380x900px
    ç¼©æ”¾æ–¹æ³• (Scaling Method): Letterboxing (ä¿æŒå®½é«˜æ¯”ï¼Œä¸¤ä¾§/ä¸Šä¸‹ç•™é»‘è¾¹)
    
    æ ¸å¿ƒå®ç°:
    1. CSS (style.css):
       - body: width: 100vw; height: 100vh; (å…¨å±å®¹å™¨)
       - #main-ui: position: absolute; transform-origin: center center;
       - æ”¯æŒ transform: scale() åŠ¨æ€ç¼©æ”¾
    
    2. JavaScript (src/main.js):
       - setupScreenScaling(): åˆå§‹åŒ–ç¼©æ”¾ç³»ç»Ÿ
       - handleResize(): è®¡ç®—æœ€ä¼˜ç¼©æ”¾å› å­å¹¶åº”ç”¨
       - å…¬å¼: scale = Math.min(windowWidth/1380, windowHeight/900)
       - äº‹ä»¶: window.onresize è‡ªåŠ¨è°ƒæ•´
    
    3. èµ„æºä¼˜åŒ– (Asset Quality):
       - canvas: image-rendering: pixelated; (é˜²æ­¢æ¨¡ç³Š)
       - æ‰€æœ‰ç²¾çµå›¾: image-rendering: pixelated;
    
    æµ‹è¯•åœºæ™¯:
    - ç¬”è®°æœ¬ (1920x1080): scale â‰ˆ 1.2
    - å¤§æ˜¾ç¤ºå™¨ (3840x2160): scale â‰ˆ 2.4
    - å°å±å¹• (1024x768): scale â‰ˆ 0.73
    
    ======================================================================== 
  -->
  <!-- å…³é”®èµ„æºï¼šæ ¸å¿ƒæ ·å¼è¡¨ï¼ˆåŒæ­¥åŠ è½½ï¼‰ -->
  <link rel="stylesheet" href="./src/css/main.css" />
  <link rel="stylesheet" href="./mobile-adapt.css" />
  
  <!-- éå…³é”®èµ„æºï¼šGoogle Fontsï¼ˆå¼‚æ­¥åŠ è½½ï¼‰ -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Spectral:wght@400;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Spectral:wght@400;700&display=swap" /></noscript>
  
  <!-- ç½‘ç«™å›¾æ ‡ -->
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAusB9Y8qjTQAAAAASUVORK5CYII=" />
</head>
<body>
  <!-- GLOBAL LOADING OVERLAY - Must be first child of body for proper z-index stacking -->
  <div id="loading-overlay">
    <div class="loader"></div>
    <div class="loading-bar-container">
      <div id="loading-bar-fill" style="width: 0%"></div>
    </div>
    <div id="loading-percent">0%</div>
    <div class="loading-tips-container">
      <span class="tip-label">æç¤º:</span>
      <span id="loading-tip-text">åŠ è½½ä¸­...</span>
    </div>
    <div class="loading-chase-container">
      <div id="loading-skeleton"></div>
      <div id="loading-butterfly"></div>
    </div>
  </div>

  <!-- CHARACTER SELECT LOADING OVERLAY -->
  <div id="char-select-loading-overlay" class="loading-overlay-screen hidden">
    <div class="loader"></div>
    <div class="loading-bar-container">
      <div class="loading-bar-fill" style="width: 0%"></div>
    </div>
    <div class="loading-percent">0%</div>
    <div class="loading-tips-container">
      <span class="tip-label">æç¤º:</span>
      <span class="loading-tip-text">åŠ è½½è‹±é›„é€‰æ‹©ç•Œé¢...</span>
    </div>
    <div class="loading-chase-container">
      <div class="loading-skeleton"></div>
      <div class="loading-butterfly"></div>
    </div>
  </div>

  <!-- GAMEPLAY LOADING OVERLAY -->
  <div id="gameplay-loading-overlay" class="loading-overlay-screen hidden">
    <div class="loader"></div>
    <div class="loading-bar-container">
      <div class="loading-bar-fill" style="width: 0%"></div>
    </div>
    <div class="loading-percent">0%</div>
    <div class="loading-tips-container">
      <span class="tip-label">æç¤º:</span>
      <span class="loading-tip-text">åŠ è½½æ¸¸æˆç•Œé¢...</span>
    </div>
    <div class="loading-chase-container">
      <div class="loading-skeleton"></div>
      <div class="loading-butterfly"></div>
    </div>
  </div>

  <!-- Character Selection Screen - Risk of Rain 2 HUD Style -->
  <div id="char-select-screen" class="hidden scene-transition">
    <div class="ror-bg"></div>
    
    <!-- Center Preview Sprite (Clean, no overlay text) -->
    <div class="ror-center-preview">
      <div id="ror-preview-sprite" class="ror-preview-sprite"></div>
    </div>

    <!-- Top-Left: Character Strip -->
    <div class="ror-char-strip">
      <!-- Characters will be generated here by JavaScript -->
    </div>

    <!-- Bottom-Left: Character Details Card -->
    <div class="ror-char-details">
      <!-- Return Button -->
      <button id="btn-return-to-menu" class="btn-return-to-menu" onclick="window.game?.returnToMainMenu()" title="è¿”å›ä¸»èœå•">
        <img src="https://i.postimg.cc/HWKMcMBL/anniu3.png" alt="è¿”å›" />
        <span class="btn-return-text">è¿”å›</span>
      </button>
      
      <h2 id="ror-char-name" class="ror-detail-name">é€‰æ‹©è§’è‰²</h2>
      <div class="ror-stats-row">
        <span id="ror-hp" class="ror-stat-item">HP: 100</span>
        <span id="ror-speed" class="ror-stat-item">æ”»å‡»: 10</span>
      </div>
      
      <!-- Skills Grid: 3 skill icons + descriptions -->
      <div class="ror-skills-grid">
        <div class="ror-skill-item">
          <div class="skill-icon" id="skill-icon-0"></div>
          <div class="skill-text-wrapper">
            <div class="skill-label" id="skill-label-0">è¢«åŠ¨</div>
            <div class="skill-desc" id="skill-desc-0">...</div>
          </div>
        </div>
        <div class="ror-skill-item">
          <div class="skill-icon" id="skill-icon-1"></div>
          <div class="skill-text-wrapper">
            <div class="skill-label" id="skill-label-1">ä¸»åŠ¨</div>
            <div class="skill-desc" id="skill-desc-1">...</div>
          </div>
        </div>
        <div class="ror-skill-item">
          <div class="skill-icon" id="skill-icon-2"></div>
          <div class="skill-text-wrapper">
            <div class="skill-label" id="skill-label-2">å¿…æ€æŠ€</div>
            <div class="skill-desc" id="skill-desc-2">...</div>
          </div>
        </div>
      </div>
      
      <div id="ror-lore" class="ror-lore">ç‚¹å‡»å·¦ä¸Šè§’çš„è§’è‰²å›¾æ ‡å¼€å§‹å†’é™©...</div>
    </div>

    <!-- Right Panel: Run Configuration -->
    <div class="ror-run-config ror-run-config-bg">
      <img class="ror-panel-bg" src="https://i.postimg.cc/fTv3sWB2/chooseheropanel1.png" alt="panel-bg" />
      
      <!-- Daily Challenge Info Container -->
      <div class="daily-run-info hidden">
        <h3 class="ror-config-header" id="daily-date-header">æ¯æ—¥æŒ‘æˆ˜</h3>
        
        <div class="daily-section">
          <div class="daily-row" id="daily-modifiers-container">
          </div>
          <div class="daily-row" id="daily-relic-container">
          </div>
        </div>

        <div class="daily-leaderboard-section">
          <h3 class="ror-config-header">ğŸ† ä»Šæ—¥æ¦œé¦–</h3>
          <div class="daily-top3-list" id="daily-top3-list">
            <div class="loading-text">åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>
      
      <h3 class="ror-config-header" id="ascension-level-header">å™©æ¢¦å±‚çº§</h3>
      <div class="ror-diff-selector">
        <button class="ror-btn-arrow" onclick="game.changeAscensionLevel(-1)">â—€</button>
        <div class="ror-diff-display" id="ror-diff-display" title="">
          <span id="ror-diff-name">1</span>
          <div class="ror-diff-desc" id="ror-diff-desc" style="font-size: 0.7em; color: #aaa; margin-top: 4px;">æ ‡å‡†æˆé•¿</div>
          <div class="ror-diff-tooltip" id="ror-diff-tooltip" style="display: none; position: absolute; background: rgba(0,0,0,0.9); color: #fff; padding: 8px; border-radius: 4px; z-index: 1000; font-size: 0.85em; max-width: 200px; pointer-events: none;"></div>
        </div>
        <button class="ror-btn-arrow" onclick="game.changeAscensionLevel(1)">â–¶</button>
      </div>

      <div class="ror-config-section">
        <h3 class="ror-config-header">è®¾ç½®</h3>
        <label class="ror-toggle">
          <input type="checkbox" id="chk-fog" checked title="å¯ç”¨æˆ˜äº‰è¿·é›¾"> å¯ç”¨æˆ˜äº‰è¿·é›¾
        </label>
        <label class="ror-toggle">
          <input type="checkbox" id="chk-lighting" checked title="å¯ç”¨åŠ¨æ€å…‰ç…§"> å¯ç”¨åŠ¨æ€å…‰ç…§
        </label>
      </div>

      <div class="ror-ready-section">
        <button class="ror-btn-ready" onclick="game.startGameWithRedirect()">
          <img class="ready-img" src="https://i.postimg.cc/P551FVmq/anniu2.png" alt="Start" />
        </button>
      </div>
    </div>
  </div>

  <!-- Main Menu Overlay -->
  <div id="main-menu" class="main-menu-overlay scene-transition scene-active">
    <div class="menu-bg"></div>
    <div class="menu-content">
      <!-- Left Sidebar -->
      <div class="menu-sidebar">
        <!-- Main Group (Primary Level) -->
        <div id="menu-group-main" class="menu-group active">
          <div class="menu-buttons">
            <button id="btn-start-game" class="btn-menu btn-start">
              <span>å¼€å§‹æ¸¸æˆ</span>
              <div id="menu-mascot" class="menu-mascot"></div>
            </button>
            <button id="btn-continue" class="btn-menu btn-continue disabled">ç»§ç»­æ¸¸æˆ</button>
            <button id="btn-daily-challenge" class="btn-menu btn-daily-challenge">ğŸ“… æ¯æ—¥æŒ‘æˆ˜</button>
            <button id="btn-talents" class="btn-menu btn-talents">å¤©èµ‹æ˜Ÿå›¾</button>
            <button id="btn-leaderboard" class="btn-menu btn-leaderboard">æ’è¡Œæ¦œ</button>
            <button id="btn-settings" class="btn-menu btn-settings">è®¾ç½®</button>
            <button id="btn-more" class="btn-menu btn-more">æ›´å¤š &gt;</button>
          </div>
        </div>
        
        <!-- Extras Group (Secondary Level) -->
        <div id="menu-group-extras" class="menu-group hidden">
          <div class="menu-buttons">
            <button id="btn-back" class="btn-menu btn-back">&lt; è¿”å›</button>
            <button id="btn-achievements" class="btn-menu btn-achievements">æˆå°±</button>
            <button id="btn-bestiary" class="btn-menu btn-bestiary">æ€ªç‰©å›¾é‰´</button>
          </div>
        </div>
      </div>
      
      <!-- Right Art Display -->
      <div class="menu-art-display"></div>
    </div>
  </div>

  <!-- Bestiary Overlay - Monster Encyclopedia
  
       ========================================================================
       å›¾é‰´ç•Œé¢ - æ ·å¼ç»“æ„åˆ†ç¦»è¯´æ˜
       ========================================================================
       
       æ ¸å¿ƒè®¾è®¡: å·¦ä¾§åˆ—è¡¨é¢æ¿å’Œå³ä¾§è¯¦æƒ…é¢æ¿çš„æ ·å¼å®Œå…¨ç‹¬ç«‹
       
       å·¦ä¾§é¢æ¿ (.bestiary-list-panel):
       - ç®¡ç†æ€ªç‰©åˆ—è¡¨æŒ‰é’®çš„æ˜¾ç¤ºå’Œå¸ƒå±€
       - å¯ç‹¬ç«‹è°ƒæ•´: å®½åº¦ã€paddingã€marginã€gapã€èƒŒæ™¯ã€æ»šåŠ¨æ¡ç­‰
       - ä¿®æ”¹å·¦ä¾§æ ·å¼ âœ“ ä¸ä¼šå½±å“å³ä¾§
       
       å³ä¾§é¢æ¿ (.bestiary-detail-panel):
       - ç®¡ç†æ€ªç‰©å±æ€§ã€ä¿¡æ¯ã€èƒŒæ™¯æ•…äº‹çš„æ˜¾ç¤º
       - å¯ç‹¬ç«‹è°ƒæ•´: å®½åº¦ã€paddingã€marginã€gapã€èƒŒæ™¯ã€æ»šåŠ¨æ¡ç­‰
       - ä¿®æ”¹å³ä¾§æ ·å¼ âœ“ ä¸ä¼šå½±å“å·¦ä¾§
       
       è¯¦ç»†çš„æ ·å¼è°ƒæ•´è¯´æ˜è¯·æŸ¥çœ‹ style.css ä¸­çš„æ³¨é‡Š
       
       ======================================================================== -->
  <div id="bestiary-overlay" class="bestiary-overlay hidden">
    <div class="bestiary-modal">
      <!-- Header -->
      <div class="bestiary-header">
        <h2 class="bestiary-title">æ€ªç‰©å›¾é‰´</h2>
        <button class="bestiary-close-btn" onclick="window.game?.closeBestiary()" aria-label="å…³é—­"></button>
      </div>

      <!-- Main Content -->
      <div class="bestiary-content">
        <!-- Left Panel - Monster List (ç‹¬ç«‹æ ·å¼ç»“æ„) -->
        <div class="bestiary-list-panel">
          <div class="bestiary-list" id="bestiary-list">
            <!-- Monster list items will be generated here -->
          </div>
        </div>

        <!-- Right Panel - Monster Details (ç‹¬ç«‹æ ·å¼ç»“æ„) -->
        <div class="bestiary-detail-panel">
          <!-- Monster Stats Grid -->
          <div class="bestiary-stats-grid">
            <div class="stat-grid-item">
              <span class="stat-grid-label">ç”Ÿå‘½å€¼</span>
              <span class="stat-grid-value" id="bestiary-hp">-</span>
            </div>
            <div class="stat-grid-item">
              <span class="stat-grid-label">ç‰©æ”»</span>
              <span class="stat-grid-value" id="bestiary-patk">-</span>
            </div>
            <div class="stat-grid-item">
              <span class="stat-grid-label">é­”æ”»</span>
              <span class="stat-grid-value" id="bestiary-matk">-</span>
            </div>
            <div class="stat-grid-item">
              <span class="stat-grid-label">ç‰©é˜²</span>
              <span class="stat-grid-value" id="bestiary-pdef">-</span>
            </div>
            <div class="stat-grid-item">
              <span class="stat-grid-label">é­”é˜²</span>
              <span class="stat-grid-value" id="bestiary-mdef">-</span>
            </div>
            <div class="stat-grid-item">
              <span class="stat-grid-label">ç»éªŒ</span>
              <span class="stat-grid-value" id="bestiary-xp">-</span>
            </div>
            <div class="stat-grid-item">
              <span class="stat-grid-label">é‡‘å¸</span>
              <span class="stat-grid-value" id="bestiary-gold">-</span>
            </div>
            <div class="stat-grid-item">
              <span class="stat-grid-label">æ€’æ°”</span>
              <span class="stat-grid-value" id="bestiary-rage">-</span>
            </div>
          </div>

          <!-- Monster Info -->
          <div class="bestiary-info-section">
            <div class="info-row">
              <span class="info-label">èº«é«˜:</span>
              <span class="info-value" id="bestiary-height">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">ä½“é‡:</span>
              <span class="info-value" id="bestiary-weight">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">é€Ÿåº¦:</span>
              <span class="info-value" id="bestiary-speed">-</span>
            </div>
          </div>

          <!-- Monster Traits -->
          <div class="bestiary-traits-section" id="bestiary-traits-section">
            <!-- Traits will be rendered here -->
          </div>

          <!-- Monster Lore -->
          <div class="bestiary-lore-section">
            <h3 class="lore-title">èƒŒæ™¯æ•…äº‹</h3>
            <div class="lore-text" id="bestiary-lore">
              é€‰æ‹©ä¸€ä¸ªæ€ªç‰©æ¥æŸ¥çœ‹å…¶èƒŒæ™¯æ•…äº‹...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Panel Overlay -->
  <div id="settings-overlay" class="settings-overlay hidden">
    <!-- Left Sidebar - Category List -->
    <div class="settings-sidebar">
      <div class="settings-category active" data-category="audio">
        <span class="category-name">éŸ³é¢‘</span>
      </div>
      <div class="settings-category" data-category="graphics">
        <span class="category-name">ç”»è´¨</span>
      </div>
      <div class="settings-category" data-category="gameplay">
        <span class="category-name">æ¸¸æˆ</span>
      </div>
      <div class="settings-category" data-category="display">
        <span class="category-name">æ˜¾ç¤º</span>
      </div>
      <div class="settings-category" data-category="about">
        <span class="category-name">å…³äº</span>
      </div>
    </div>
    <div class="settings-modal">
      <!-- Settings Header -->
      <div class="settings-header">
        <h2 class="settings-title">è®¾ç½®</h2>
        <button class="settings-close-btn" onclick="window.game?.closeSettings()" aria-label="å…³é—­"></button>
      </div>

      <!-- Settings Content -->
      <div class="settings-content">
        <!-- Right Panel - Settings Options -->
        <div class="settings-panel">
          <!-- Audio Settings -->
          <div class="settings-section active" data-section="audio">
            <h3 class="section-title">éŸ³é¢‘è®¾ç½®</h3>
            
            <div class="settings-item">
              <div class="item-label">
                <span class="label-text">èƒŒæ™¯éŸ³ä¹éŸ³é‡</span>
                <span class="label-value" id="bgm-value">100%</span>
              </div>
              <div class="slider-container">
                <input type="range" id="bgm-volume" class="settings-slider" min="0" max="100" value="100" title="èƒŒæ™¯éŸ³ä¹éŸ³é‡" />
              </div>
            </div>

            <div class="settings-item">
              <div class="item-label">
                <span class="label-text">éŸ³æ•ˆéŸ³é‡</span>
                <span class="label-value" id="sfx-value">100%</span>
              </div>
              <div class="slider-container">
                <input type="range" id="sfx-volume" class="settings-slider" min="0" max="100" value="100" title="éŸ³æ•ˆéŸ³é‡" />
              </div>
            </div>

            <div class="settings-item">
              <div class="item-label">
                <span class="label-text">UIéŸ³æ•ˆ</span>
                <span class="label-value" id="ui-sfx-value">100%</span>
              </div>
              <div class="slider-container">
                <input type="range" id="ui-sfx-volume" class="settings-slider" min="0" max="100" value="100" title="UIéŸ³æ•ˆéŸ³é‡" />
              </div>
            </div>

            <div class="settings-item checkbox-item">
              <label class="checkbox-label">
                <input type="checkbox" id="audio-enabled" class="settings-checkbox" checked title="å¯ç”¨éŸ³é¢‘" />
                <span class="checkbox-text">å¯ç”¨éŸ³é¢‘</span>
              </label>
            </div>
          </div>

          <!-- Graphics Settings -->
          <div class="settings-section" data-section="graphics">
            <h3 class="section-title">ç”»è´¨è®¾ç½®</h3>
            
            <div class="settings-item">
              <div class="item-label">
                <span class="label-text">ç”»è´¨é¢„è®¾</span>
              </div>
              <div class="button-group">
                <button class="quality-btn active" data-quality="low">ä½</button>
                <button class="quality-btn" data-quality="medium">ä¸­</button>
                <button class="quality-btn" data-quality="high">é«˜</button>
              </div>
            </div>

            <div class="settings-item checkbox-item">
              <label class="checkbox-label">
                <input type="checkbox" id="particle-effects" class="settings-checkbox" checked title="ç²’å­æ•ˆæœ" />
                <span class="checkbox-text">ç²’å­æ•ˆæœ</span>
              </label>
            </div>

            <div class="settings-item checkbox-item">
              <label class="checkbox-label">
                <input type="checkbox" id="screen-shake" class="settings-checkbox" checked title="å±å¹•éœ‡åŠ¨" />
                <span class="checkbox-text">å±å¹•éœ‡åŠ¨</span>
              </label>
            </div>

            <div class="settings-item checkbox-item">
              <label class="checkbox-label">
                <input type="checkbox" id="bloom-effect" class="settings-checkbox" checked title="å…‰æ™•æ•ˆæœ" />
                <span class="checkbox-text">å…‰æ™•æ•ˆæœ</span>
              </label>
            </div>
          </div>

          <!-- Gameplay Settings -->
          <div class="settings-section" data-section="gameplay">
            <h3 class="section-title">æ¸¸æˆè®¾ç½®</h3>
            
            <div class="settings-item checkbox-item">
              <label class="checkbox-label">
                <input type="checkbox" id="auto-save" class="settings-checkbox" checked title="è‡ªåŠ¨ä¿å­˜" />
                <span class="checkbox-text">è‡ªåŠ¨ä¿å­˜</span>
              </label>
            </div>

            <div class="settings-item checkbox-item">
              <label class="checkbox-label">
                <input type="checkbox" id="difficulty-scaling" class="settings-checkbox" checked title="éš¾åº¦åŠ¨æ€è°ƒæ•´" />
                <span class="checkbox-text">éš¾åº¦åŠ¨æ€è°ƒæ•´</span>
              </label>
            </div>

            <div class="settings-item checkbox-item">
              <label class="checkbox-label">
                <input type="checkbox" id="show-damage-numbers" class="settings-checkbox" checked title="æ˜¾ç¤ºä¼¤å®³æ•°å­—" />
                <span class="checkbox-text">æ˜¾ç¤ºä¼¤å®³æ•°å­—</span>
              </label>
            </div>
          </div>

          <!-- Display Settings -->
          <div class="settings-section" data-section="display">
            <h3 class="section-title">æ˜¾ç¤ºè®¾ç½®</h3>
            
            <div class="settings-item">
              <div class="item-label">
                <span class="label-text">äº®åº¦</span>
                <span class="label-value" id="brightness-value">100%</span>
              </div>
              <div class="slider-container">
                <input type="range" id="brightness" class="settings-slider" min="50" max="150" value="100" title="äº®åº¦" />
              </div>
            </div>

            <div class="settings-item">
              <div class="item-label">
                <span class="label-text">å¯¹æ¯”åº¦</span>
                <span class="label-value" id="contrast-value">100%</span>
              </div>
              <div class="slider-container">
                <input type="range" id="contrast" class="settings-slider" min="50" max="150" value="100" title="å¯¹æ¯”åº¦" />
              </div>
            </div>

            <div class="settings-item checkbox-item">
              <label class="checkbox-label">
                <input type="checkbox" id="show-fps" class="settings-checkbox" title="æ˜¾ç¤ºFPS" />
                <span class="checkbox-text">æ˜¾ç¤ºFPS</span>
              </label>
            </div>

            <div class="settings-item checkbox-item">
              <label class="checkbox-label">
                <input type="checkbox" id="fullscreen-mode" class="settings-checkbox" title="å…¨å±æ¨¡å¼" />
                <span class="checkbox-text">å…¨å±æ¨¡å¼</span>
              </label>
            </div>
          </div>

          <!-- About Section -->
          <div class="settings-section" data-section="about">
            <h3 class="section-title">å…³äºæ¸¸æˆ</h3>
            
            <div class="about-content">
              <div class="about-item">
                <span class="about-label">æ¸¸æˆåç§°:</span>
                <span class="about-value">é­”å¡”æˆ˜è®° RPG</span>
              </div>
              <div class="about-item">
                <span class="about-label">ç‰ˆæœ¬:</span>
                <span class="about-value">1.0.0</span>
              </div>
              <div class="about-item">
                <span class="about-label">å¼€å‘è€…:</span>
                <span class="about-value">Game Studio</span>
              </div>
              <div class="about-item">
                <span class="about-label">å¼•æ“:</span>
                <span class="about-value">Canvas 2D</span>
              </div>
              <div class="about-description">
                <p>è¿™æ˜¯ä¸€æ¬¾é»‘æš—å¹»æƒ³é£æ ¼çš„RPGæ¸¸æˆï¼Œèåˆäº†Roguelikeå…ƒç´ å’Œå¡”é˜²æœºåˆ¶ã€‚</p>
                <p>æ¢ç´¢ç¥ç§˜çš„é­”æ³•å¡”ï¼Œå‡»è´¥å„ç§æ€ªç‰©ï¼Œæ”¶é›†å¼ºå¤§çš„è£…å¤‡å’ŒæŠ€èƒ½ã€‚</p>
              </div>
              
              <!-- å¼€å‘è€…æ¨¡å¼å…¥å£ -->
              <div class="settings-item" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255, 215, 0, 0.2);">
                <div class="item-label">
                  <span class="label-text">å¼€å‘è€…æ¨¡å¼</span>
                </div>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                  <input 
                    type="password" 
                    id="dev-code-input" 
                    placeholder="è¾“å…¥å¼€å‘è€…å¯†ç "
                    style="flex: 1; padding: 8px 12px; background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 4px; color: #fff; font-family: var(--font-body);"
                  />
                  <button 
                    id="dev-code-submit" 
                    class="dev-code-submit-btn"
                    style="padding: 8px 20px; background: rgba(255, 215, 0, 0.2); border: 1px solid #ffd700; border-radius: 4px; color: #ffd700; cursor: pointer; font-family: var(--font-body); transition: all 0.2s ease;"
                    onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'; this.style.transform='translateY(-1px)';"
                    onmouseout="this.style.background='rgba(255, 215, 0, 0.2)'; this.style.transform='translateY(0)';"
                  >
                    ç¡®è®¤
                  </button>
                </div>
                <div id="dev-mode-status" style="margin-top: 8px; font-size: 0.85rem; color: #8c8273; display: none;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Footer -->
      <div class="settings-footer">
        <button class="btn-core btn-system" onclick="window.game?.resetSettings()">æ¢å¤é»˜è®¤</button>
        <button class="btn-core btn-system" onclick="window.game?.closeSettings()">å…³é—­</button>
      </div>
    </div>
  </div>

  <div id="main-ui" class="scene-fade-in">
    <div id="left-column">
      <div id="relic-bar">
        <div class="relic-slot"></div><div class="relic-slot"></div><div class="relic-slot"></div>
        <div class="relic-slot"></div><div class="relic-slot"></div><div class="relic-slot"></div>
      </div>
      <div id="canvas-wrapper">
        <canvas id="gameCanvas" width="1200" height="800"></canvas>
        <div id="skill-bar">
          <!-- Skill slots will be generated here by JavaScript -->
        </div>
        <div id="level-splash" class="level-splash">ç¬¬ 2 å±‚</div>

        <div id="system-log-container">
          <div id="log-panel"><div class="log-entry log-entry-init">&gt; ç³»ç»Ÿå·²åˆå§‹åŒ–...</div></div>
        </div>
      </div>
    </div>
    <div id="right-sidebar">
      <div class="hp-section">
        <div class="hp-container">
          <div class="hp-bar-inner"><div class="hp-fill hp-fill-full" id="hp-visual-fill"></div></div>
          <div class="hp-text-overlay"><span id="ui-hp">100</span> / <span id="ui-hp-max">100</span></div>
        </div>
        <div class="level-header">Level <span id="ui-lvl">1</span></div>
        <div class="xp-section">
          <div class="xp-bar-bg"><div id="xp-fill"></div></div>
          <div class="xp-text">ç»éªŒ <b><span id="ui-xp">0</span></b> / <b><span id="ui-xp-max">50</span></b></div>
        </div>
        <div class="rage-section">
          <div class="rage-bar-bg"><div id="rage-fill"></div></div>
          <div class="rage-text">æ€’æ°” <span id="rage-text">0%</span></div>
        </div>
      </div>
      <div class="panel-header">è§’è‰²å±æ€§</div>
      <div class="panel-container stats-panel">
        <div class="stats-content">
          <div class="stat-row"><span class="stat-name">ç‰©æ”»</span><span class="stat-val" id="ui-patk">15</span></div>
          <div class="stat-row"><span class="stat-name">é­”æ”»</span><span class="stat-val" id="ui-matk">0</span></div>
          <div class="stat-row"><span class="stat-name">ç‰©é˜²</span><span class="stat-val" id="ui-pdef">5</span></div>
          <div class="stat-row"><span class="stat-name">é­”é˜²</span><span class="stat-val" id="ui-mdef">0</span></div>
          <div class="stat-row"><span class="stat-name">æš´å‡»ç‡</span><span class="stat-val" id="ui-crit">20%</span></div>
          <div class="stat-row"><span class="stat-name">é‡‘å¸</span><span class="stat-val stat-gold" id="ui-gold">0</span></div>
          <div class="stat-row"><span class="stat-name">é’¥åŒ™</span><span class="stat-val" id="ui-keys">1</span></div>
          <div class="stat-row">
            <span class="stat-name">çµé­‚æ°´æ™¶</span>
            <span class="stat-val" id="ui-soul-crystals">0</span>
          </div>
        </div>
      </div>
      <div class="panel-header">è£…å¤‡æ </div>
      <div class="panel-container equip-panel">
        <div class="equip-content">
          <div class="equip-socket" data-slot="HELM" title="Helm"></div><div class="equip-socket" data-slot="WEAPON" title="Weapon"></div><div class="equip-socket" data-slot="ARMOR" title="Armor"></div>
          <div class="equip-socket" data-slot="BOOTS" title="Boots"></div><div class="equip-socket" data-slot="RING" title="Ring"></div><div class="equip-socket" data-slot="AMULET" title="Amulet"></div>
        </div>
      </div>
      <div class="btn-actions">
        <button id="btn-ultimate" class="btn-core btn-sidebar" disabled onclick="game.activateUltimate()">å¿…æ€æŠ€</button>
        <button class="btn-core btn-sidebar" onclick="window.game.saveGame()">ä¿å­˜</button>
        <button class="btn-core btn-sidebar" onclick="window.game.loadGame()">è¯»å–</button>
        <button class="btn-core btn-sidebar" onclick="window.game.endGame(false)">é€€å‡º / é‡ç½®</button>
      </div>
      <div id="debug-content"></div>
    </div>
    <!-- æ¸¸æˆå›¾æ ‡å®¹å™¨ - ä½äºåœ°å›¾å’Œå³ä¾§é¢æ¿ä¹‹é—´ -->
    <div id="game-icons-container">
      <img id="backpack-icon" src="https://i.postimg.cc/kgCXFC1B/beibaotubiao1.png" alt="èƒŒåŒ…" class="backpack-icon" />
    </div>
  </div>

  <!-- ç¬¦æ–‡å¼ºåŒ–ç•Œé¢ - å¿…é¡»åœ¨ #main-ui ä¹‹å¤–ä»¥ç¡®ä¿å…¨å±è¦†ç›– -->
  <div id="draft-overlay" class="modal-overlay hidden">
    <h2 id="draft-title" class="modal-title">å‡çº§</h2>
    <div class="card-container" id="draft-cards"></div>
    <div class="draft-actions" style="margin-top: 30px; display: flex; gap: 20px; justify-content: center;">
      <button id="draft-reroll-btn" class="btn-core" onclick="if(window.game && window.game.roguelike) window.game.roguelike.reroll()">åˆ·æ–° (50G)</button>
      <button id="draft-recycle-btn" class="btn-core" onclick="if(window.game && window.game.roguelike) window.game.roguelike.recycle()">æ”¾å¼ƒ (è·å¾—20G)</button>
    </div>
  </div>
  <div id="shrine-overlay" class="modal-overlay hidden">
    <h2 id="shrine-title" class="modal-title">åœ£æ®¿</h2>
    <div class="card-container" id="shrine-cards"></div>
  </div>

  <!-- èƒŒåŒ…å’Œå•†åº—ç•Œé¢ - å¿…é¡»åœ¨ #main-ui ä¹‹å¤–ä»¥ç¡®ä¿å…¨å±è¦†ç›– -->
  <div id="inventory-overlay" class="modal-overlay hidden">
    <h2 class="modal-title-small">èƒŒåŒ…</h2>
    <div class="inventory-wrap">
      <div class="inventory-titles">
        <div class="inv-equip-title">è£…å¤‡æ </div>
        <div class="inv-list-title">èƒŒåŒ…ç‰©å“ï¼ˆå®¹é‡ 20ï¼‰</div>
      </div>
      <div class="inventory-layout">
        <div class="inventory-left">
          <div class="inv-equip-grid">
            <div class="equip-socket inv-equip" data-slot="HELM"></div>
            <div class="equip-socket inv-equip" data-slot="WEAPON"></div>
            <div class="equip-socket inv-equip" data-slot="ARMOR"></div>
            <div class="equip-socket inv-equip" data-slot="BOOTS"></div>
            <div class="equip-socket inv-equip" data-slot="RING"></div>
            <div class="equip-socket inv-equip" data-slot="AMULET"></div>
          </div>
        </div>
        <div class="inventory-right">
          <div class="inv-grid">
            <div class="inv-slot" data-index="0"></div><div class="inv-slot" data-index="1"></div><div class="inv-slot" data-index="2"></div><div class="inv-slot" data-index="3"></div><div class="inv-slot" data-index="4"></div>
            <div class="inv-slot" data-index="5"></div><div class="inv-slot" data-index="6"></div><div class="inv-slot" data-index="7"></div><div class="inv-slot" data-index="8"></div><div class="inv-slot" data-index="9"></div>
            <div class="inv-slot" data-index="10"></div><div class="inv-slot" data-index="11"></div><div class="inv-slot" data-index="12"></div><div class="inv-slot" data-index="13"></div><div class="inv-slot" data-index="14"></div>
            <div class="inv-slot" data-index="15"></div><div class="inv-slot" data-index="16"></div><div class="inv-slot" data-index="17"></div><div class="inv-slot" data-index="18"></div><div class="inv-slot" data-index="19"></div>
          </div>
        </div>
      </div>
    </div>
    <button class="btn-core btn-modal-close" onclick="window.game.closeInventory()">å…³é—­èƒŒåŒ…</button>
  </div>

  <!-- å•†åº—ç•Œé¢ -->
  <div id="shop-overlay" class="modal-overlay hidden">
    <h2 class="modal-title-shop">åœ°ç²¾å•†åº—</h2>
    <div class="flex-center">
      <button class="btn-core btn-transaction" onclick="game.buy('atk')">è´­ä¹° æ”»å‡» +3<br/>ä»·æ ¼: <span id="price-atk">200</span> é‡‘å¸</button>
      <button class="btn-core btn-transaction" onclick="game.buy('def')">è´­ä¹° é˜²å¾¡ +3<br/>ä»·æ ¼: <span id="price-def">200</span> é‡‘å¸</button>
      <button class="btn-core btn-transaction" onclick="game.buy('hp')">è´­ä¹° æ²»ç–— +200HP<br/>ä»·æ ¼: <span id="price-hp">100</span> é‡‘å¸</button>
      <button class="btn-core btn-transaction" onclick="game.buy('key')">è´­ä¹° é’¥åŒ™ +1<br/>ä»·æ ¼: <span id="price-key">500</span> é‡‘å¸</button>
    </div>
    <button class="btn-core btn-modal-close" style="margin-top:25px;" onclick="game.closeShop()">å…³é—­å•†åº—</button>
  </div>

  <!-- èµŒå¾’ç•Œé¢ (The Gambler) -->
  <div id="gambler-overlay" class="modal-overlay hidden">
    <div class="gambler-panel">
      <h2 class="modal-title-shop" style="margin-bottom: 20px;">ğŸ° å‘½è¿çš„è€è™æœº ğŸ°</h2>
      
      <!-- èµŒå¾’æ¶ˆæ¯ -->
      <p id="gambler-message" style="font-size: 18px; color: #ffcc00; text-align: center; margin-bottom: 25px; font-style: italic;">
        æ‰‹æ°”ä¸é”™ï¼Œé™Œç”Ÿäººï¼Ÿè€è™æœºçŸ¥é“ä½ çš„å‘½è¿...
      </p>
      
      <!-- æ—‹è½¬åŠ¨ç”»åŒºåŸŸ -->
      <div id="gambler-spin-animation" class="hidden" style="font-size: 24px; color: #ff6600; text-align: center; margin: 20px 0; font-weight: bold; animation: pulse 0.5s infinite;">
        æ—‹è½¬ä¸­...
      </div>
      
      <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
      <div id="gambler-result" class="hidden" style="font-size: 22px; text-align: center; margin: 20px 0; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
        è·å¾—ï¼š[ç‰©å“åç§°]
      </div>
      
      <!-- æŒ‰é’®ç»„ -->
      <div class="flex-center" style="flex-direction: column; gap: 15px;">
        <button id="gambler-btn-standard" class="btn-core btn-transaction" data-shop-item="standard" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
          æ ‡å‡†æ—‹è½¬ (50 G)
        </button>
        <button id="gambler-btn-high-roller" class="btn-core btn-transaction" data-shop-item="high-roller" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
          è±ªèµŒæ—‹è½¬ (200 G)
        </button>
        <button id="gambler-btn-leave" class="btn-core btn-modal-close" style="margin-top: 15px;">
          ç¦»å¼€
        </button>
      </div>
    </div>
  </div>

  <!-- æ­»äº¡ç•Œé¢ - å¿…é¡»åœ¨ #main-ui ä¹‹å¤–ä»¥é¿å…å †å ä¸Šä¸‹æ–‡é—®é¢˜ -->
  <div id="leaderboard-overlay" class="modal-overlay hidden">
    <div id="game-over-content">
      <h2 id="go-title">ä½ å·²æ­»äº¡</h2>
      <div class="stats-grid">
        <div class="stat-item"><span>æ¸¸æˆæ—¶é—´:</span> <span id="go-time">00:00</span></div>
        <div class="stat-item"><span>åˆ°è¾¾å±‚æ•°:</span> <span id="go-floor">1</span></div>
        <div class="stat-item"><span>å‡»æ€æ€ªç‰©:</span> <span id="go-kills">0</span></div>
        <div class="stat-item"><span>æ€»ç»éªŒå€¼:</span> <span id="go-xp">0</span></div>
        <div class="stat-item"><span>æœ€ç»ˆé‡‘å¸:</span> <span id="go-gold">0</span></div>
      </div>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button id="btn-retry-game" class="btn-core btn-system btn-system-primary">é‡è¯•</button>
        <button class="btn-core btn-system" onclick="window.game?.fadeOutAndReload('index.html')">è¿”å›ä¸»èœå•</button>
      </div>
    </div>
  </div>

  <!-- æ˜µç§°æ³¨å†Œæ¨¡æ€æ¡† -->
  <div id="nickname-modal" class="modal-overlay hidden">
    <div class="modal-content nickname-modal-content">
      <div class="modal-body">
        <div class="form-group">
          <label for="nickname-input" style="margin-top: 89px;">æ˜µç§° (2-20 ä¸ªå­—ç¬¦)</label>
          <input 
            type="text" 
            id="nickname-input" 
            class="nickname-input" 
            placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜µç§°..." 
            maxlength="20"
            autocomplete="off"
          />
          <span id="nickname-error" class="error-message"></span>
        </div>
        <div class="modal-actions">
          <button id="btn-register-nickname" class="btn-core btn-system btn-system-primary">ç¡®è®¤</button>
          <button id="btn-skip-register" class="btn-core btn-system btn-system-secondary">è·³è¿‡ï¼ˆç¨åè®¾ç½®ï¼‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tooltip å’Œ Item Action Menu - å¿…é¡»åœ¨ #main-ui ä¹‹å¤–ä»¥é¿å… transform å¯¼è‡´çš„ fixed å®šä½é—®é¢˜ -->
  <div id="tooltip" class="hidden"></div>
  <div id="item-action-menu" class="hidden">
    <div class="action-menu-item" data-action="use">ä½¿ç”¨/è£…å¤‡</div>
    <div class="action-menu-item" data-action="discard">ä¸¢å¼ƒ</div>
    <div class="action-menu-item" data-action="cancel">å–æ¶ˆ</div>
  </div>

  <!-- Supabase SDKï¼ˆCDN UMD æ„å»ºç‰ˆæœ¬ï¼Œç”¨äºå…¨çƒæ’è¡Œæ¦œï¼‰ -->
  <script 
    src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"
    onerror="this.onerror=null;this.src='https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js'"
  ></script>
  
  <!-- æ ¸å¿ƒæ¸¸æˆè„šæœ¬ï¼ˆåŒæ­¥åŠ è½½ï¼‰ -->
  <script type="module" src="./src/main.js"></script>
  
  <!-- å·¥å…·ç±»è„šæœ¬ -->
  <script type="module" src="./src/utils/ResourceManager.js"></script>
  <script type="module" src="./src/utils/WallAssetRotator.js"></script>
  <script type="module" src="./src/utils/CanvasSprite.js"></script>
  <script type="module" src="./src/utils/PanelDrag.js"></script>
  

  <!-- èµ„æºåŠ è½½ç®¡ç†å™¨ï¼šä¼˜å…ˆåŠ è½½é¡µé¢èµ„æºï¼Œç„¶ååŠ è½½å…¶ä»–èµ„æº -->
  <script>
    /**
     * èµ„æºåŠ è½½ä¼˜å…ˆçº§ç®¡ç†å™¨ - å®Œå…¨é‡æ„ç‰ˆæœ¬ v2.0
     * åŠŸèƒ½: ç¡®ä¿å…³é”®èµ„æºï¼ˆé¡µé¢UIï¼‰ä¼˜å…ˆåŠ è½½ï¼Œç„¶ååŠ è½½å…¶ä»–èµ„æºï¼ˆå›¾ç‰‡ã€å­—ä½“ç­‰ï¼‰
     * æ ¸å¿ƒæ”¹è¿›:
     * 1. å‡†ç¡®è¿½è¸ªæ¯ä¸ªèµ„æºçš„åŠ è½½çŠ¶æ€ï¼ˆå¾…åŠ è½½ã€åŠ è½½ä¸­ã€å·²åŠ è½½ã€å¤±è´¥ï¼‰
     * 2. å®æ—¶è®¡ç®—åŠ è½½è¿›åº¦ç™¾åˆ†æ¯”ï¼Œä¸è¿›åº¦æ¡å®Œå…¨åŒæ­¥
     * 3. æ”¯æŒå¤šç•Œé¢èµ„æºåŠ è½½ç®¡ç†
     * 4. é˜²æ­¢é‡å¤åŠ è½½èµ„æº
     * 5. è¿›åº¦æ¡å¹³æ»‘å¢é•¿ï¼Œå‡†ç¡®åæ˜ å®é™…åŠ è½½çŠ¶æ€
     */
    window.ResourceManager = {
      // å…³é”®èµ„æºåˆ—è¡¨ï¼ˆé¡µé¢åŠ è½½æ—¶å¿…éœ€ï¼‰
      criticalResources: [
        // æ ·å¼è¡¨å·²åœ¨ head ä¸­åŒæ­¥åŠ è½½
        // æ ¸å¿ƒ JS å·²é€šè¿‡ <script type="module"> åŒæ­¥åŠ è½½
      ],

      // æ¬¡è¦èµ„æºåˆ—è¡¨ï¼ˆé¡µé¢åŠ è½½åå¼‚æ­¥åŠ è½½ï¼‰
      secondaryResources: [
        // æ¸¸æˆç›¸å…³çš„å¤–éƒ¨å›¾ç‰‡èµ„æº
        { type: 'image', url: 'https://i.postimg.cc/fTv3sWB2/chooseheropanel1.png', priority: 'high' },
        { type: 'image', url: 'https://i.postimg.cc/P551FVmq/anniu2.png', priority: 'high' },
        { type: 'image', url: 'https://i.postimg.cc/kgCXFC1B/beibaotubiao1.png', priority: 'high' },
        { type: 'image', url: 'https://i.postimg.cc/MGft6mWh/xiaokuloujiazai1.png', priority: 'medium' },
        { type: 'image', url: 'https://i.postimg.cc/DyjfRzTx/hudie1.png', priority: 'medium' },
      ],

      // èµ„æºåŠ è½½çŠ¶æ€è¿½è¸ªï¼š{ url: 'pending'|'loading'|'loaded'|'failed' }
      resourceStates: {},

      // å·²åŠ è½½çš„èµ„æºç¼“å­˜
      loadedResources: new Set(),
      failedResources: new Set(),
      loadingResources: new Set(),

      // åŠ è½½ç»Ÿè®¡
      totalResources: 0,
      loadedCount: 0,
      failedCount: 0,

      // åŠ è½½çŠ¶æ€è¿½è¸ª
      isLoading: false,
      loadingStartTime: 0,

      /**
       * åˆå§‹åŒ–èµ„æºåŠ è½½ç®¡ç†å™¨
       * åœ¨é¡µé¢åŠ è½½å®Œæˆåè°ƒç”¨
       */
      init: function() {
        console.log('ğŸ“¦ èµ„æºåŠ è½½ç®¡ç†å™¨å·²åˆå§‹åŒ–ï¼ˆv2.0 - è¿›åº¦æ¡åŒæ­¥ç‰ˆæœ¬ï¼‰');
        this.totalResources = this.secondaryResources.length;
        
        // åˆå§‹åŒ–æ‰€æœ‰èµ„æºçš„çŠ¶æ€ä¸º 'pending'
        this.secondaryResources.forEach(resource => {
          this.resourceStates[resource.url] = 'pending';
        });
        
        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => this.startSecondaryLoading());
        } else {
          this.startSecondaryLoading();
        }
      },

      /**
       * å¼€å§‹åŠ è½½æ¬¡è¦èµ„æº
       * å¹¶å‘åŠ è½½æ‰€æœ‰èµ„æºï¼Œå®æ—¶æ›´æ–°è¿›åº¦æ¡
       */
      startSecondaryLoading: function() {
        console.log('â³ å¼€å§‹åŠ è½½æ¬¡è¦èµ„æºï¼ˆå¹¶å‘æ¨¡å¼ï¼‰...');
        this.isLoading = true;
        this.loadingStartTime = Date.now();
        
        // å¹¶å‘åŠ è½½æ‰€æœ‰èµ„æºï¼ˆè€Œä¸æ˜¯æŒ‰ä¼˜å…ˆçº§é¡ºåºåŠ è½½ï¼‰
        // è¿™æ ·å¯ä»¥æ›´å‡†ç¡®åœ°åæ˜ å®é™…çš„åŠ è½½è¿›åº¦
        this.secondaryResources.forEach(resource => {
          this.loadResource(resource);
        });
      },

      /**
       * åŠ è½½å•ä¸ªèµ„æº
       * @param {Object} resource - èµ„æºå¯¹è±¡ { type, url, priority }
       */
      loadResource: function(resource) {
        const url = resource.url;

        // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½æˆ–åŠ è½½å¤±è´¥
        if (this.loadedResources.has(url)) {
          console.log(`â­ï¸  èµ„æºå·²åŠ è½½ï¼ˆè·³è¿‡ï¼‰: ${url}`);
          this.resourceStates[url] = 'loaded';
          this.updateProgress();
          return;
        }

        if (this.failedResources.has(url)) {
          console.log(`â­ï¸  èµ„æºåŠ è½½å¤±è´¥ï¼ˆè·³è¿‡ï¼‰: ${url}`);
          this.resourceStates[url] = 'failed';
          this.updateProgress();
          return;
        }

        // æ ‡è®°ä¸ºåŠ è½½ä¸­
        this.resourceStates[url] = 'loading';
        this.loadingResources.add(url);
        this.updateProgress();

        // æ ¹æ®èµ„æºç±»å‹é€‰æ‹©åŠ è½½æ–¹å¼
        switch (resource.type) {
          case 'image':
            this.loadImage(url);
            break;
          case 'script':
            this.loadScript(url);
            break;
          case 'style':
            this.loadStyle(url);
            break;
          default:
            this.resourceStates[url] = 'loaded';
            this.loadedResources.add(url);
            this.loadingResources.delete(url);
            this.updateProgress();
        }
      },

      /**
       * åŠ è½½å›¾ç‰‡èµ„æº
       * @param {string} url - å›¾ç‰‡URL
       */
      loadImage: function(url) {
        const img = new Image();
        
        img.onload = () => {
          this.loadedResources.add(url);
          this.loadingResources.delete(url);
          this.resourceStates[url] = 'loaded';
          this.loadedCount++;
          console.log(`âœ“ å›¾ç‰‡å·²åŠ è½½: ${url}`);
          this.updateProgress();
          this.checkAllResourcesLoaded();
        };
        
        img.onerror = () => {
          console.warn(`âœ— å›¾ç‰‡åŠ è½½å¤±è´¥: ${url}`);
          this.failedResources.add(url);
          this.loadingResources.delete(url);
          this.resourceStates[url] = 'failed';
          this.failedCount++;
          this.updateProgress();
          this.checkAllResourcesLoaded();
        };
        
        // ç«‹å³å¼€å§‹åŠ è½½
        img.src = url;
      },

      /**
       * åŠ è½½è„šæœ¬èµ„æº
       * @param {string} url - è„šæœ¬URL
       */
      loadScript: function(url) {
        const script = document.createElement('script');
        script.src = url;
        script.async = true;
        
        script.onload = () => {
          this.loadedResources.add(url);
          this.loadingResources.delete(url);
          this.resourceStates[url] = 'loaded';
          this.loadedCount++;
          console.log(`âœ“ è„šæœ¬å·²åŠ è½½: ${url}`);
          this.updateProgress();
          this.checkAllResourcesLoaded();
        };
        
        script.onerror = () => {
          console.warn(`âœ— è„šæœ¬åŠ è½½å¤±è´¥: ${url}`);
          this.failedResources.add(url);
          this.loadingResources.delete(url);
          this.resourceStates[url] = 'failed';
          this.failedCount++;
          this.updateProgress();
          this.checkAllResourcesLoaded();
        };
        
        document.body.appendChild(script);
      },

      /**
       * åŠ è½½æ ·å¼èµ„æº
       * @param {string} url - æ ·å¼URL
       */
      loadStyle: function(url) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = url;
        
        link.onload = () => {
          this.loadedResources.add(url);
          this.loadingResources.delete(url);
          this.resourceStates[url] = 'loaded';
          this.loadedCount++;
          console.log(`âœ“ æ ·å¼å·²åŠ è½½: ${url}`);
          this.updateProgress();
          this.checkAllResourcesLoaded();
        };
        
        link.onerror = () => {
          console.warn(`âœ— æ ·å¼åŠ è½½å¤±è´¥: ${url}`);
          this.failedResources.add(url);
          this.loadingResources.delete(url);
          this.resourceStates[url] = 'failed';
          this.failedCount++;
          this.updateProgress();
          this.checkAllResourcesLoaded();
        };
        
        document.head.appendChild(link);
      },

      /**
       * æ›´æ–°åŠ è½½è¿›åº¦ - æ ¸å¿ƒæ–¹æ³•ï¼Œä¸è¿›åº¦æ¡å®Œå…¨åŒæ­¥
       * è®¡ç®—æ–¹å¼ï¼š(å·²åŠ è½½ + å¤±è´¥) / æ€»æ•° * 100
       * è¿™æ ·å¯ä»¥å‡†ç¡®åæ˜ å®é™…çš„åŠ è½½è¿›åº¦
       */
      updateProgress: function() {
        const loadedCount = this.loadedResources.size;
        const failedCount = this.failedResources.size;
        const completedCount = loadedCount + failedCount; // å·²å®Œæˆçš„èµ„æºæ•°ï¼ˆæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰
        const totalCount = this.totalResources;
        
        // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”ï¼šå·²å®Œæˆçš„èµ„æºæ•° / æ€»èµ„æºæ•°
        const progress = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
        
        // åˆ†å‘è¿›åº¦æ›´æ–°äº‹ä»¶
        const progressEvent = new CustomEvent('loadingProgress', {
          detail: {
            progress: progress,
            loaded: loadedCount,
            failed: failedCount,
            completed: completedCount,
            total: totalCount,
            overlayType: 'global'
          }
        });
        window.dispatchEvent(progressEvent);

        console.log(`ğŸ“Š èµ„æºåŠ è½½è¿›åº¦: ${progress}% (${completedCount}/${totalCount}) [å·²åŠ è½½: ${loadedCount}, å¤±è´¥: ${failedCount}]`);
      },

      /**
       * æ£€æŸ¥æ‰€æœ‰èµ„æºæ˜¯å¦åŠ è½½å®Œæˆ
       */
      checkAllResourcesLoaded: function() {
        const completedCount = this.loadedResources.size + this.failedResources.size;
        const totalCount = this.totalResources;
        
        if (completedCount === totalCount) {
          console.log('âœ“ æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆï¼ˆæˆ–å¤±è´¥ï¼‰');
          this.onAllResourcesLoaded();
        }
      },

      /**
       * æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆçš„å›è°ƒ
       */
      onAllResourcesLoaded: function() {
        this.isLoading = false;
        const loadingTime = Date.now() - this.loadingStartTime;
        
        console.log(`ğŸ‰ æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆï¼`);
        console.log(`   - æˆåŠŸåŠ è½½: ${this.loadedCount} ä¸ª`);
        console.log(`   - åŠ è½½å¤±è´¥: ${this.failedCount} ä¸ª`);
        console.log(`   - åŠ è½½è€—æ—¶: ${loadingTime}ms`);
        
        // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥æ¸¸æˆèµ„æºå·²åŠ è½½
        const event = new CustomEvent('resourcesLoaded', {
          detail: {
            loadedCount: this.loadedCount,
            failedCount: this.failedCount,
            totalCount: this.totalResources,
            loadingTime: loadingTime
          }
        });
        window.dispatchEvent(event);
      },

      /**
       * æ·»åŠ èµ„æºåˆ°åŠ è½½é˜Ÿåˆ—
       * @param {Object} resource - èµ„æºå¯¹è±¡
       * @param {string} priority - ä¼˜å…ˆçº§ ('high', 'medium', 'low')
       */
      addResource: function(resource, priority = 'medium') {
        resource.priority = priority;
        this.secondaryResources.push(resource);
        this.resourceStates[resource.url] = 'pending';
        this.totalResources = this.secondaryResources.length;
        console.log(`â• æ·»åŠ èµ„æºåˆ°åŠ è½½é˜Ÿåˆ—: ${resource.url} (ä¼˜å…ˆçº§: ${priority})`);
      },

      /**
       * è·å–åŠ è½½ç»Ÿè®¡ä¿¡æ¯
       * @returns {Object} åŠ è½½ç»Ÿè®¡å¯¹è±¡
       */
      getStats: function() {
        const completedCount = this.loadedResources.size + this.failedResources.size;
        return {
          total: this.totalResources,
          loaded: this.loadedCount,
          failed: this.failedCount,
          completed: completedCount,
          isLoading: this.isLoading,
          progress: this.totalResources > 0 ? Math.round((completedCount / this.totalResources) * 100) : 0
        };
      }
    };

    // æ³¨æ„ï¼šResourceManager çš„åˆå§‹åŒ–ç°åœ¨ç”± Game ç±»åœ¨ main.js ä¸­å¤„ç†
    // ä¸å†éœ€è¦æ‰‹åŠ¨è°ƒç”¨ init()
    // ResourceManager ç°åœ¨æ˜¯ ES6 æ¨¡å—ï¼Œåœ¨ src/utils/ResourceManager.js ä¸­å®šä¹‰
  </script>
  
  <!-- å¢™å£ç´ ææ—‹è½¬å¤„ç†è„šæœ¬ -->
  <script>
    /**
     * å¢™å£ç´ ææ—‹è½¬å¤„ç†å™¨
     * åŠŸèƒ½: å°†å¢™å£ç´ ææ—‹è½¬90åº¦ï¼Œä¸å½±å“å…¶ä»–ç´ æ
     * ä½¿ç”¨æ–¹æ³•: rotateWallAsset(imageUrl, rotationDegrees, callback)
     */
    window.WallAssetRotator = {
      /**
       * æ—‹è½¬å¢™å£ç´ æ
       * @param {string} imageUrl - å¢™å£ç´ æURL
       * @param {number} degrees - æ—‹è½¬è§’åº¦ï¼ˆ90, 180, 270ç­‰ï¼‰
       * @param {function} callback - å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œè¿”å›æ—‹è½¬åçš„å›¾ç‰‡æ•°æ®URL
       */
      rotateWallAsset: function(imageUrl, degrees = 90, callback) {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        img.onload = function() {
          // åˆ›å»ºä¸´æ—¶canvasç”¨äºæ—‹è½¬
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          // æ ¹æ®æ—‹è½¬è§’åº¦è°ƒæ•´canvaså°ºå¯¸
          const radians = (degrees % 360) * Math.PI / 180;
          const cos = Math.abs(Math.cos(radians));
          const sin = Math.abs(Math.sin(radians));
          
          // è®¡ç®—æ–°çš„canvaså°ºå¯¸
          const newWidth = img.width * cos + img.height * sin;
          const newHeight = img.width * sin + img.height * cos;
          
          canvas.width = Math.ceil(newWidth);
          canvas.height = Math.ceil(newHeight);
          
          // ç§»åŠ¨åˆ°ä¸­å¿ƒå¹¶æ—‹è½¬
          ctx.translate(canvas.width / 2, canvas.height / 2);
          ctx.rotate(radians);
          ctx.imageSmoothingEnabled = false; // ä¿æŒåƒç´ é£æ ¼
          
          // ä»ä¸­å¿ƒç»˜åˆ¶å›¾ç‰‡
          ctx.drawImage(img, -img.width / 2, -img.height / 2);
          
          // è·å–æ—‹è½¬åçš„å›¾ç‰‡æ•°æ®URL
          const rotatedImageUrl = canvas.toDataURL('image/png');
          
          if (callback && typeof callback === 'function') {
            callback(rotatedImageUrl);
          }
          
          // è¿”å›æ—‹è½¬åçš„å›¾ç‰‡æ•°æ®
          return rotatedImageUrl;
        };
        
        img.onerror = function() {
          console.error('å¢™å£ç´ æåŠ è½½å¤±è´¥:', imageUrl);
          if (callback && typeof callback === 'function') {
            callback(null);
          }
        };
        
        img.src = imageUrl;
      },
      
      /**
       * å¿«é€Ÿæ—‹è½¬å¢™å£90åº¦
       * @param {string} imageUrl - å¢™å£ç´ æURL
       * @param {function} callback - å®Œæˆåçš„å›è°ƒå‡½æ•°
       */
      rotateWall90: function(imageUrl, callback) {
        this.rotateWallAsset(imageUrl, 90, callback);
      },
      
      /**
       * å¿«é€Ÿæ—‹è½¬å¢™å£180åº¦
       * @param {string} imageUrl - å¢™å£ç´ æURL
       * @param {function} callback - å®Œæˆåçš„å›è°ƒå‡½æ•°
       */
      rotateWall180: function(imageUrl, callback) {
        this.rotateWallAsset(imageUrl, 180, callback);
      },
      
      /**
       * å¿«é€Ÿæ—‹è½¬å¢™å£270åº¦
       * @param {string} imageUrl - å¢™å£ç´ æURL
       * @param {function} callback - å®Œæˆåçš„å›è°ƒå‡½æ•°
       */
      rotateWall270: function(imageUrl, callback) {
        this.rotateWallAsset(imageUrl, 270, callback);
      }
    };
  </script>

  <script>
    // ä¸ºâ€œæ€ªç‰©å›¾é‰´ > å±æ€§ä»‹ç»é¡µï¼ˆå³ä¾§è¯¦æƒ…é¢æ¿ï¼‰â€æ·»åŠ æ•´ä½“æ‹–æ‹½/ç§»åŠ¨èƒ½åŠ›
    // ä½¿ç”¨è¯´æ˜ï¼š
    // 1) ç”¨æˆ·å¯ç›´æ¥æŒ‰ä½è¯¥é¢æ¿ä»»æ„ä½ç½®æ‹–åŠ¨
    // 2) ä¹Ÿå¯é€šè¿‡ window.setBestiaryDetailOffset(x, y) åœ¨ä»£ç ä¸­ç§»åŠ¨ï¼ˆå•ä½ï¼špxï¼‰
    // 3) è‹¥éœ€è¦ç»™åˆ«çš„é¢æ¿å¯ç”¨æ‹–æ‹½ï¼Œå¯è°ƒç”¨ window.enablePanelDrag(dom, opts)
    (function(){
      function enablePanelDrag(el, options){
        if(!el) return null;
        const opts = options || {};
        const handle = opts.handle || el; // å¯æŒ‡å®šæŠŠæ‰‹ï¼Œä¸æŒ‡å®šåˆ™æ•´ä½“å¯æ‹–
        const saveKey = opts.saveKey || null; // æŒä¹…åŒ–ä½ç½®
        let pos = { x: 0, y: 0 };

        // æ¢å¤ä¸Šæ¬¡ä½ç½®
        if(saveKey){
          try{
            const saved = JSON.parse(localStorage.getItem(saveKey));
            if(saved && typeof saved.x === 'number' && typeof saved.y === 'number'){
              pos = saved;
              apply();
            }
          }catch(_e){}
        }

        let start = null;
        let startPos = null;
        handle.style.cursor = handle.style.cursor || 'move';
        handle.style.touchAction = 'none'; // é˜²æ­¢ç§»åŠ¨ç«¯æ»šåŠ¨å¹²æ‰°
        handle.addEventListener('pointerdown', onDown);

        function onDown(e){
          // ä»…å“åº”é¼ æ ‡å·¦é”®/è§¦æ‘¸
          if(e.pointerType === 'mouse' && e.button !== 0) return;
          e.preventDefault();
          handle.setPointerCapture && handle.setPointerCapture(e.pointerId);
          start = { x: e.clientX, y: e.clientY };
          startPos = { ...pos };
          window.addEventListener('pointermove', onMove);
          window.addEventListener('pointerup', onUp);
        }
        function onMove(e){
          const dx = e.clientX - start.x;
          const dy = e.clientY - start.y;
          pos.x = startPos.x + dx;
          pos.y = startPos.y + dy;
          apply();
        }
        function onUp(){
          window.removeEventListener('pointermove', onMove);
          window.removeEventListener('pointerup', onUp);
          if(saveKey){
            try{ localStorage.setItem(saveKey, JSON.stringify(pos)); }catch(_e){}
          }
        }
        function apply(){
          el.style.willChange = 'transform';
          // æ³¨æ„ï¼šå¦‚æœä½ çš„å…ƒç´ å·²æœ‰ transformï¼Œå°†è¢«è¦†ç›–ã€‚å¦‚éœ€åˆå¹¶è¯·æ”¹ä¸ºæ‹¼æ¥ã€‚
          el.style.transform = `translate(${pos.x}px, ${pos.y}px)`;
        }
        return {
          getPosition(){ return { ...pos }; },
          setPosition(x, y){ pos.x = +x || 0; pos.y = +y || 0; apply(); }
        };
      }

      // æš´éœ²é€šç”¨æ–¹æ³•
      window.enablePanelDrag = enablePanelDrag;

      // é»˜è®¤ï¼šè®©â€œå±æ€§ä»‹ç»é¡µï¼ˆå³ä¾§è¯¦æƒ…é¢æ¿ï¼‰â€å¯æ‹–æ‹½
      let dragAPI = null;
      window.addEventListener('DOMContentLoaded', function(){
        const detail = document.querySelector('.bestiary-detail-panel');
        if(detail){
          dragAPI = enablePanelDrag(detail, { saveKey: 'bestiaryDetailPanelPos' });
        }
      });

      // å¯¹å¤–æš´éœ²ä¸€ä¸ªä¾¿æ·æ–¹æ³•ï¼Œä»£ç ä¸­å¯ç›´æ¥ç§»åŠ¨è¯¥é¢æ¿
      window.setBestiaryDetailOffset = function(x, y){
        if(dragAPI){ dragAPI.setPosition(x, y); }
      };
    })();
  </script>

  <!-- ================================================================================================
       Tooltip ä½ç½®å¼ºåˆ¶ä¿®å¤ - ç›´æ¥å¼•ç”¨æœ‰æ•ˆçš„ JS æ–‡ä»¶
       ================================================================================================ -->
  <script>
    // ç«‹å³æ‰§è¡Œä¿®å¤ - ç®€åŒ–ç‰ˆæœ¬ï¼Œç›´æ¥ç§»åŠ¨åˆ° body
    (function() {
      console.log('ğŸ”§ [Tooltipä¿®å¤] è„šæœ¬å¼€å§‹æ‰§è¡Œ...');
      
      function fixNow() {
        const tt = document.getElementById('tooltip');
        const menu = document.getElementById('item-action-menu');
        
        if (tt && tt.parentElement !== document.body) {
          console.warn('âš ï¸ [ä¿®å¤] Tooltip ä¸åœ¨ bodyï¼Œå½“å‰ä½ç½®:', tt.parentElement.tagName, tt.parentElement.id);
          document.body.appendChild(tt);
          console.log('âœ… [ä¿®å¤] Tooltip å·²ç§»åŠ¨åˆ° body');
        }
        
        if (menu && menu.parentElement !== document.body) {
          document.body.appendChild(menu);
          console.log('âœ… [ä¿®å¤] Action Menu å·²ç§»åŠ¨åˆ° body');
        }
      }
      
      // å¤šæ¬¡æ£€æŸ¥ä¿®å¤
      fixNow();
      setTimeout(fixNow, 100);
      setTimeout(fixNow, 500);
      setTimeout(fixNow, 1000);
      setTimeout(() => {
        fixNow();
        console.log('âœ… [ä¿®å¤] æ£€æŸ¥å®Œæˆ');
      }, 2000);
      
    })();
  </script>
</body>
</html>
