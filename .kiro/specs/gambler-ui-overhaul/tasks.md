# 实施计划：赌徒界面全面优化

## 概述

本实施计划将赌徒 UI 优化分解为离散的、增量的编码任务。每个任务都建立在先前的工作之上，并在整个过程中集成测试以尽早发现错误。该计划遵循自下而上的方法：首先是核心系统（粒子系统、动画控制器），然后是视觉增强，然后是交互功能，最后是润色和无障碍。

## 任务

- [x] 1. 设置核心基础设施和粒子系统
  - [x] 1.1 创建带有对象池的 ParticleSystem 类
    - 实现具有可配置最大大小（100 个粒子）的粒子池
    - 创建粒子类型：'dust'、'explosion'、'coin'、'sparkle'
    - 实现带有物理的更新循环（重力、速度、摩擦）
    - 添加带有配置对象的 emit() 方法
    - 实现清理和池管理
    - _需求：5.1、5.2、5.3、5.5_

  - [x] 1.2 为粒子系统对象池编写属性测试
    - **属性 5：粒子系统性能和池化**
    - **验证：需求 5.4、5.5**

  - [x] 1.3 创建 AnimationController 类结构
    - 设置带有对 GamblerUI 引用的控制器
    - 初始化 ReelAnimator、QualityPreviewSystem、ResultEffectRenderer
    - 实现 playSpinAnimation() 编排方法
    - 添加 requestSkip() 和 cleanup() 方法
    - _需求：2.1、2.2、2.3、2.4_

- [x] 2. 实现带有渐进减速的滚轮动画系统
  - [x] 2.1 创建 ReelAnimator 类
    - 实现带有 4 阶段动画的 animate() 方法
    - 阶段 1：加速（0-0.3s）使用 cubic-bezier(0.4, 0, 0.2, 1)
    - 阶段 2：恒速（0.3-2.3s）线性运动
    - 阶段 3：减速（2.3-3.8s）使用 cubic-bezier(0.1, 0.9, 0.3, 1)
    - 阶段 4：顿挫效果（3.8-4.0s）具有 4 个可见步骤
    - 实现带有随机偏移的 calculateFinalPosition()
    - 添加运动模糊效果的 applyBlur() 方法
    - _需求：2.1、2.2、2.3、2.4、2.5_

  - [x] 2.2 为动画时间编写单元测试
    - 测试加速在 0.3s ±50ms 内达到最大速度
    - 测试恒速阶段持续时间
    - 测试顿挫效果创建 4 个步骤
    - _需求：2.1、2.4_

- [x] 3. 实现品质预告和结果效果系统
  - [x] 3.1 创建 QualityPreviewSystem 类
    - 实现带有基于品质效果的 showPreview() 方法
    - RARE：蓝色渐变背景
    - EPIC：紫色渐变 + 边缘发光
    - LEGENDARY：橙色渐变 + 强烈边缘发光 + 屏幕脉冲
    - 添加 clearPreview() 方法
    - 与 SoundController 集成以播放紧张声音
    - _需求：3.1、3.2、3.3、3.4_

  - [x] 3.2 为品质预告激活编写属性测试
    - **属性 2：品质预告激活**
    - **验证：需求 3.1、3.2、3.3、3.4**

  - [x] 3.3 创建 ResultEffectRenderer 类
    - 实现 playResultEffect() 调度方法
    - 实现 COMMON/UNCOMMON 的 playSimpleFade()
    - 实现 RARE 的 playBluePulse()
    - 实现 EPIC 的 playPurpleExplosion()（20-30 个粒子）
    - 实现 LEGENDARY 的 playLegendaryEffect()（50-80 个闪光）
    - 实现带有金币雨、震动、慢动作的 playJackpotEffect()
    - _需求：4.1、4.2、4.3、4.4、4.5_

  - [x] 3.4 为结果效果映射编写属性测试
    - **属性 3：结果效果映射**
    - **验证：需求 4.1、4.2、4.3、4.4、4.5**

  - [x] 3.5 为粒子发射编写属性测试
    - **属性 4：稀有结果的粒子发射**
    - **验证：需求 5.2、5.3**

- [x] 4. 检查点 - 确保核心动画系统工作
  - 确保所有测试通过，如有问题请询问用户。

- [-] 5. 集成老虎机背景和视觉样式
  - [x] 5.1 更新 GamblerUI HTML 结构
    - 添加老虎机背景图像容器
    - 在背景显示区域内定位滚轮条
    - 添加深度效果（box-shadow、z-index 分层）
    - 更新华丽老虎机框架的 CSS
    - _需求：1.1、1.2、1.3_

  - [x] 5.2 为视觉集成编写单元测试
    - 测试背景图像 src 属性
    - 测试滚轮条在边界内的定位
    - 测试 CSS 阴影和分层属性
    - _需求：1.1、1.2、1.3_

  - [x] 5.3 为纵横比保持编写属性测试
    - **属性 1：纵横比保持**
    - **验证：需求 1.4**

  - [x] 5.4 添加环境粒子效果
    - 赌徒面板打开时发射漂浮尘埃粒子
    - 配置尘埃粒子：慢速度、长生命周期、微妙不透明度
    - 在老虎机框架周围定位粒子
    - _需求：5.1_

- [ ] 6. 实现快速跳过和历史追踪
  - [x] 6.1 添加快速跳过功能
    - 在动画期间显示"点击跳过"提示覆盖层
    - 向 AnimationController 添加点击处理程序
    - 实现跳过逻辑：停止动画，播放缩略效果（最多 0.5s）
    - 在动画的最后 0.3s 内禁用跳过
    - _需求：6.1、6.2、6.3、6.4_

  - [x] 6.2 为快速跳过编写属性测试
    - **属性 5：快速跳过功能**
    - **验证：需求 6.2、6.3、6.4**

  - [-] 6.3 创建 HistoryTracker 类
    - 实现带有 FIFO 行为的 addResult()（最多 5 个条目）
    - 实现 detectNearMiss() 以检查传说在 2 个位置内
    - 实现 renderHistory() 以显示迷你卡片
    - 向历史卡片添加品质彩色边框和图标
    - _需求：7.1、7.2、7.3、7.4_

  - [ ] 6.4 为历史 FIFO 行为编写属性测试
    - **属性 6：历史 FIFO 行为**
    - **验证：需求 7.2、7.3、7.4**

  - [ ] 6.5 为历史显示编写单元测试
    - 测试多次旋转后恰好显示 5 个结果
    - 测试添加第 6 个结果时删除最旧条目
    - _需求：7.1、7.2_

- [ ] 7. 实现批量抽取（10 连抽）系统
  - [ ] 7.1 向 UI 添加 10 连抽按钮
    - 创建带有 450 金币成本显示的"10连抽"按钮
    - 为批量抽取添加点击处理程序
    - 当玩家金币少于 450 时禁用按钮
    - _需求：8.1_

  - [ ] 7.2 实现批量抽取逻辑
    - 激活时扣除 450 金币
    - 生成 10 个连续旋转结果
    - 执行快进动画模式（减少持续时间）
    - 在史诗+ 结果上暂停并显示适当效果
    - 显示包含所有 10 个结果的摘要屏幕
    - _需求：8.2、8.3、8.4、8.5_

  - [ ] 7.3 为批量抽取编写属性测试
    - **属性 7：批量抽取金币扣除**
    - **属性 8：批量抽取结果计数**
    - **属性 9：批量抽取稀有暂停**
    - **验证：需求 8.2、8.3、8.4、8.5**

- [ ] 8. 检查点 - 确保交互功能工作
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 9. 实现动态赔率显示和保底可视化
  - [ ] 9.1 向 UI 添加保底进度条
    - 创建显示当前保底计数的进度条元素
    - 显示每个品质等级的当前概率百分比
    - 添加显示保底修改的视觉指示器（例如，"+5% 稀有"）
    - _需求：9.1、9.2、9.4_

  - [ ] 9.2 实现实时保底显示更新
    - 保底计数更改时更新进度条
    - 重新计算并显示修改后的概率
    - 使用平滑过渡动画更改
    - _需求：9.3_

  - [ ] 9.3 为保底显示同步编写属性测试
    - **属性 10：保底显示同步**
    - **验证：需求 9.3**

- [ ] 10. 实现赌徒 NPC 角色和对话
  - [ ] 10.1 创建 GamblerNPC 类
    - 向 UI 添加 NPC 肖像/精灵
    - 实现带有对话气泡和淡入淡出动画的 say() 方法
    - 实现带有上下文感知响应的 getContextualDialogue()
    - 为差一点、传说胜利、高保底、大奖添加对话
    - 实现 hide() 方法
    - _需求：10.1、10.2、10.3、10.4、10.5_

  - [ ] 10.2 为 NPC 上下文对话编写属性测试
    - **属性 11：NPC 上下文对话**
    - **验证：需求 10.2、10.3、10.4**

  - [ ] 10.3 为对话显示编写单元测试
    - 测试对话气泡以淡入动画出现
    - 测试持续时间后自动关闭
    - _需求：10.5_

- [ ] 11. 实现成就集成
  - [ ] 11.1 向 GamblerUI 添加成就追踪
    - 追踪"欧皇"成就的连续史诗+ 结果
    - 追踪"非酋"成就的总保底触发次数
    - 检测"梭哈王"成就的豪赌传说
    - 检测"破产边缘"成就的金币 <100 赌博
    - 满足条件时调用成就系统
    - _需求：11.1、11.2、11.3、11.4_

  - [ ] 11.2 为成就编写属性测试
    - **属性 12：欧皇成就**
    - **属性 13：非酋成就**
    - **属性 14：梭哈王成就**
    - **属性 15：破产边缘成就**
    - **验证：需求 11.1、11.2、11.3、11.4**

- [ ] 12. 实现全面的音效设计
  - [ ] 12.1 创建 SoundController 类
    - 与 AudioManager 集成
    - 实现带有机械齿轮循环的 playSpinStart()
    - 实现带有节奏匹配咔哒声的 playDeceleration()
    - 实现带有品质音调叮声的 playStop()
    - 实现带有人群欢呼和金币级联的 playJackpot()
    - 实现赌场背景音频的 playAmbience()
    - 添加 stopAll() 方法
    - _需求：12.1、12.2、12.3、12.4、12.5_

  - [ ] 12.2 为音效系统编写属性测试
    - **属性 16：旋转声音激活**
    - **属性 17：减速声音节奏**
    - **属性 18：品质音调停止声音**
    - **属性 19：大奖音频序列**
    - **验证：需求 12.1、12.2、12.3、12.4**

  - [ ] 12.3 为氛围音频编写单元测试
    - 测试赌徒系统打开时播放氛围
    - 测试系统关闭时停止氛围
    - _需求：12.5_

- [ ] 13. 检查点 - 确保音频和成就工作
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 14. 实现移动端适配
  - [ ] 14.1 添加触摸友好的按钮大小
    - 确保所有按钮至少为 44x44 像素
    - 在需要的地方添加触摸目标填充
    - 在移动视口大小上测试
    - _需求：14.1_

  - [ ] 14.2 实现快速跳过的滑动手势
    - 向滚轮条添加触摸事件监听器
    - 在动画期间检测滑动手势
    - 滑动时触发快速跳过
    - _需求：14.2_

  - [ ] 14.3 为滑动跳过编写属性测试
    - **属性 20：滑动跳过**
    - **验证：需求 14.2**

  - [ ] 14.4 实现响应式布局
    - 为 320px 到 1920px 范围添加 CSS 媒体查询
    - 在小屏幕上按比例缩放老虎机背景
    - 确保所有断点的可读性
    - 在关键断点（320px、768px、1920px）测试布局
    - _需求：14.3、14.4_

  - [ ] 14.5 为响应式设计编写单元测试
    - 测试按钮大小满足最小 44x44px
    - 测试边界宽度（320px、1920px）的布局
    - 测试小屏幕上的背景缩放
    - _需求：14.1、14.3、14.4_

- [ ] 15. 实现无障碍功能
  - [ ] 15.1 创建 AccessibilityManager 类
    - 使用媒体查询实现 detectReducedMotion()
    - 使用 aria-live 区域实现 announceResult()
    - 为 Tab/Enter/Escape 实现 setupKeyboardNavigation()
    - 添加为减少动画返回 0 的 getAnimationDuration()
    - _需求：15.1、15.2、15.3、15.4、15.5_

  - [ ] 15.2 集成减少动画模式
    - 启用减少动画时跳过所有动画
    - 用简单的颜色闪光替换粒子效果
    - 立即显示结果（0.5s 内）
    - 确保所有功能保持完整
    - _需求：15.1、15.2_

  - [ ] 15.3 为无障碍编写属性测试
    - **属性 21：减少动画绕过**
    - **属性 22：屏幕阅读器公告**
    - **验证：需求 15.1、15.2、15.3**

  - [ ] 15.4 为键盘导航编写单元测试
    - 测试 Tab 循环遍历所有按钮
    - 测试 Enter 激活聚焦按钮
    - 测试 Escape 关闭面板
    - 测试焦点指示器可见
    - _需求：15.4、15.5_

- [ ] 16. 实现性能优化
  - [ ] 16.1 为动画添加 GPU 加速
    - 对所有滚轮动画使用 CSS transform 属性
    - 为动画元素添加 will-change 提示
    - 在 DevTools 中验证 GPU 加速
    - _需求：13.1_

  - [ ] 16.2 实现动画资源的延迟加载
    - 仅在赌徒面板打开时加载粒子纹理
    - 预加载关键资源（背景图像、NPC 精灵）
    - 延迟非关键资源加载
    - _需求：13.3_

  - [ ] 16.3 在面板关闭时添加资源清理
    - 释放粒子系统资源
    - 清除动画计时器和间隔
    - 移除事件监听器
    - 将状态重置为初始值
    - _需求：13.5_

  - [ ] 16.4 为性能优化编写单元测试
    - 测试使用 CSS transform 属性
    - 测试资源在面板打开前不加载
    - 测试关闭时释放资源
    - _需求：13.1、13.3、13.5_

- [ ] 17. 集成和错误处理
  - [ ] 17.1 实现全面的错误处理
    - 为动画失败添加回退（立即结果显示）
    - 优雅地处理音频加载错误（继续而不播放音频）
    - 为缺少背景图像添加回退渐变
    - 处理内存压力（减少粒子数量）
    - 验证和清理保底计数和大奖池
    - 为快速点击添加去抖
    - _需求：设计中的所有错误场景_

  - [ ] 17.2 为错误处理编写单元测试
    - 测试失败时的动画回退
    - 测试文件加载失败时音频继续
    - 测试图像缺失时的背景回退
    - 测试内存压力下的粒子减少
    - 测试状态验证（负保底、NaN 大奖）
    - 测试点击去抖
    - _需求：错误处理场景_

  - [ ] 17.3 在 GamblerUI 中连接所有组件
    - 初始化所有子系统（AnimationController、ParticleSystem 等）
    - 更新 spin() 方法以使用新动画系统
    - 将历史追踪与旋转结果集成
    - 将 NPC 对话连接到游戏事件
    - 确保与现有奖励逻辑的向后兼容性
    - _需求：所有需求_

- [ ] 18. 最终检查点和润色
  - [ ] 18.1 运行完整测试套件
    - 执行所有单元测试
    - 执行所有属性测试（每个 100 次迭代）
    - 验证达到 80% 代码覆盖率
    - 修复任何失败的测试
    - _需求：测试策略_

  - [ ] 18.2 性能验证
    - 测量 100 个活动粒子的帧率
    - 验证在 95% 的测试运行中保持 60fps
    - 在低端设备上测试（限制 CPU）
    - 优化任何性能瓶颈
    - _需求：5.4、13.4_

  - [ ] 18.3 视觉回归测试
    - 捕获每个品质等级结果的屏幕截图
    - 在关键断点测试响应式布局
    - 验证粒子效果正确渲染
    - 测试跨浏览器兼容性
    - _需求：视觉测试策略_

  - [ ] 18.4 无障碍合规性验证
    - 使用屏幕阅读器测试（NVDA 或 JAWS）
    - 验证键盘导航完全工作
    - 彻底测试减少动画模式
    - 确保 WCAG 2.1 AA 合规性
    - _需求：15.1、15.2、15.3、15.4、15.5_

  - [ ] 18.5 最终集成测试
    - 使用现有 AudioManager 测试
    - 使用成就系统测试
    - 使用元存档系统测试（灵魂水晶）
    - 验证保底系统和大奖机制未更改
    - 测试完整用户流程（标准旋转、豪赌、批量抽取）
    - _需求：所有集成点_

- [ ] 19. 最终检查点 - 确保一切工作
  - 确保所有测试通过，如有问题请询问用户。

## 注意事项

- 每个任务都引用特定需求以实现可追溯性
- 检查点确保整个实施过程中的增量验证
- 属性测试验证通用正确性属性（最少 100 次迭代）
- 单元测试验证特定示例、边缘情况和集成点
- 实施保持与现有赌徒逻辑的向后兼容性
- 所有新功能都是优雅降级的渐进增强
- 所有测试都是全面质量保证所必需的
