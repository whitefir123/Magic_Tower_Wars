# 实现计划：铁匠铺UI全面重构

## 概述

本实现计划将现有铁匠铺UI转变为沉浸式、功能完善的系统，解决背包显示、强化功能、宝石系统、NPC交互等关键问题。实现将基于现有的ForgeUI.js和BlacksmithSystem.js，采用渐进式增强策略。

## 任务

- [x] 1. 创建核心基础设施和工具类
  - 创建SpriteManager类用于管理所有精灵图资源
  - 实现精灵图加载、缓存和提取功能
  - 添加错误处理和回退机制
  - _需求: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 1.1 为SpriteManager编写单元测试
  - 测试精灵图加载成功和失败场景
  - 测试图标提取的正确性
  - 测试缓存机制
  - _需求: 14.5_

- [x] 2. 实现背包深度绑定系统
  - [x] 2.1 创建InventoryBinder类
    - 实现背包扫描和装备缓存
    - 使用Proxy监听背包和装备栏变化
    - 实现实时同步回调机制
    - _需求: 1.1, 1.2, 1.3_

  - [x] 2.2 为背包绑定编写属性测试
    - **属性 1: 背包装备显示同步**
    - **验证：需求 1.1**

  - [x] 2.3 为背包变化编写属性测试
    - **属性 2: 背包变化实时更新**
    - **验证：需求 1.2**

  - [x] 2.4 为装备操作编写属性测试
    - **属性 3: 装备操作双向同步**
    - **验证：需求 1.3**

  - [x] 2.5 更新ForgeUI以使用InventoryBinder
    - 在ForgeUI.init()中初始化InventoryBinder
    - 修改renderItemList()使用绑定的装备数据
    - 实现装备图标渲染（使用精灵图或emoji）
    - 添加强化等级标识显示
    - _需求: 1.4, 1.5_

  - [x] 2.6 为强化等级标识编写属性测试
    - **属性 4: 强化等级标识显示**
    - **验证：需求 1.5**

- [x] 3. 实现强化功能面板
  - [x] 3.1 创建EnhancementPanel类
    - 设计面板布局和DOM结构
    - 实现装备详情显示
    - 添加强化按钮和状态管理
    - _需求: 2.1, 2.2_

  - [x] 3.2 为强化按钮显示编写属性测试
    - **属性 5: 强化按钮显示**
    - **验证：需求 2.1**

  - [x] 3.3 创建MaterialSlotManager类
    - 实现3个材料槽位的渲染
    - 添加材料拖拽和点击放置功能
    - 实现材料移除功能
    - 使用精灵图渲染材料图标
    - _需求: 3.1, 3.2, 3.3, 3.5_

  - [x] 3.4 为材料槽位编写属性测试
    - **属性 8: 材料槽位数量**
    - **属性 9: 材料放置功能**
    - **属性 11: 材料移除功能**
    - **验证：需求 3.1, 3.2, 3.5**

  - [x] 3.4 创建SuccessRateCalculator类
    - 实现基础成功率计算
    - 添加材料效果加成计算
    - 实现成功率显示和颜色编码
    - _需求: 2.4, 3.4, 15.1, 15.2, 15.3_

  - [x] 3.5 为成功率计算编写属性测试
    - **属性 7: 成功率显示正确性**
    - **属性 10: 材料效果应用**
    - **验证：需求 2.4, 3.4**

  - [x] 3.6 创建StatComparisonRenderer类
    - 实现当前属性显示
    - 实现预期属性计算和显示
    - 添加绿色/红色箭头和数值对比
    - 显示变化百分比
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

  - [x] 3.7 为属性对比编写属性测试
    - **属性 12: 属性完整显示**
    - **属性 13: 预期属性计算**
    - **属性 14: 属性增加绿色标识**
    - **属性 15: 属性减少红色标识**
    - **验证：需求 4.1, 4.2, 4.3, 4.4**

  - [x] 3.8 实现强化按钮状态管理
    - 添加资源检查和按钮禁用逻辑
    - 显示所需资源提示
    - 实现最大等级检查
    - _需求: 2.2, 2.3_

  - [x] 3.9 为按钮状态编写属性测试
    - **属性 6: 资源不足按钮禁用**
    - **验证：需求 2.3**

- [ ] 4. 检查点 - 确保强化功能正常工作
  - 确保所有测试通过，询问用户是否有问题

- [-] 5. 实现宝石系统面板
  - [x] 5.1 创建GemPanel类
    - 设计宝石镶嵌和合成的标签页布局
    - 实现标签页切换功能
    - _需求: 5.1, 6.1_

  - [x] 5.2 创建GemSocketManager类
    - 渲染装备的宝石槽位
    - 显示空槽位和已镶嵌槽位状态
    - 使用精灵图渲染宝石图标
    - 显示宝石信息（名称、品质、属性）
    - 添加移除宝石按钮和成本显示
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 19.1, 19.2, 19.3, 19.4, 19.5_

  - [ ] 5.3 为宝石槽位编写属性测试
    - **属性 16: 宝石槽位状态显示**
    - **属性 17: 已镶嵌宝石信息完整性**
    - **属性 19: 镶嵌成本显示**
    - **验证：需求 5.1, 5.2, 5.4**

  - [x] 5.4 创建GemSelectionModal类
    - 实现宝石选择弹窗
    - 显示背包中的可用宝石
    - 按品质和类型分组显示
    - 实现宝石选择和镶嵌功能
    - _需求: 20.1, 20.2, 20.3, 20.4, 20.5_

  - [x] 5.5 创建GemSynthesisRenderer类
    - 显示所有可合成的宝石组合
    - 显示所需材料、成功率和结果
    - 使用精灵图渲染宝石图标
    - 显示玩家拥有的宝石数量
    - 实现材料不足时的禁用和提示
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5, 21.1, 21.2, 21.3, 21.4, 21.5_

  - [ ] 5.6 为宝石合成编写属性测试
    - **属性 20: 合成选项完整性**
    - **属性 21: 合成信息完整性**
    - **属性 22: 宝石数量显示同步**
    - **属性 23: 材料不足合成禁用**
    - **验证：需求 6.1, 6.2, 6.4, 6.5**

- [x] 6. 实现NPC可视化和交互系统
  - [x] 6.1 创建BlacksmithNPCRenderer类
    - 创建NPC DOM元素和布局
    - 显示NPC等级和好感度信息
    - 实现NPC点击事件处理
    - _需求: 8.1, 8.4, 8.5_

  - [ ] 6.2 为NPC点击编写属性测试
    - **属性 27: NPC点击对话触发**
    - **验证：需求 8.4, 9.1**

  - [x] 6.3 创建NPCAnimator类
    - 加载铁匠NPC精灵图
    - 实现待机动画循环
    - 实现锻造动画
    - 实现完成动画
    - 根据等级更新NPC外观
    - _需求: 8.2, 8.3_

  - [ ] 6.4 为NPC动画编写属性测试
    - **属性 25: NPC动画状态切换**
    - **属性 26: NPC等级外观变化**
    - **验证：需求 8.2, 8.3**

  - [x] 6.5 创建DialogueSystem类
    - 创建对话界面DOM结构
    - 实现对话文本显示
    - 显示对话选项按钮
    - 处理对话选项点击
    - 根据好感度显示不同对话
    - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

  - [ ] 6.6 为对话系统编写属性测试
    - **属性 28: 好感度对话内容变化**
    - **属性 29: 对话选项好感度更新**
    - **验证：需求 9.2, 9.4**

  - [x] 6.7 创建GiftSystem类
    - 创建礼物选择模态框
    - 显示可赠送物品列表
    - 计算好感度增加值
    - 实现送礼功能和物品移除
    - 显示NPC反馈对话
    - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

  - [ ] 6.8 为送礼系统编写属性测试
    - **属性 30: 送礼好感度计算**
    - **属性 31: 送礼物品移除**
    - **验证：需求 10.3, 10.5**

  - [x] 6.9 创建AffinityManager类
    - 实现好感度进度条渲染
    - 显示好感度等级和称号
    - 实现好感度提升动画
    - 显示下一等级奖励
    - 实现等级提升通知
    - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_

  - [ ] 6.10 为好感度系统编写属性测试
    - **属性 32: 好感度进度条同步**
    - **属性 33: 好感度提升动画**
    - **验证：需求 11.2, 11.3**

- [ ] 7. 检查点 - 确保NPC系统正常工作
  - 确保所有测试通过，询问用户是否有问题

- [-] 8. 实现UI布局和导航系统
  - [x] 8.1 更新ForgeUI背景图片系统
    - 使用提供的背景图片URL
    - 实现背景图片铺满和自适应
    - 添加半透明遮罩层
    - 处理图片加载失败的回退
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

  - [ ] 8.2 为背景图片编写属性测试
    - **属性 24: 背景图片响应式调整**
    - **验证：需求 7.4**

  - [x] 8.3 创建NavigationController类
    - 实现功能按钮布局
    - 添加功能按钮（强化、宝石、合成、拆解）
    - 实现按钮悬停提示
    - 实现页面切换功能
    - 保持背景和NPC在页面切换中显示
    - 添加返回主界面按钮
    - 实现页面切换动画
    - 记住上次使用的页面
    - _需求: 12.3, 12.4, 12.5, 13.1, 13.2, 13.3, 13.4, 13.5_

  - [ ] 8.4 为导航系统编写属性测试
    - **属性 34: 功能按钮悬停提示**
    - **属性 35: 功能页面导航**
    - **属性 36: 页面切换元素持久性**
    - **属性 37: 页面切换动画**
    - **属性 38: 页面状态记忆**
    - **验证：需求 12.5, 13.1, 13.2, 13.4, 13.5**

  - [x] 8.5 实现响应式布局
    - 添加媒体查询CSS
    - 实现桌面、平板、手机布局
    - 调整字体大小和元素尺寸
    - 确保触摸屏可用性
    - _需求: 27.1, 27.2, 27.3, 27.4, 27.5_

  - [ ] 8.6 为响应式布局编写属性测试
    - **属性 40: 响应式布局适配**
    - **验证：需求 27.1-27.5**

- [-] 9. 实现辅助功能和优化
  - [x] 9.1 创建HistoryTracker类
    - 记录所有强化和操作历史
    - 实现历史记录显示界面
    - 支持按时间、装备、类型筛选
    - 保留最近100条记录
    - _需求: 25.1, 25.2, 25.3, 25.4, 25.5_

  - [x] 9.2 实现材料库存显示
    - 显示所有强化材料的库存
    - 使用图标和数字显示
    - 材料为0时灰色显示
    - 实时更新库存
    - 提供材料获取途径提示
    - _需求: 17.1, 17.2, 17.3, 17.4, 17.5_

  - [x] 9.3 实现装备槽位状态显示
    - 显示所有装备槽位
    - 空槽位显示占位符
    - 使用虚线边框区分
    - 点击空槽位显示提示
    - _需求: 18.1, 18.2, 18.3, 18.4, 18.5_

  - [x] 9.4 实现批量操作界面
    - 添加批量强化模式
    - 添加批量拆解模式
    - 显示预计消耗和时间
    - 显示实时进度
    - 显示汇总结果
    - _需求: 24.1, 24.2, 24.3, 24.4, 24.5_

  - [x] 9.5 实现音效反馈系统
    - 集成AudioManager
    - 添加打开/关闭音效
    - 添加按钮点击音效
    - 添加强化成功/失败音效
    - 添加锻造音效
    - _需求: 26.1, 26.2, 26.3, 26.4, 26.5_

  - [ ] 9.6 为音效系统编写属性测试
    - **属性 39: 操作音效播放**
    - **验证：需求 26.1-26.5**

  - [x] 9.7 实现性能优化
    - 为装备列表添加虚拟滚动
    - 缓存精灵图提取的图标
    - 使用requestAnimationFrame优化动画
    - 延迟加载非关键资源
    - _需求: 28.1, 28.2, 28.3, 28.4, 28.5_

- [ ] 10. 实现强化结果动画系统
  - [ ] 10.1 创建EnhancementAnimationController类
    - 播放铁匠锻造动画
    - 播放强化成功特效（金色闪光）
    - 播放强化失败特效（红色烟雾）
    - 动画期间禁用操作按钮
    - 动画结束显示结果
    - _需求: 16.1, 16.2, 16.3, 16.4, 16.5_

  - [ ] 10.2 使用精灵图实现特效动画
    - 加载成功和失败特效精灵图
    - 实现8帧动画播放
    - 控制动画时长和帧率
    - _需求: 14.4, 16.2, 16.3_

  - [ ] 10.3 为精灵图渲染编写属性测试
    - **属性 18: 精灵图正确渲染**
    - **验证：需求 5.3, 6.3, 14.1-14.5**

- [ ] 11. 实现数据持久化和错误处理
  - [x] 11.1 实现自动保存功能
    - 每次操作后自动保存
    - 保存铁匠等级和经验
    - 保存好感度数据
    - 保存装备状态
    - 保存材料库存和历史
    - _需求: 30.1, 30.2, 30.3, 30.4, 30.5_

  - [x] 11.2 实现错误处理
    - 添加精灵图加载失败处理
    - 添加背包数据损坏处理
    - 添加数据同步错误处理
    - 添加资源不足错误提示
    - 添加NPC交互错误处理
    - 添加动画错误处理
    - 添加性能错误处理
    - _需求: 29.1, 29.2, 29.3, 29.4, 29.5_

  - [ ] 11.3 为错误处理编写单元测试
    - 测试各种错误场景
    - 验证错误提示显示
    - 验证恢复机制
    - _需求: 29.1-29.5_

- [ ] 12. 功能解锁和铁匠等级系统
  - [x] 12.1 实现功能解锁提示
    - 显示功能解锁状态
    - 未解锁功能灰色显示
    - 点击显示解锁条件
    - 解锁时显示通知动画
    - 升级后刷新解锁状态
    - _需求: 23.1, 23.2, 23.3, 23.4, 23.5_

  - [x] 12.2 实现铁匠等级进度显示
    - 显示当前等级
    - 显示经验进度条
    - 显示下一等级所需经验
    - 列出下一等级解锁功能
    - 播放升级动画和音效
    - _需求: 22.1, 22.2, 22.3, 22.4, 22.5_

- [ ] 13. 最终检查点 - 集成测试和优化
  - 运行所有单元测试和属性测试
  - 测试所有用户交互路径
  - 验证响应式布局
  - 性能测试（60fps目标）
  - 确保所有测试通过，询问用户是否有问题

- [ ] 14. 文档和代码清理
  - 添加JSDoc注释
  - 更新README文档
  - 清理调试代码
  - 优化代码结构

## 注意事项

- 所有任务都是必需的，包括测试任务
- 每个任务都引用了相关的需求编号
- 属性测试任务明确标注了属性编号和验证的需求
- 检查点任务确保增量验证和用户反馈
- 所有代码使用JavaScript（ES6+）
- 使用现有的AudioManager、BlacksmithSystem等系统
- 保持与现有代码风格一致
