# 需求文档

## 简介

本文档规定了对现有铁匠铺系统进行全面UI重构的需求。重构将解决当前UI的多个关键问题，包括背包物品显示、强化功能缺失、材料槽位缺失、信息对比不足等，并实现一个沉浸式的铁匠铺体验，包括NPC交互、背景图片铺满、功能按钮布局优化等。

## 术语表

- **铁匠铺系统 (Blacksmith_System)**: 管理装备强化、重铸、宝石操作和拆解的核心系统
- **铁匠UI (Forge_UI)**: 铁匠铺的用户界面组件
- **背包深度绑定 (Inventory_Deep_Binding)**: UI与背包数据的实时同步机制
- **装备图标 (Equipment_Icon)**: 装备的可视化图形表示
- **强化材料槽 (Enhancement_Material_Slot)**: 用于放置强化材料的UI槽位
- **保护卷轴 (Protection_Scroll)**: 防止强化失败时等级下降的消耗品
- **幸运石 (Lucky_Stone)**: 提高强化成功率的消耗品
- **数值对比显示 (Stat_Comparison_Display)**: 显示强化前后属性变化的UI组件
- **精灵图 (Sprite_Sheet)**: 包含多个图标的单一图片资源
- **铁匠NPC (Blacksmith_NPC)**: 提供铁匠服务的非玩家角色
- **好感度系统 (Affinity_System)**: 跟踪玩家与NPC关系的系统
- **对话系统 (Dialogue_System)**: 管理NPC对话的系统
- **送礼系统 (Gift_System)**: 允许玩家向NPC赠送物品的系统
- **宝石镶嵌 (Gem_Socketing)**: 在装备上安装宝石的操作
- **宝石合成 (Gem_Synthesis)**: 合并宝石以提升品质的操作

## 需求

### 需求 1: 背包物品深度绑定显示

**用户故事:** 作为玩家，我希望在铁匠铺中看到的背包物品是实际的装备图标而不是简单的信息框，这样我可以直观地识别装备。

#### 验收标准

1. 当玩家打开铁匠铺时，系统应当显示背包中所有可强化装备的图标
2. 当背包内容发生变化时，铁匠铺UI应当实时更新显示
3. 当玩家在铁匠铺中操作装备时，背包数据应当同步更新
4. 系统应当使用装备的实际图标资源而非文本描述
5. 当装备具有强化等级时，图标应当显示强化等级标识

### 需求 2: 强化功能按钮显示

**用户故事:** 作为玩家，我希望点击装备后能看到明确的强化按钮，这样我可以执行强化操作。

#### 验收标准

1. 当玩家选择一件装备时，系统应当在详情面板显示"强化"按钮
2. 当装备已达到最大强化等级时，强化按钮应当显示为禁用状态
3. 当玩家资源不足时，强化按钮应当显示为禁用状态并提示所需资源
4. 强化按钮应当显示当前强化成功率
5. 当玩家点击强化按钮时，系统应当执行强化操作并显示结果

### 需求 3: 强化材料槽位系统

**用户故事:** 作为玩家，我希望有专门的槽位来放置强化材料，这样我可以使用保护卷轴和幸运石来提高成功率。

#### 验收标准

1. 系统应当在强化界面提供至少3个材料槽位
2. 当玩家拖拽或点击材料时，系统应当将材料放入对应槽位
3. 系统应当支持保护卷轴、幸运石等多种强化材料
4. 当材料槽位被占用时，系统应当在强化计算中应用材料效果
5. 玩家应当能够从槽位中移除材料

### 需求 4: 强化数值对比显示

**用户故事:** 作为玩家，我希望看到详细的强化前后数值对比，这样我可以了解强化带来的具体提升。

#### 验收标准

1. 系统应当在强化界面显示当前装备的所有属性值
2. 系统应当显示强化后装备的预期属性值
3. 当属性值增加时，系统应当使用绿色箭头和文字标识
4. 当属性值减少时，系统应当使用红色箭头和文字标识
5. 系统应当显示属性变化的具体数值和百分比

### 需求 5: 宝石镶嵌信息详细化

**用户故事:** 作为玩家，我希望宝石镶嵌页面显示更详细的信息，这样我可以做出更好的决策。

#### 验收标准

1. 系统应当显示每个宝石槽位的状态（空闲/已占用）
2. 当宝石槽位已占用时，系统应当显示宝石的图标、名称、品质和属性加成
3. 系统应当使用精灵图资源正确渲染宝石图标
4. 系统应当显示镶嵌宝石所需的金币成本
5. 系统应当显示移除宝石的选项和成本

### 需求 6: 宝石合成信息详细化

**用户故事:** 作为玩家，我希望宝石合成页面显示更详细的信息，这样我可以了解合成结果。

#### 验收标准

1. 系统应当显示所有可合成的宝石组合
2. 当显示合成选项时，系统应当显示所需材料、合成成功率和结果宝石属性
3. 系统应当使用精灵图资源正确渲染宝石图标
4. 系统应当显示玩家当前拥有的宝石数量
5. 当材料不足时，系统应当禁用合成按钮并提示所需材料

### 需求 7: 背景图片全屏铺满

**用户故事:** 作为玩家，我希望铁匠铺背景图片铺满整个屏幕，这样可以获得更沉浸的体验。

#### 验收标准

1. 系统应当使用提供的背景图片URL (https://i.postimg.cc/NMZFpb0P/tiejiangpubackground1.png)
2. 背景图片应当覆盖整个铁匠铺UI区域
3. 背景图片应当保持正确的宽高比
4. 当窗口大小改变时，背景图片应当自适应调整
5. 系统应当在背景图片上添加半透明遮罩以确保文字可读性

### 需求 8: 铁匠NPC可视化

**用户故事:** 作为玩家，我希望在铁匠铺左侧看到铁匠NPC，这样界面更加生动。

#### 验收标准

1. 系统应当在铁匠铺UI左侧显示铁匠NPC角色
2. 铁匠NPC应当使用精灵图动画显示待机、锻造等动作
3. 系统应当根据铁匠等级显示不同的NPC外观或装饰
4. 铁匠NPC应当可点击以触发对话
5. 系统应当在NPC附近显示等级和好感度信息

### 需求 9: NPC对话系统

**用户故事:** 作为玩家，我希望能够与铁匠NPC对话，这样可以增加游戏的沉浸感。

#### 验收标准

1. 当玩家点击铁匠NPC时，系统应当显示对话界面
2. 系统应当根据好感度等级显示不同的对话内容
3. 对话界面应当提供多个对话选项
4. 当玩家选择对话选项时，系统应当更新好感度
5. 系统应当在对话结束后关闭对话界面

### 需求 10: NPC送礼系统

**用户故事:** 作为玩家，我希望能够向铁匠NPC赠送礼物，这样可以提升好感度。

#### 验收标准

1. 系统应当在NPC交互菜单中提供"送礼"选项
2. 当玩家选择送礼时，系统应当显示可赠送物品列表
3. 系统应当根据礼物类型和品质计算好感度增加值
4. 当送礼成功时，系统应当播放NPC反馈对话
5. 系统应当从玩家背包中移除赠送的物品

### 需求 11: 好感度可视化

**用户故事:** 作为玩家，我希望清楚地看到与铁匠的好感度进度，这样可以了解关系状态。

#### 验收标准

1. 系统应当在铁匠铺UI中显示当前好感度等级和称号
2. 系统应当使用进度条显示当前等级的好感度进度
3. 当好感度提升时，系统应当播放视觉反馈动画
4. 系统应当显示下一个好感度等级的解锁奖励
5. 系统应当在好感度等级提升时显示通知

### 需求 12: 初始界面简洁布局

**用户故事:** 作为玩家，我希望进入铁匠铺时看到简洁的初始界面，只有左边的铁匠NPC和右上角的功能按钮入口，这样界面更加清爽和沉浸。

#### 验收标准

1. 系统应当在初始状态下只显示背景图片、铁匠NPC和功能按钮
2. 铁匠NPC应当固定显示在界面左侧
3. 所有功能按钮（强化、宝石、合成、拆解、批量操作等）应当排列在右上角
4. 初始状态下不显示装备列表、详情面板等内容区域
5. 界面中央应当保持空白，完整展示背景图片

### 需求 12.1: 功能按钮布局优化

**用户故事:** 作为玩家，我希望右上角的功能按钮清晰易用，这样可以快速访问各项功能。

#### 验收标准

1. 功能按钮应当在右上角水平或垂直排列
2. 每个按钮应当具有清晰的图标和文字标签
3. 按钮应当使用半透明背景确保在背景图片上可见
4. 当鼠标悬停在按钮上时，系统应当显示功能说明提示
5. 按钮应当具有视觉反馈（悬停、点击效果）

### 需求 13: 功能页面动态显示

**用户故事:** 作为玩家，我希望点击功能按钮后在界面中央动态显示对应的功能面板，这样可以专注于特定操作。

#### 验收标准

1. 当玩家点击功能按钮时，系统应当在界面中央显示对应的功能面板
2. 功能面板应当以动画方式从右侧滑入或淡入显示
3. 系统应当保持背景图片、铁匠NPC和功能按钮始终可见
4. 功能面板应当提供关闭按钮，点击后面板消失并返回初始状态
5. 同一时间只能显示一个功能面板，切换功能时应当先关闭当前面板

### 需求 13.1: 功能面板布局

**用户故事:** 作为玩家，我希望功能面板布局合理，不会完全遮挡背景和NPC。

#### 验收标准

1. 功能面板应当显示在界面中央偏右的位置
2. 面板应当使用半透明背景，让背景图片部分可见
3. 面板宽度应当适中，不超过屏幕宽度的70%
4. 面板应当避免遮挡左侧的铁匠NPC
5. 面板应当具有清晰的边框和阴影效果，与背景区分

### 需求 14: 精灵图资源正确使用

**用户故事:** 作为开发者，我希望系统正确使用所有提供的精灵图资源，这样可以确保视觉一致性。

#### 验收标准

1. 系统应当使用FORGE_MATERIALS精灵图渲染强化材料图标
2. 系统应当使用FORGE_QUALITY_BORDERS精灵图渲染品质边框
3. 系统应当使用FORGE_BLACKSMITH_NPC精灵图渲染铁匠动画
4. 系统应当使用ENHANCEMENT_SUCCESS和ENHANCEMENT_FAILURE精灵图渲染特效
5. 系统应当正确计算精灵图中每个图标的位置和尺寸

### 需求 15: 强化成功率显示

**用户故事:** 作为玩家，我希望在强化前看到准确的成功率，这样可以评估风险。

#### 验收标准

1. 系统应当在强化按钮附近显示基础成功率
2. 当使用幸运石时，系统应当显示加成后的成功率
3. 系统应当使用颜色编码表示成功率等级（绿色=高，黄色=中，红色=低）
4. 系统应当显示失败时的惩罚说明
5. 当使用保护卷轴时，系统应当标注"失败不降级"

### 需求 16: 强化结果动画

**用户故事:** 作为玩家，我希望看到生动的强化结果动画，这样可以增加操作的刺激感。

#### 验收标准

1. 当强化开始时，系统应当播放铁匠锻造动画
2. 当强化成功时，系统应当播放金色闪光特效
3. 当强化失败时，系统应当播放红色烟雾特效
4. 系统应当在动画播放期间禁用所有操作按钮
5. 系统应当在动画结束后显示结果文字和更新后的装备属性

### 需求 17: 材料库存显示

**用户故事:** 作为玩家，我希望清楚地看到我拥有的强化材料数量，这样可以规划强化策略。

#### 验收标准

1. 系统应当在强化界面显示所有强化材料的库存数量
2. 系统应当使用图标和数字显示材料数量
3. 当材料数量为0时，系统应当使用灰色显示并标注"缺少"
4. 系统应当在使用材料后实时更新库存显示
5. 系统应当提供材料获取途径的提示信息

### 需求 18: 装备槽位状态显示

**用户故事:** 作为玩家，我希望看到哪些装备槽位是空的，这样可以知道需要装备什么。

#### 验收标准

1. 系统应当在装备列表中显示所有装备槽位
2. 当装备槽位为空时，系统应当显示空槽位占位符
3. 空槽位应当显示槽位类型（武器、护甲等）
4. 系统应当使用虚线边框区分空槽位和已装备槽位
5. 当玩家点击空槽位时，系统应当提示"该槽位未装备"

### 需求 19: 宝石槽位可视化

**用户故事:** 作为玩家，我希望直观地看到装备上的宝石槽位，这样可以管理宝石镶嵌。

#### 验收标准

1. 系统应当在装备详情中显示所有宝石槽位
2. 系统应当使用不同颜色区分空槽位和已镶嵌槽位
3. 已镶嵌的槽位应当显示宝石图标和属性加成
4. 系统应当在槽位上显示移除按钮（仅限已镶嵌槽位）
5. 系统应当显示装备的最大槽位数量

### 需求 20: 宝石选择界面

**用户故事:** 作为玩家，我希望在镶嵌宝石时有清晰的选择界面，这样可以选择合适的宝石。

#### 验收标准

1. 当玩家点击空宝石槽位时，系统应当打开宝石选择界面
2. 宝石选择界面应当显示背包中所有可用宝石
3. 系统应当按品质和类型对宝石进行分组显示
4. 每个宝石应当显示图标、名称、品质和属性加成
5. 当玩家选择宝石时，系统应当执行镶嵌操作并关闭选择界面

### 需求 21: 宝石合成预览

**用户故事:** 作为玩家，我希望在合成前看到合成结果预览，这样可以确认操作。

#### 验收标准

1. 系统应当在合成界面显示所有可合成的宝石组合
2. 每个合成选项应当显示所需材料宝石和结果宝石
3. 系统应当显示合成成功率和失败惩罚
4. 系统应当使用箭头图标表示合成转换关系
5. 当玩家点击合成按钮时，系统应当显示确认对话框

### 需求 22: 铁匠等级进度显示

**用户故事:** 作为玩家，我希望看到铁匠的等级和经验进度，这样可以了解解锁新功能的进度。

#### 验收标准

1. 系统应当在铁匠铺UI中显示铁匠当前等级
2. 系统应当使用进度条显示当前等级的经验进度
3. 系统应当显示下一等级所需的经验值
4. 系统应当列出下一等级将解锁的功能
5. 当铁匠升级时，系统应当播放升级动画和音效

### 需求 23: 功能解锁提示

**用户故事:** 作为玩家，我希望知道哪些功能已解锁，哪些功能需要更高等级，这样可以设定目标。

#### 验收标准

1. 系统应当在功能按钮上显示解锁状态
2. 未解锁的功能应当显示为灰色并标注所需等级
3. 当玩家点击未解锁功能时，系统应当显示解锁条件
4. 系统应当在功能解锁时显示通知动画
5. 系统应当在铁匠升级后自动刷新功能解锁状态

### 需求 24: 批量操作界面

**用户故事:** 作为玩家，我希望能够批量强化或拆解装备，这样可以节省时间。

#### 验收标准

1. 系统应当提供批量强化模式，允许设置目标强化等级
2. 系统应当提供批量拆解模式，允许多选装备
3. 批量操作应当显示预计消耗的资源和时间
4. 系统应当在批量操作过程中显示实时进度
5. 系统应当在批量操作完成后显示汇总结果

### 需求 25: 操作历史记录

**用户故事:** 作为玩家，我希望查看最近的强化和操作历史，这样可以追踪我的进度。

#### 验收标准

1. 系统应当记录所有强化、重铸、镶嵌等操作
2. 系统应当提供历史记录查看界面
3. 历史记录应当显示操作时间、装备名称、操作类型和结果
4. 系统应当支持按时间、装备或操作类型筛选历史记录
5. 系统应当保留最近100条操作记录

### 需求 26: 音效反馈系统

**用户故事:** 作为玩家，我希望操作时有相应的音效反馈，这样可以增强沉浸感。

#### 验收标准

1. 当打开铁匠铺时，系统应当播放开门音效
2. 当点击按钮时，系统应当播放点击音效
3. 当强化成功时，系统应当播放成功音效
4. 当强化失败时，系统应当播放失败音效
5. 当铁匠锻造时，系统应当播放锤击音效

### 需求 27: 响应式布局

**用户故事:** 作为玩家，我希望铁匠铺UI在不同屏幕尺寸下都能正常显示，这样可以在各种设备上游玩。

#### 验收标准

1. 系统应当在桌面、平板和手机屏幕上正确显示
2. 当屏幕宽度小于768px时，系统应当切换到移动布局
3. 移动布局应当将装备列表和详情面板垂直排列
4. 系统应当调整字体大小以适应屏幕尺寸
5. 系统应当确保所有交互元素在触摸屏上可用

### 需求 28: 性能优化

**用户故事:** 作为玩家，我希望铁匠铺UI流畅运行，这样可以获得良好的用户体验。

#### 验收标准

1. 系统应当在渲染装备列表时使用虚拟滚动
2. 系统应当缓存精灵图提取的图标以避免重复计算
3. 系统应当使用requestAnimationFrame优化动画性能
4. 系统应当在大量装备时保持60FPS的渲染性能
5. 系统应当延迟加载非关键资源

### 需求 29: 错误处理和提示

**用户故事:** 作为玩家，我希望在操作失败时看到清晰的错误提示，这样可以知道如何解决问题。

#### 验收标准

1. 当资源不足时，系统应当显示具体缺少的资源和数量
2. 当操作失败时，系统应当显示失败原因
3. 系统应当在执行危险操作前显示确认对话框
4. 系统应当在网络错误时显示重试选项
5. 系统应当记录错误日志以便调试

### 需求 30: 数据持久化

**用户故事:** 作为玩家，我希望我的铁匠铺操作和NPC关系被保存，这样下次游戏时可以继续。

#### 验收标准

1. 系统应当在每次操作后自动保存数据
2. 系统应当保存铁匠等级、经验和好感度
3. 系统应当保存装备的强化状态和宝石镶嵌
4. 系统应当保存材料库存和操作历史
5. 系统应当在加载游戏时正确恢复所有铁匠铺数据
