<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- 
    ========================================================================
    Content Security Policy (CSP) - 已临时移除
    ========================================================================
    为了修复 Supabase SDK 加载问题，已暂时移除 CSP 限制
    后续可以重新配置更宽松的 CSP 策略
    ========================================================================
  -->
  <title>魔法塔 RPG - 游戏界面</title>
  <link rel="stylesheet" href="./src/css/main.css" />
  <link rel="stylesheet" href="./mobile-adapt.css" />
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Spectral:wght@400;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Spectral:wght@400;700&display=swap" /></noscript>
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAusB9Y8qjTQAAAAASUVORK5CYII=" />
  <style>
    /* 游戏页面专用样式 */
    body {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      background: #000;
    }

    #main-ui {
      width: 1940px;
      height: 900px;
      display: flex;
      flex-direction: row;
      transform-origin: right center;
    }
  </style>
</head>
<body>
  <!-- GLOBAL LOADING OVERLAY - Must be first child of body for proper z-index stacking -->
  <div id="loading-overlay">
    <div class="loader"></div>
    <div class="loading-bar-container">
      <div id="loading-bar-fill" style="width: 0%"></div>
    </div>
    <div id="loading-percent">0%</div>
    <div class="loading-tips-container">
      <span class="tip-label">提示:</span>
      <span id="loading-tip-text">加载中...</span>
    </div>
    <div class="loading-chase-container">
      <div id="loading-skeleton"></div>
      <div id="loading-butterfly"></div>
    </div>
  </div>
  
  <script>
    (function() {
      try {
        var savedBg = sessionStorage.getItem('currentLoadingBg');
        var overlay = document.getElementById('loading-overlay');
        if (savedBg && overlay) {
          var bgLayer = document.createElement('div');
          bgLayer.className = 'loading-bg-layer active';
          bgLayer.style.backgroundImage = "url('" + savedBg + "')";
          bgLayer.style.opacity = '1';
          // 插入到最底层
          if (overlay.firstChild) {
            overlay.insertBefore(bgLayer, overlay.firstChild);
          } else {
            overlay.appendChild(bgLayer);
          }
        }
      } catch(e) { console.error('BG restore failed', e); }
    })();
  </script>


  <!-- 主游戏UI -->
  <div id="main-ui">
    <div id="left-column">
      <div id="relic-bar">
        <div class="relic-slot"></div><div class="relic-slot"></div><div class="relic-slot"></div>
        <div class="relic-slot"></div><div class="relic-slot"></div><div class="relic-slot"></div>
      </div>
      <div id="canvas-wrapper">
        <canvas id="gameCanvas" width="1200" height="800"></canvas>
        <div id="skill-bar">
          <!-- Skill slots will be generated here by JavaScript -->
        </div>
        <div id="level-splash" class="level-splash">第 2 层</div>

        <div id="system-log-container">
          <div id="log-panel"><div class="log-entry log-entry-init">&gt; 系统已初始化...</div></div>
        </div>
      </div>
    </div>
    <div id="right-sidebar">
      <div class="hp-section">
        <div class="hp-container">
          <div class="hp-bar-inner"><div class="hp-fill hp-fill-full" id="hp-visual-fill"></div></div>
          <div class="hp-text-overlay"><span id="ui-hp">100</span> / <span id="ui-hp-max">100</span></div>
        </div>
        <div class="level-header">Level <span id="ui-lvl">1</span></div>
        <div class="xp-section">
          <div class="xp-bar-bg"><div id="xp-fill"></div></div>
          <div class="xp-text">经验 <b><span id="ui-xp">0</span></b> / <b><span id="ui-xp-max">50</span></b></div>
        </div>
        <div class="rage-section">
          <div class="rage-bar-bg"><div id="rage-fill"></div></div>
          <div class="rage-text">怒气 <span id="rage-text">0%</span></div>
        </div>
      </div>
      <div class="panel-header">角色属性</div>
      <div class="panel-container stats-panel">
        <div class="stats-content">
          <div class="stat-row"><span class="stat-name">物攻</span><span class="stat-val" id="ui-patk">15</span></div>
          <div class="stat-row"><span class="stat-name">魔攻</span><span class="stat-val" id="ui-matk">0</span></div>
          <div class="stat-row"><span class="stat-name">物防</span><span class="stat-val" id="ui-pdef">5</span></div>
          <div class="stat-row"><span class="stat-name">魔防</span><span class="stat-val" id="ui-mdef">0</span></div>
          <div class="stat-row"><span class="stat-name">暴击率</span><span class="stat-val" id="ui-crit">20%</span></div>
          <div class="stat-row"><span class="stat-name">金币</span><span class="stat-val stat-gold" id="ui-gold">0</span></div>
          <div class="stat-row"><span class="stat-name">钥匙</span><span class="stat-val" id="ui-keys">1</span></div>
          <div class="stat-row">
            <span class="stat-name">灵魂水晶</span>
            <span class="stat-val" id="ui-soul-crystals">0</span>
          </div>
        </div>
      </div>
      <div class="panel-header">装备栏</div>
      <div class="panel-container equip-panel">
        <div class="equip-content">
          <div class="equip-socket" data-slot="HELM" title="Helm"></div><div class="equip-socket" data-slot="WEAPON" title="Weapon"></div><div class="equip-socket" data-slot="ARMOR" title="Armor"></div>
          <div class="equip-socket" data-slot="BOOTS" title="Boots"></div><div class="equip-socket" data-slot="RING" title="Ring"></div><div class="equip-socket" data-slot="AMULET" title="Amulet"></div>
        </div>
      </div>
      <div class="btn-actions">
        <button id="btn-ultimate" class="btn-core btn-sidebar" disabled onclick="game.activateUltimate()">必杀技</button>
        <button class="btn-core btn-sidebar" onclick="window.game.saveGame()">保存</button>
        <button class="btn-core btn-sidebar" onclick="window.game.loadGame()">读取</button>
        <button class="btn-core btn-sidebar" onclick="window.game.endGame(false)">退出 / 重置</button>
      </div>
      <div id="debug-content"></div>
    </div>
    <!-- 游戏图标容器 - 位于地图和右侧面板之间 -->
    <div id="game-icons-container">
      <img id="backpack-icon" src="https://i.postimg.cc/kgCXFC1B/beibaotubiao1.png" alt="背包" class="backpack-icon" />
    </div>
  </div>

  <!-- 符文强化界面 -->
  <div id="draft-overlay" class="modal-overlay">
    <h2 id="draft-title" class="modal-title">升级</h2>
    <div class="card-container" id="draft-cards"></div>
    <div class="draft-actions" style="margin-top: 30px; display: flex; gap: 20px; justify-content: center;">
      <button id="draft-reroll-btn" class="btn-core" onclick="if(window.game && window.game.roguelike) window.game.roguelike.reroll()">刷新 (50G)</button>
      <button id="draft-recycle-btn" class="btn-core" onclick="if(window.game && window.game.roguelike) window.game.roguelike.recycle()">放弃 (获得20G)</button>
    </div>
  </div>
  <div id="shrine-overlay" class="modal-overlay hidden">
    <h2 id="shrine-title" class="modal-title">圣殿</h2>
    <div class="card-container" id="shrine-cards"></div>
  </div>

  <!-- 
    ========================================================================
    背包、商店、赌徒、图鉴、设置界面已重构为动态创建
    这些 Overlay 现在由对应的 UI 类在运行时动态生成
    ========================================================================
  -->

  <!-- 死亡界面 -->
  <div id="leaderboard-overlay" class="modal-overlay hidden">
    <div id="game-over-content">
      <h2 id="go-title">你已死亡</h2>
      <div class="stats-grid">
        <div class="stat-item"><span>游戏时间:</span> <span id="go-time">00:00</span></div>
        <div class="stat-item"><span>到达层数:</span> <span id="go-floor">1</span></div>
        <div class="stat-item"><span>击杀怪物:</span> <span id="go-kills">0</span></div>
        <div class="stat-item"><span>总经验值:</span> <span id="go-xp">0</span></div>
        <div class="stat-item"><span>最终金币:</span> <span id="go-gold">0</span></div>
      </div>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button id="btn-retry-game" class="btn-core btn-system btn-system-primary">重试</button>
        <button class="btn-core btn-system" onclick="window.game?.fadeOutAndReload('index.html')">返回主菜单</button>
      </div>
    </div>
  </div>

  <!-- Tooltip 和 Item Action Menu - 必须在 body 直接子元素以避免 transform 影响 -->
  <div id="tooltip" class="hidden"></div>
  <div id="item-action-menu" class="hidden">
    <div class="action-menu-item" data-action="use">使用/装备</div>
    <div class="action-menu-item" data-action="discard">丢弃</div>
    <div class="action-menu-item" data-action="cancel">取消</div>
  </div>

  <!-- Supabase SDK（CDN UMD 构建版本，用于全球排行榜） -->
  <script 
    src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"
    onerror="this.onerror=null;this.src='https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js'"
  ></script>
  
  <!-- 核心游戏脚本 -->
  <script type="module" src="./src/main.js"></script>
</body>
</html>
