<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- 
    ========================================================================
    Content Security Policy (CSP) - å·²ä¸´æ—¶ç§»é™¤
    ========================================================================
    ä¸ºäº†ä¿®å¤ Supabase SDK åŠ è½½é—®é¢˜ï¼Œå·²æš‚æ—¶ç§»é™¤ CSP é™åˆ¶
    åç»­å¯ä»¥é‡æ–°é…ç½®æ›´å®½æ¾çš„ CSP ç­–ç•¥
    ========================================================================
  -->
  <title>é­”æ³•å¡” RPG - æ¸¸æˆç•Œé¢</title>
  <link rel="stylesheet" href="./src/css/main.css" />
  <link rel="stylesheet" href="./mobile-adapt.css" />
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAusB9Y8qjTQAAAAASUVORK5CYII=" />
  <style>
    /* æ¸¸æˆé¡µé¢ä¸“ç”¨æ ·å¼ */
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      background: #000;
    }

    #main-ui {
      width: 1940px;
      height: 900px;
      display: flex;
      flex-direction: row;
      transform-origin: center center;
    }
  </style>
</head>
<body>
  <!-- GLOBAL LOADING OVERLAY - Must be first child of body for proper z-index stacking -->
  <div id="loading-overlay">
    <div class="loader"></div>
    <div class="loading-bar-container">
      <div id="loading-bar-fill" style="width: 0%"></div>
    </div>
    <div id="loading-percent">0%</div>
    <div class="loading-tips-container">
      <span class="tip-label">æç¤º:</span>
      <span id="loading-tip-text">åŠ è½½ä¸­...</span>
    </div>
    <div class="loading-chase-container">
      <div id="loading-skeleton"></div>
      <div id="loading-butterfly"></div>
    </div>
  </div>
  
  <script>
    (function() {
      try {
        var savedBg = sessionStorage.getItem('currentLoadingBg');
        var overlay = document.getElementById('loading-overlay');
        if (savedBg && overlay) {
          // ğŸ”´ å…³é”®ä¿®å¤ï¼šå…ˆè®¾ç½®çº¯é»‘èƒŒæ™¯ï¼Œé˜²æ­¢èƒŒæ™¯åŠ è½½æ—¶çš„é—ªçƒ
          overlay.style.backgroundColor = '#000000';
          
          var bgLayer = document.createElement('div');
          bgLayer.className = 'loading-bg-layer';
          bgLayer.style.backgroundImage = "url('" + savedBg + "')";
          bgLayer.style.opacity = '0'; // åˆå§‹é€æ˜ï¼Œç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆåå†æ˜¾ç¤º
          
          // æ’å…¥åˆ°æœ€åº•å±‚
          if (overlay.firstChild) {
            overlay.insertBefore(bgLayer, overlay.firstChild);
          } else {
            overlay.appendChild(bgLayer);
          }
          
          // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆåå†æ˜¾ç¤ºèƒŒæ™¯ï¼Œé˜²æ­¢é—ªçƒ
          var img = new Image();
          img.onload = function() {
            bgLayer.style.opacity = '1';
            bgLayer.classList.add('active');
            overlay.style.backgroundColor = 'transparent'; // æ¢å¤é€æ˜ï¼Œè®©èƒŒæ™¯å›¾æ˜¾ç¤º
          };
          img.onerror = function() {
            // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä¿æŒçº¯é»‘èƒŒæ™¯
            console.warn('[Game.html] èƒŒæ™¯å›¾åŠ è½½å¤±è´¥ï¼Œä¿æŒçº¯é»‘èƒŒæ™¯');
            overlay.style.backgroundColor = '#000000';
          };
          img.src = savedBg;
        } else {
          // å¦‚æœæ²¡æœ‰ä¿å­˜çš„èƒŒæ™¯ï¼Œä¹Ÿè®¾ç½®çº¯é»‘èƒŒæ™¯
          if (overlay) {
            overlay.style.backgroundColor = '#000000';
          }
        }
      } catch(e) { 
        console.error('BG restore failed', e);
        // å‡ºé”™æ—¶ä¹Ÿè®¾ç½®çº¯é»‘èƒŒæ™¯
        var overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.style.backgroundColor = '#000000';
        }
      }
    })();
  </script>


  <!-- ä¸»æ¸¸æˆUI -->
  <div id="main-ui">
    <div id="left-column">
      <div id="relic-bar">
        <div class="relic-slot"></div><div class="relic-slot"></div><div class="relic-slot"></div>
        <div class="relic-slot"></div><div class="relic-slot"></div><div class="relic-slot"></div>
      </div>
      <div id="canvas-wrapper">
        <canvas id="gameCanvas" width="1200" height="800"></canvas>
        <div id="skill-bar">
          <!-- Skill slots will be generated here by JavaScript -->
        </div>
        <div id="level-splash-container" class="level-splash-container">
          <div id="level-splash-main" class="level-splash-main"></div>
          <div id="level-splash-sub" class="level-splash-sub"></div>
        </div>

        <div id="system-log-container">
          <div id="log-panel"><div class="log-entry log-entry-init">&gt; ç³»ç»Ÿå·²åˆå§‹åŒ–...</div></div>
        </div>
      </div>
    </div>
    <div id="right-sidebar">
      <div class="hp-section">
        <div class="hp-container">
          <div class="hp-bar-inner"><div class="hp-fill hp-fill-full" id="hp-visual-fill"></div></div>
          <div class="hp-text-overlay"><span id="ui-hp">100</span> / <span id="ui-hp-max">100</span></div>
        </div>
        <div class="level-header">Level <span id="ui-lvl">1</span></div>
        <div class="xp-section">
          <div class="xp-bar-bg"><div id="xp-fill"></div></div>
          <div class="xp-text">ç»éªŒ <b><span id="ui-xp">0</span></b> / <b><span id="ui-xp-max">50</span></b></div>
        </div>
        <div class="rage-section">
          <div class="rage-bar-bg"><div id="rage-fill"></div></div>
          <div class="rage-text">æ€’æ°” <span id="rage-text">0%</span></div>
        </div>
      </div>
      <div class="panel-header">è§’è‰²å±æ€§</div>
      <div class="panel-container stats-panel">
        <div class="stats-content">
          <div class="stat-row"><span class="stat-name">ç‰©æ”»</span><span class="stat-val" id="ui-patk">15</span></div>
          <div class="stat-row"><span class="stat-name">é­”æ”»</span><span class="stat-val" id="ui-matk">0</span></div>
          <div class="stat-row"><span class="stat-name">ç‰©é˜²</span><span class="stat-val" id="ui-pdef">5</span></div>
          <div class="stat-row"><span class="stat-name">é­”é˜²</span><span class="stat-val" id="ui-mdef">0</span></div>
          <div class="stat-row"><span class="stat-name">æš´å‡»ç‡</span><span class="stat-val" id="ui-crit">20%</span></div>
          <div class="stat-row"><span class="stat-name">é‡‘å¸</span><span class="stat-val stat-gold" id="ui-gold">0</span></div>
          <div class="stat-row"><span class="stat-name">é’¥åŒ™</span><span class="stat-val" id="ui-keys">1</span></div>
          <div class="stat-row">
            <span class="stat-name">çµé­‚æ°´æ™¶</span>
            <span class="stat-val" id="ui-soul-crystals">0</span>
          </div>
        </div>
      </div>
      <div class="panel-header">è£…å¤‡æ </div>
      <div class="panel-container equip-panel">
        <div class="equip-content">
          <div class="equip-socket" data-slot="HELM" title="Helm"></div><div class="equip-socket" data-slot="WEAPON" title="Weapon"></div><div class="equip-socket" data-slot="ARMOR" title="Armor"></div>
          <div class="equip-socket" data-slot="BOOTS" title="Boots"></div><div class="equip-socket" data-slot="RING" title="Ring"></div><div class="equip-socket" data-slot="AMULET" title="Amulet"></div>
        </div>
      </div>
      <div class="btn-actions">
        <button id="btn-ultimate" class="btn-core btn-sidebar" disabled onclick="game.activateUltimate()">å¿…æ€æŠ€</button>
        <button class="btn-core btn-sidebar" onclick="window.game.saveGame()">ä¿å­˜</button>
        <button class="btn-core btn-sidebar" onclick="window.game.loadGame()">è¯»å–</button>
        <button class="btn-core btn-sidebar" onclick="window.game.endGame(false)">é€€å‡º / é‡ç½®</button>
      </div>
      <div id="debug-content"></div>
    </div>
    <!-- æ¸¸æˆå›¾æ ‡å®¹å™¨ - ä½äºåœ°å›¾å’Œå³ä¾§é¢æ¿ä¹‹é—´ -->
    <div id="game-icons-container">
      <img id="backpack-icon" src="https://i.postimg.cc/kgCXFC1B/beibaotubiao1.png" alt="èƒŒåŒ…" class="backpack-icon" />
    </div>
  </div>

  <!-- ç¬¦æ–‡å¼ºåŒ–ç•Œé¢ -->
  <div id="draft-overlay" class="modal-overlay">
    <h2 id="draft-title" class="modal-title">å‡çº§</h2>
    <div class="card-container" id="draft-cards"></div>
    <div class="draft-actions" style="margin-top: 30px; display: flex; gap: 20px; justify-content: center;">
      <button id="draft-reroll-btn" class="btn-core" onclick="if(window.game && window.game.roguelike) window.game.roguelike.reroll()">åˆ·æ–° (50G)</button>
      <button id="draft-recycle-btn" class="btn-core" onclick="if(window.game && window.game.roguelike) window.game.roguelike.recycle()">æ”¾å¼ƒ (è·å¾—20G)</button>
    </div>
  </div>
  <div id="shrine-overlay" class="modal-overlay hidden">
    <h2 id="shrine-title" class="modal-title">åœ£æ®¿</h2>
    <div class="card-container" id="shrine-cards"></div>
  </div>

  <!-- 
    ========================================================================
    èƒŒåŒ…ã€å•†åº—ã€èµŒå¾’ã€å›¾é‰´ã€è®¾ç½®ç•Œé¢å·²é‡æ„ä¸ºåŠ¨æ€åˆ›å»º
    è¿™äº› Overlay ç°åœ¨ç”±å¯¹åº”çš„ UI ç±»åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆ
    ========================================================================
  -->

  <!-- æ­»äº¡ç•Œé¢ -->
  <div id="leaderboard-overlay" class="modal-overlay hidden">
    <div id="game-over-content">
      <h2 id="go-title">ä½ å·²æ­»äº¡</h2>
      <div class="stats-grid">
        <div class="stat-item"><span>æ¸¸æˆæ—¶é—´:</span> <span id="go-time">00:00</span></div>
        <div class="stat-item"><span>åˆ°è¾¾å±‚æ•°:</span> <span id="go-floor">1</span></div>
        <div class="stat-item"><span>å‡»æ€æ€ªç‰©:</span> <span id="go-kills">0</span></div>
        <div class="stat-item"><span>æ€»ç»éªŒå€¼:</span> <span id="go-xp">0</span></div>
        <div class="stat-item"><span>æœ€ç»ˆé‡‘å¸:</span> <span id="go-gold">0</span></div>
      </div>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button id="btn-retry-game" class="btn-core btn-system btn-system-primary">é‡è¯•</button>
        <button class="btn-core btn-system" onclick="window.game?.fadeOutAndReload('index.html')">è¿”å›ä¸»èœå•</button>
      </div>
    </div>
  </div>

  <!-- Tooltip å’Œ Item Action Menu - å¿…é¡»åœ¨ body ç›´æ¥å­å…ƒç´ ä»¥é¿å… transform å½±å“ -->
  <div id="tooltip" class="hidden"></div>
  <div id="item-action-menu" class="hidden">
    <div class="action-menu-item" data-action="use">ä½¿ç”¨/è£…å¤‡</div>
    <div class="action-menu-item" data-action="discard">ä¸¢å¼ƒ</div>
    <div class="action-menu-item" data-action="cancel">å–æ¶ˆ</div>
  </div>

  <!-- Supabase SDKï¼ˆCDN UMD æ„å»ºç‰ˆæœ¬ï¼Œç”¨äºå…¨çƒæ’è¡Œæ¦œï¼‰ -->
  <script 
    src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"
    onerror="this.onerror=null;this.src='https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js'"
  ></script>
  
  <!-- æ ¸å¿ƒæ¸¸æˆè„šæœ¬ -->
  <script type="module" src="./src/main.js"></script>
</body>
</html>
