<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- 
    ========================================================================
    Content Security Policy (CSP) - å·²ä¸´æ—¶ç§»é™¤
    ========================================================================
    ä¸ºäº†ä¿®å¤ Supabase SDK åŠ è½½é—®é¢˜ï¼Œå·²æš‚æ—¶ç§»é™¤ CSP é™åˆ¶
    åç»­å¯ä»¥é‡æ–°é…ç½®æ›´å®½æ¾çš„ CSP ç­–ç•¥
    ========================================================================
  -->
  <title>é­”æ³•å¡” RPG - æ¸¸æˆç•Œé¢</title>
  <link rel="stylesheet" href="./src/css/main.css" />
  <link rel="stylesheet" href="./mobile-adapt.css" />
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Spectral:wght@400;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Spectral:wght@400;700&display=swap" /></noscript>
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAusB9Y8qjTQAAAAASUVORK5CYII=" />
  <style>
    /* æ¸¸æˆé¡µé¢ä¸“ç”¨æ ·å¼ */
    body {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      background: #000;
    }

    #main-ui {
      width: 1940px;
      height: 900px;
      display: flex;
      flex-direction: row;
      transform-origin: right center;
    }
  </style>
</head>
<body>
  <!-- GLOBAL LOADING OVERLAY - Must be first child of body for proper z-index stacking -->
  <div id="loading-overlay">
    <div class="loader"></div>
    <div class="loading-bar-container">
      <div id="loading-bar-fill" style="width: 0%"></div>
    </div>
    <div id="loading-percent">0%</div>
    <div class="loading-tips-container">
      <span class="tip-label">æç¤º:</span>
      <span id="loading-tip-text">åŠ è½½ä¸­...</span>
    </div>
    <div class="loading-chase-container">
      <div id="loading-skeleton"></div>
      <div id="loading-butterfly"></div>
    </div>
  </div>
  
  <script>
    (function() {
      try {
        var savedBg = sessionStorage.getItem('currentLoadingBg');
        var overlay = document.getElementById('loading-overlay');
        if (savedBg && overlay) {
          var bgLayer = document.createElement('div');
          bgLayer.className = 'loading-bg-layer active';
          bgLayer.style.backgroundImage = "url('" + savedBg + "')";
          bgLayer.style.opacity = '1';
          // æ’å…¥åˆ°æœ€åº•å±‚
          if (overlay.firstChild) {
            overlay.insertBefore(bgLayer, overlay.firstChild);
          } else {
            overlay.appendChild(bgLayer);
          }
        }
      } catch(e) { console.error('BG restore failed', e); }
    })();
  </script>

  <!-- æ¸¸æˆåŠ è½½ç•Œé¢ -->
  <div id="gameplay-loading-overlay" class="loading-overlay-screen hidden">
    <div class="loader"></div>
    <div class="loading-bar-container">
      <div class="loading-bar-fill" style="width: 0%"></div>
    </div>
    <div class="loading-percent">0%</div>
    <div class="loading-tips-container">
      <span class="tip-label">æç¤º:</span>
      <span class="loading-tip-text">åŠ è½½æ¸¸æˆç•Œé¢...</span>
    </div>
    <div class="loading-chase-container">
      <div class="loading-skeleton"></div>
      <div class="loading-butterfly"></div>
    </div>
  </div>

  <!-- ä¸»æ¸¸æˆUI -->
  <div id="main-ui">
    <div id="left-column">
      <div id="relic-bar">
        <div class="relic-slot"></div><div class="relic-slot"></div><div class="relic-slot"></div>
        <div class="relic-slot"></div><div class="relic-slot"></div><div class="relic-slot"></div>
      </div>
      <div id="canvas-wrapper">
        <canvas id="gameCanvas" width="1200" height="800"></canvas>
        <div id="skill-bar">
          <!-- Skill slots will be generated here by JavaScript -->
        </div>
        <div id="level-splash" class="level-splash">ç¬¬ 2 å±‚</div>

        <div id="system-log-container">
          <div id="log-panel"><div class="log-entry log-entry-init">&gt; ç³»ç»Ÿå·²åˆå§‹åŒ–...</div></div>
        </div>
      </div>
    </div>
    <div id="right-sidebar">
      <div class="hp-section">
        <div class="hp-container">
          <div class="hp-bar-inner"><div class="hp-fill hp-fill-full" id="hp-visual-fill"></div></div>
          <div class="hp-text-overlay"><span id="ui-hp">100</span> / <span id="ui-hp-max">100</span></div>
        </div>
        <div class="level-header">Level <span id="ui-lvl">1</span></div>
        <div class="xp-section">
          <div class="xp-bar-bg"><div id="xp-fill"></div></div>
          <div class="xp-text">ç»éªŒ <b><span id="ui-xp">0</span></b> / <b><span id="ui-xp-max">50</span></b></div>
        </div>
        <div class="rage-section">
          <div class="rage-bar-bg"><div id="rage-fill"></div></div>
          <div class="rage-text">æ€’æ°” <span id="rage-text">0%</span></div>
        </div>
      </div>
      <div class="panel-header">è§’è‰²å±æ€§</div>
      <div class="panel-container stats-panel">
        <div class="stats-content">
          <div class="stat-row"><span class="stat-name">ç‰©æ”»</span><span class="stat-val" id="ui-patk">15</span></div>
          <div class="stat-row"><span class="stat-name">é­”æ”»</span><span class="stat-val" id="ui-matk">0</span></div>
          <div class="stat-row"><span class="stat-name">ç‰©é˜²</span><span class="stat-val" id="ui-pdef">5</span></div>
          <div class="stat-row"><span class="stat-name">é­”é˜²</span><span class="stat-val" id="ui-mdef">0</span></div>
          <div class="stat-row"><span class="stat-name">æš´å‡»ç‡</span><span class="stat-val" id="ui-crit">20%</span></div>
          <div class="stat-row"><span class="stat-name">é‡‘å¸</span><span class="stat-val stat-gold" id="ui-gold">0</span></div>
          <div class="stat-row"><span class="stat-name">é’¥åŒ™</span><span class="stat-val" id="ui-keys">1</span></div>
          <div class="stat-row">
            <span class="stat-name">çµé­‚æ°´æ™¶</span>
            <span class="stat-val" id="ui-soul-crystals">0</span>
          </div>
        </div>
      </div>
      <div class="panel-header">è£…å¤‡æ </div>
      <div class="panel-container equip-panel">
        <div class="equip-content">
          <div class="equip-socket" data-slot="HELM" title="Helm"></div><div class="equip-socket" data-slot="WEAPON" title="Weapon"></div><div class="equip-socket" data-slot="ARMOR" title="Armor"></div>
          <div class="equip-socket" data-slot="BOOTS" title="Boots"></div><div class="equip-socket" data-slot="RING" title="Ring"></div><div class="equip-socket" data-slot="AMULET" title="Amulet"></div>
        </div>
      </div>
      <div class="btn-actions">
        <button id="btn-ultimate" class="btn-core btn-sidebar" disabled onclick="game.activateUltimate()">å¿…æ€æŠ€</button>
        <button class="btn-core btn-sidebar" onclick="window.game.saveGame()">ä¿å­˜</button>
        <button class="btn-core btn-sidebar" onclick="window.game.loadGame()">è¯»å–</button>
        <button class="btn-core btn-sidebar" onclick="window.game.endGame(false)">é€€å‡º / é‡ç½®</button>
      </div>
      <div id="debug-content"></div>
    </div>
    <!-- æ¸¸æˆå›¾æ ‡å®¹å™¨ - ä½äºåœ°å›¾å’Œå³ä¾§é¢æ¿ä¹‹é—´ -->
    <div id="game-icons-container">
      <img id="backpack-icon" src="https://i.postimg.cc/kgCXFC1B/beibaotubiao1.png" alt="èƒŒåŒ…" class="backpack-icon" />
    </div>
  </div>

  <!-- ç¬¦æ–‡å¼ºåŒ–ç•Œé¢ -->
  <div id="draft-overlay" class="modal-overlay">
    <h2 id="draft-title" class="modal-title">å‡çº§</h2>
    <div class="card-container" id="draft-cards"></div>
    <div class="draft-actions" style="margin-top: 30px; display: flex; gap: 20px; justify-content: center;">
      <button id="draft-reroll-btn" class="btn-core" onclick="if(window.game && window.game.roguelike) window.game.roguelike.reroll()">åˆ·æ–° (50G)</button>
      <button id="draft-recycle-btn" class="btn-core" onclick="if(window.game && window.game.roguelike) window.game.roguelike.recycle()">æ”¾å¼ƒ (è·å¾—20G)</button>
    </div>
  </div>
  <div id="shrine-overlay" class="modal-overlay hidden">
    <h2 id="shrine-title" class="modal-title">åœ£æ®¿</h2>
    <div class="card-container" id="shrine-cards"></div>
  </div>

  <!-- 
    ========================================================================
    èƒŒåŒ…ã€å•†åº—ã€èµŒå¾’ã€å›¾é‰´ã€è®¾ç½®ç•Œé¢å·²é‡æ„ä¸ºåŠ¨æ€åˆ›å»º
    è¿™äº› Overlay ç°åœ¨ç”±å¯¹åº”çš„ UI ç±»åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆ
    ========================================================================
  -->

  <!-- æ­»äº¡ç•Œé¢ -->
  <div id="leaderboard-overlay" class="modal-overlay hidden">
    <div id="game-over-content">
      <h2 id="go-title">ä½ å·²æ­»äº¡</h2>
      <div class="stats-grid">
        <div class="stat-item"><span>æ¸¸æˆæ—¶é—´:</span> <span id="go-time">00:00</span></div>
        <div class="stat-item"><span>åˆ°è¾¾å±‚æ•°:</span> <span id="go-floor">1</span></div>
        <div class="stat-item"><span>å‡»æ€æ€ªç‰©:</span> <span id="go-kills">0</span></div>
        <div class="stat-item"><span>æ€»ç»éªŒå€¼:</span> <span id="go-xp">0</span></div>
        <div class="stat-item"><span>æœ€ç»ˆé‡‘å¸:</span> <span id="go-gold">0</span></div>
      </div>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button id="btn-retry-game" class="btn-core btn-system btn-system-primary">é‡è¯•</button>
        <button class="btn-core btn-system" onclick="window.game?.fadeOutAndReload('index.html')">è¿”å›ä¸»èœå•</button>
      </div>
    </div>
  </div>

  <!-- Tooltip å’Œ Item Action Menu - å¿…é¡»åœ¨ body ç›´æ¥å­å…ƒç´ ä»¥é¿å… transform å½±å“ -->
  <div id="tooltip" class="hidden"></div>
  <div id="item-action-menu" class="hidden">
    <div class="action-menu-item" data-action="use">ä½¿ç”¨/è£…å¤‡</div>
    <div class="action-menu-item" data-action="discard">ä¸¢å¼ƒ</div>
    <div class="action-menu-item" data-action="cancel">å–æ¶ˆ</div>
  </div>

  <!-- Supabase SDKï¼ˆCDN UMD æ„å»ºç‰ˆæœ¬ï¼Œç”¨äºå…¨çƒæ’è¡Œæ¦œï¼‰ -->
  <script 
    src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"
    onerror="this.onerror=null;this.src='https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js'"
  ></script>
  
  <!-- æ ¸å¿ƒæ¸¸æˆè„šæœ¬ -->
  <script type="module" src="./src/main.js"></script>

  <!-- åŠ è½½ç•Œé¢ç®¡ç†å™¨ -->
  <script>
    /**
     * åŠ è½½èƒŒæ™¯å›¾å¸¸é‡
     */
    const LOADING_BACKGROUNDS = [
      'https://i.postimg.cc/0y72N33X/loadingbackground1.png',
      'https://i.postimg.cc/cCDTwXzg/loadingbackground2.png',
      'https://i.postimg.cc/t4bt70J3/loadingbackground3.png'
    ];

    window.LoadingOverlayManager = {
      overlays: {
        gameplay: {
          id: 'gameplay-loading-overlay',
          barSelector: '.loading-bar-fill',
          percentSelector: '.loading-percent',
          tipSelector: '.loading-tip-text',
          visible: false,
          isLoading: false,
          loadingStartTime: 0,
          minDisplayTime: 500
        }
      },
      currentOverlay: 'gameplay',
      loadProgress: { gameplay: 0 },
      resourcesLoadingComplete: false,
      gameInitializationComplete: false,

      init: function() {
        console.log('ğŸ¬ æ¸¸æˆé¡µé¢åŠ è½½ç•Œé¢ç®¡ç†å™¨å·²åˆå§‹åŒ–');
        this.setupEventListeners();
        this.startGameplayLoading();
      },

      startGameplayLoading: function() {
        this.showOverlay('gameplay', 'åŠ è½½æ¸¸æˆç•Œé¢...');
        this.overlays.gameplay.isLoading = true;
        this.overlays.gameplay.loadingStartTime = Date.now();
        console.log('â³ æ¸¸æˆåŠ è½½ç•Œé¢å·²å¯åŠ¨');
      },

      setupEventListeners: function() {
        const self = this;

        window.addEventListener('gameInitialized', () => {
          console.log('ğŸ® æ¸¸æˆåˆå§‹åŒ–å®Œæˆ');
          self.gameInitializationComplete = true;
          self.setProgress(100, 'gameplay');
          self.setTip('æ¸¸æˆå·²å°±ç»ª', 'gameplay');
          self.checkAndHideOverlay('gameplay');
        });

        window.addEventListener('loadingProgress', (e) => {
          const progress = e.detail?.progress || 0;
          self.setProgress(progress, 'gameplay');
        });

        // æ¨¡æ‹ŸåŠ è½½è¿›åº¦
        let progress = 0;
        const interval = setInterval(() => {
          if (!self.overlays.gameplay.isLoading) {
            clearInterval(interval);
            return;
          }
          progress += Math.random() * 30;
          if (progress > 90) progress = 90;
          self.setProgress(Math.floor(progress), 'gameplay');
        }, 300);
      },

      checkAndHideOverlay: function(overlayType) {
        const config = this.overlays[overlayType];
        if (!config) return;

        if (config.isLoading) {
          console.log(`â³ [${overlayType}] ä»åœ¨åŠ è½½ä¸­ï¼Œæš‚ä¸éšè—`);
          return;
        }

        const displayedTime = Date.now() - config.loadingStartTime;
        const remainingTime = Math.max(0, config.minDisplayTime - displayedTime);

        if (remainingTime > 0) {
          console.log(`â³ [${overlayType}] ç­‰å¾… ${remainingTime}ms åéšè—`);
          setTimeout(() => {
            this.hideOverlay(overlayType);
          }, remainingTime);
        } else {
          this.hideOverlay(overlayType);
        }
      },

      showOverlay: function(overlayType = 'gameplay', tip = 'åŠ è½½ä¸­...') {
        const config = this.overlays[overlayType];
        if (!config) return;

        const overlay = document.getElementById(config.id);
        if (!overlay) return;

        // è®¾ç½®éšæœºèƒŒæ™¯ï¼ˆåœ¨æ˜¾ç¤ºä¹‹å‰ï¼‰
        this.setRandomBackground(config.id);

        overlay.classList.remove('hidden');
        config.visible = true;
        this.currentOverlay = overlayType;

        this.setProgress(0, overlayType);
        this.setTip(tip, overlayType);

        console.log(`âœ… æ˜¾ç¤ºåŠ è½½ç•Œé¢: ${overlayType}`);
      },

      /**
       * è®¾ç½®éšæœºèƒŒæ™¯
       * @param {string} overlayId - åŠ è½½ç•Œé¢å…ƒç´ ID
       */
      setRandomBackground: function(overlayId) {
        const overlay = document.getElementById(overlayId);
        if (!overlay) return;

        // é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿èƒŒæ™¯å›¾æ•°ç»„ä¸ä¸ºç©º
        if (!LOADING_BACKGROUNDS || LOADING_BACKGROUNDS.length === 0) {
          console.warn('âš ï¸ åŠ è½½èƒŒæ™¯å›¾æ•°ç»„ä¸ºç©ºï¼Œè·³è¿‡èƒŒæ™¯è®¾ç½®');
          return;
        }

        // æŸ¥æ‰¾æˆ–åˆ›å»ºèƒŒæ™¯å±‚
        let bgLayer = overlay.querySelector('.loading-bg-layer');
        if (!bgLayer) {
          bgLayer = document.createElement('div');
          bgLayer.className = 'loading-bg-layer';
          // æ’å…¥åˆ°æœ€å‰é¢ï¼Œä½œä¸ºèƒŒæ™¯
          overlay.insertBefore(bgLayer, overlay.firstChild);
        }

        // ç¡®ä¿åˆå§‹é€æ˜åº¦ä¸º0ï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰
        bgLayer.style.opacity = '0';
        bgLayer.style.backgroundImage = 'none'; // å…ˆæ¸…ç©ºï¼Œé¿å…æ˜¾ç¤ºæ—§å›¾ç‰‡

        // éšæœºé€‰æ‹©ä¸€å¼ å›¾ç‰‡
        const randomBg = LOADING_BACKGROUNDS[Math.floor(Math.random() * LOADING_BACKGROUNDS.length)];
        
        // é¢„åŠ è½½å›¾ç‰‡ä»¥é¿å…é—ªçƒ
        const img = new Image();
        img.onerror = () => {
          console.warn(`âš ï¸ èƒŒæ™¯å›¾åŠ è½½å¤±è´¥: ${randomBg}`);
          // åŠ è½½å¤±è´¥æ—¶ä¿æŒé€æ˜ï¼Œä¸æ˜¾ç¤ºèƒŒæ™¯
        };
        img.onload = () => {
          // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿æµè§ˆå™¨å…ˆæ¸²æŸ“èƒŒæ™¯å›¾ï¼Œå†æ‰§è¡Œæ·¡å…¥è¿‡æ¸¡
          requestAnimationFrame(() => {
            bgLayer.style.backgroundImage = `url('${randomBg}')`;
            // å†æ¬¡ä½¿ç”¨ requestAnimationFrame ç¡®ä¿èƒŒæ™¯å›¾å·²æ¸²æŸ“åå†æ·¡å…¥
            requestAnimationFrame(() => {
              bgLayer.style.opacity = '1';
            });
          });
        };
        img.src = randomBg;
        
        // å¤„ç†å›¾ç‰‡å·²ç¼“å­˜çš„æƒ…å†µï¼šå¦‚æœå›¾ç‰‡å·²ç»åŠ è½½å®Œæˆï¼Œç«‹å³è®¾ç½®èƒŒæ™¯
        if (img.complete && img.naturalWidth > 0) {
          bgLayer.style.backgroundImage = `url('${randomBg}')`;
          requestAnimationFrame(() => {
            bgLayer.style.opacity = '1';
          });
        }
      },

      hideOverlay: function(overlayType = 'gameplay') {
        const config = this.overlays[overlayType];
        if (!config) return;

        const overlay = document.getElementById(config.id);
        if (!overlay) return;

        overlay.classList.add('hidden');
        config.visible = false;

        console.log(`âœ… éšè—åŠ è½½ç•Œé¢: ${overlayType}`);
      },

      setProgress: function(progress, overlayType = 'gameplay') {
        progress = Math.max(0, Math.min(100, progress));
        this.loadProgress[overlayType] = progress;

        const config = this.overlays[overlayType];
        if (!config) return;

        const overlay = document.getElementById(config.id);
        if (!overlay || overlay.classList.contains('hidden')) return;

        const barElement = overlay.querySelector(config.barSelector);
        if (barElement) {
          barElement.style.width = progress + '%';
        }

        const percentElement = overlay.querySelector(config.percentSelector);
        if (percentElement) {
          percentElement.textContent = progress + '%';
        }
      },

      setTip: function(tip, overlayType = 'gameplay') {
        const config = this.overlays[overlayType];
        if (!config) return;

        const overlay = document.getElementById(config.id);
        if (!overlay || overlay.classList.contains('hidden')) return;

        const tipElement = overlay.querySelector(config.tipSelector);
        if (tipElement) {
          tipElement.textContent = tip;
        }
      },

      isVisible: function(overlayType = 'gameplay') {
        return this.overlays[overlayType]?.visible || false;
      },

      getProgress: function(overlayType = 'gameplay') {
        return this.loadProgress[overlayType] || 0;
      },

      hideAllOverlays: function() {
        Object.keys(this.overlays).forEach(overlayType => {
          this.hideOverlay(overlayType);
        });
        console.log('âœ… æ‰€æœ‰åŠ è½½ç•Œé¢å·²éšè—');
      }
    };

    window.addEventListener('DOMContentLoaded', () => {
      // âš ï¸ å·²ç¦ç”¨ï¼šç°åœ¨ä½¿ç”¨ src/ui/LoadingUI.js ä¸­çš„ LoadingUI ç±»æ¥ç®¡ç†åŠ è½½ç•Œé¢
      // LoadingUI ç±»åœ¨ main.js çš„ init() æ–¹æ³•ä¸­è¢«åˆå§‹åŒ–ï¼ŒåŒ…å«æç¤ºè¯è½®æ’­åŠŸèƒ½
      // window.LoadingOverlayManager.init();
    });
  </script>

  <!-- CanvasSprite ç±» -->
  <script>
    class CanvasSprite {
      constructor(container, imgUrl, cols, rows, fps){
        this.container = container; if(!container) return;
        this.cols = cols; this.rows = rows; this.fps = fps;
        this.frame = 0; this.totalFrames = cols * rows; this.running = false;
        this.img = new Image(); this.img.decoding = 'async'; this.img.src = imgUrl;
        this.dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
        this.canvas = document.createElement('canvas');
        this.canvas.style.position = 'absolute';
        this.canvas.style.left = '0';
        this.canvas.style.top = '0';
        this.canvas.style.width = this.container.clientWidth + 'px';
        this.canvas.style.height = this.container.clientHeight + 'px';
        this.container.style.position = this.container.style.position || 'relative';
        this.container.style.backgroundImage = 'none';
        this.container.appendChild(this.canvas);
        this.ctx = this.canvas.getContext('2d');
        this.ctx.imageSmoothingEnabled = false;
        this.lastTime = 0;
        this.acc = 0;
        this.frameDur = 1000 / fps;
        this._onResize = () => this.resize();
        window.addEventListener('resize', this._onResize);
        this.img.onload = () => { this.resize(); this.start(); };
      }
      resize(){
        const w = this.container.clientWidth;
        const h = this.container.clientHeight;
        this.canvas.width = Math.max(1, Math.floor(w * this.dpr));
        this.canvas.height = Math.max(1, Math.floor(h * this.dpr));
        this.ctx.setTransform(this.dpr, 0, 0, this.dpr, 0, 0);
        this.srcW = Math.floor(this.img.naturalWidth / this.cols);
        this.srcH = Math.floor(this.img.naturalHeight / this.rows);
        const srcAspect = this.srcW / this.srcH;
        const containerAspect = w / h;
        let dstW, dstH;
        if (srcAspect > containerAspect) {
          dstW = w;
          dstH = w / srcAspect;
        } else {
          dstH = h;
          dstW = h * srcAspect;
        }
        this.dstW = dstW;
        this.dstH = dstH;
        this.dstX = (w - dstW) / 2;
        this.dstY = (h - dstH) / 2;
      }
      start(){ if(!this.running){ this.running = true; this.lastTime = performance.now(); this.tick(this.lastTime); } }
      stop(){ if(this.running){ this.running = false; cancelAnimationFrame(this.raf); window.removeEventListener('resize', this._onResize); } }
      tick(now){
        if(!this.running) return;
        const dt = now - this.lastTime; this.lastTime = now; this.acc += dt;
        while(this.acc >= this.frameDur){ this.acc -= this.frameDur; this.frame = (this.frame + 1) % this.totalFrames; }
        this.draw();
        this.raf = requestAnimationFrame(this.tick.bind(this));
      }
      draw(){
        if(!this.img.complete || !this.img.naturalWidth || !this.img.naturalHeight) return;
        const natW = this.img.naturalWidth;
        const natH = this.img.naturalHeight;
        const col = this.frame % this.cols;
        const row = Math.floor(this.frame / this.cols);
        const sx = Math.round(col * natW / this.cols);
        const sx2 = Math.round((col + 1) * natW / this.cols);
        const sy = Math.round(row * natH / this.rows);
        const sy2 = Math.round((row + 1) * natH / this.rows);
        const sWidth = Math.max(1, sx2 - sx);
        const sHeight = Math.max(1, sy2 - sy);
        const w = this.container.clientWidth;
        const h = this.container.clientHeight;
        this.ctx.clearRect(0, 0, w, h);
        this.ctx.drawImage(this.img, sx, sy, sWidth, sHeight, this.dstX, this.dstY, this.dstW, this.dstH);
      }
    }
    window.CanvasSprite = CanvasSprite;

    window.addEventListener('load', () => {
      setTimeout(() => {
        const idSkel = document.querySelector('.loading-skeleton');
        const idBfly = document.querySelector('.loading-butterfly');
        if (idSkel && !idSkel.__sprite) {
          console.log('ğŸ¦´ åˆå§‹åŒ–æ¸¸æˆåŠ è½½ç•Œé¢å°éª·é«…åŠ¨ç”»');
          idSkel.__sprite = new CanvasSprite(idSkel, 'https://i.postimg.cc/MGft6mWh/xiaokuloujiazai1.png', 4, 1, 5);
        }
        if (idBfly && !idBfly.__sprite) {
          console.log('ğŸ¦‹ åˆå§‹åŒ–æ¸¸æˆåŠ è½½ç•Œé¢è´è¶åŠ¨ç”»');
          idBfly.__sprite = new CanvasSprite(idBfly, 'https://i.postimg.cc/DyjfRzTx/hudie1.png', 4, 1, 16/3);
        }
      }, 100);
    });
  </script>
</body>
</html>
