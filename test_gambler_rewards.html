<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èµŒå¾’å¥–åŠ±æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #1a1a2e;
      color: #fff;
    }
    .test-section {
      background: #16213e;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    .reward-item {
      background: #0f3460;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
      border-left: 4px solid;
    }
    .quality-COMMON { border-color: #a0a0a0; }
    .quality-UNCOMMON { border-color: #5eff00; }
    .quality-RARE { border-color: #0070dd; }
    .quality-EPIC { border-color: #a335ee; }
    .quality-LEGENDARY { border-color: #ff8000; }
    .reward-icon {
      font-size: 32px;
      display: inline-block;
      margin-right: 10px;
    }
    .reward-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .reward-desc {
      font-size: 14px;
      color: #ccc;
      margin-top: 5px;
    }
    button {
      background: #ffd700;
      color: #000;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #ffed4e;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    .stat-box {
      background: #0f3460;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #ffd700;
    }
  </style>
</head>
<body>
  <h1>ğŸ° èµŒå¾’å¥–åŠ±ç³»ç»Ÿæµ‹è¯•</h1>
  
  <div class="test-section">
    <h2>æµ‹è¯•è¯´æ˜</h2>
    <p>âœ… å·²ç§»é™¤ï¼šä¿æŠ¤å·è½´ã€ç¥ç¦çŸ³</p>
    <p>âœ… å·²æ·»åŠ ï¼šç¬¦æ–‡å¥–åŠ±ï¼ˆ10%æ¦‚ç‡ï¼‰</p>
    <p>âœ… å·²æ·»åŠ ï¼šå¹¸è¿çŸ³æè¿°ï¼ˆä½œä¸ºå¼ºåŒ–åº•æ–™ï¼Œ+0.05æˆåŠŸç‡ï¼‰</p>
    <p>âœ… å·²æ·»åŠ ï¼šç¬¦æ–‡æè¿°ï¼ˆæ ¹æ®å“è´¨ä¸åŒï¼‰</p>
  </div>

  <div class="test-section">
    <h2>ç”Ÿæˆæµ‹è¯•</h2>
    <button onclick="testStandardSpin()">æ ‡å‡†æ—‹è½¬ (50G)</button>
    <button onclick="testHighRollerSpin()">è±ªèµŒæ—‹è½¬ (200G)</button>
    <button onclick="testBatchGeneration()">æ‰¹é‡ç”Ÿæˆ100æ¬¡</button>
    <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
  </div>

  <div class="test-section">
    <h2>ç»Ÿè®¡ä¿¡æ¯</h2>
    <div class="stats">
      <div class="stat-box">
        <div>è£…å¤‡</div>
        <div class="stat-value" id="stat-equipment">0</div>
      </div>
      <div class="stat-box">
        <div>æ¶ˆè€—å“</div>
        <div class="stat-value" id="stat-consumable">0</div>
      </div>
      <div class="stat-box">
        <div>ç¬¦æ–‡</div>
        <div class="stat-value" id="stat-rune">0</div>
      </div>
      <div class="stat-box">
        <div>Buff</div>
        <div class="stat-value" id="stat-buff">0</div>
      </div>
      <div class="stat-box">
        <div>çµé­‚æ°´æ™¶</div>
        <div class="stat-value" id="stat-soul">0</div>
      </div>
      <div class="stat-box">
        <div>å¹¸è¿çŸ³</div>
        <div class="stat-value" id="stat-trash">0</div>
      </div>
    </div>
  </div>

  <div class="test-section">
    <h2>ç”Ÿæˆç»“æœ</h2>
    <div id="results"></div>
  </div>

  <script type="module">
    import { GAMBLER_CONFIG, GAMBLE_TIERS } from './src/data/system.js';
    import { RUNE_POOL } from './src/data/Runes.js';
    import { getRandomConsumable, getEquipmentDropForFloor, BUFF_POOL, ITEM_QUALITY } from './src/constants.js';

    window.GAMBLER_CONFIG = GAMBLER_CONFIG;
    window.GAMBLE_TIERS = GAMBLE_TIERS;
    window.RUNE_POOL = RUNE_POOL;
    window.getRandomConsumable = getRandomConsumable;
    window.getEquipmentDropForFloor = getEquipmentDropForFloor;
    window.BUFF_POOL = BUFF_POOL;
    window.ITEM_QUALITY = ITEM_QUALITY;

    const stats = {
      equipment: 0,
      consumable: 0,
      rune: 0,
      buff: 0,
      soul_crystal: 0,
      trash: 0
    };

    function updateStats() {
      document.getElementById('stat-equipment').textContent = stats.equipment;
      document.getElementById('stat-consumable').textContent = stats.consumable;
      document.getElementById('stat-rune').textContent = stats.rune;
      document.getElementById('stat-buff').textContent = stats.buff;
      document.getElementById('stat-soul').textContent = stats.soul_crystal;
      document.getElementById('stat-trash').textContent = stats.trash;
    }

    function generateItemByQuality(quality, tier) {
      const floor = 5;
      
      // å¹¸è¿çŸ³ç”Ÿæˆé€»è¾‘ - æ ¹æ®å“è´¨ç”Ÿæˆä¸åŒç­‰çº§çš„å¹¸è¿çŸ³
      const shouldGenerateLuckyStone = (
        (quality === 'COMMON' && Math.random() < 0.5) ||
        (quality === 'UNCOMMON' && Math.random() < 0.3) ||
        (quality === 'RARE' && Math.random() < 0.2) ||
        (quality === 'EPIC' && Math.random() < 0.15) ||
        (quality === 'LEGENDARY' && Math.random() < 0.1)
      );
      
      if (shouldGenerateLuckyStone) {
        const luckyStoneData = {
          COMMON: {
            name: 'å¹¸è¿çŸ³',
            nameEn: 'Lucky Rock',
            value: 1,
            successRateBonus: 0.0005,
            desc: 'æ™®é€šçš„å¹¸è¿çŸ³ï¼Œå¯ä½œä¸ºå¼ºåŒ–åº•æ–™ä½¿ç”¨ï¼Œæå‡0.05%çš„å¼ºåŒ–æˆåŠŸç‡ã€‚è™½ç„¶æ•ˆæœå¾®å¼±ï¼Œä½†æ€»æ¯”ä¸€æ— æ‰€è·è¦å¥½ã€‚'
          },
          UNCOMMON: {
            name: 'ä¼˜è´¨å¹¸è¿çŸ³',
            nameEn: 'Quality Lucky Rock',
            value: 2,
            successRateBonus: 0.002,
            desc: 'ä¼˜è´¨çš„å¹¸è¿çŸ³ï¼Œè•´å«æ›´å¤šçš„å¹¸è¿ä¹‹åŠ›ï¼Œå¯ä½œä¸ºå¼ºåŒ–åº•æ–™ä½¿ç”¨ï¼Œæå‡0.2%çš„å¼ºåŒ–æˆåŠŸç‡ã€‚'
          },
          RARE: {
            name: 'ç¨€æœ‰å¹¸è¿çŸ³',
            nameEn: 'Rare Lucky Rock',
            value: 5,
            successRateBonus: 0.005,
            desc: 'ç¨€æœ‰çš„å¹¸è¿çŸ³ï¼Œæ•£å‘ç€æ·¡æ·¡çš„å…‰èŠ’ï¼Œå¯ä½œä¸ºå¼ºåŒ–åº•æ–™ä½¿ç”¨ï¼Œæå‡0.5%çš„å¼ºåŒ–æˆåŠŸç‡ã€‚'
          },
          EPIC: {
            name: 'å²è¯—å¹¸è¿çŸ³',
            nameEn: 'Epic Lucky Rock',
            value: 10,
            successRateBonus: 0.008,
            desc: 'å²è¯—çº§çš„å¹¸è¿çŸ³ï¼Œé—ªè€€ç€è¿·äººçš„å…‰è¾‰ï¼Œå¯ä½œä¸ºå¼ºåŒ–åº•æ–™ä½¿ç”¨ï¼Œæå‡0.8%çš„å¼ºåŒ–æˆåŠŸç‡ã€‚'
          },
          LEGENDARY: {
            name: 'ä¼ è¯´å¹¸è¿çŸ³',
            nameEn: 'Legendary Lucky Rock',
            value: 20,
            successRateBonus: 0.01,
            desc: 'ä¼ è¯´ä¸­çš„å¹¸è¿çŸ³ï¼Œè•´å«ç€å‘½è¿å¥³ç¥çš„ç¥ç¦ï¼Œå¯ä½œä¸ºå¼ºåŒ–åº•æ–™ä½¿ç”¨ï¼Œæå‡1%çš„å¼ºåŒ–æˆåŠŸç‡ã€‚'
          }
        };
        
        const data = luckyStoneData[quality] || luckyStoneData.COMMON;
        
        return {
          type: 'trash',
          name: data.name,
          nameEn: data.nameEn,
          quality: quality,
          value: data.value,
          icon: 'ğŸª¨',
          desc: data.desc,
          successRateBonus: data.successRateBonus
        };
      }

      // å†³å®šç‰©å“ç±»å‹
      const typeRoll = Math.random() * 100;
      let currentWeight = 0;
      let selectedType = 'EQUIPMENT';
      
      for (const [type, weight] of Object.entries(GAMBLER_CONFIG.REWARD_WEIGHTS)) {
        currentWeight += weight;
        if (typeRoll < currentWeight) {
          selectedType = type;
          break;
        }
      }

      // ç‰¹æ®Šé™åˆ¶
      if (selectedType === 'SOUL_CRYSTAL' && ['COMMON', 'UNCOMMON'].includes(quality)) {
        selectedType = 'CONSUMABLE';
      }
      
      if (selectedType === 'RUNE' && quality === 'COMMON') {
        selectedType = 'CONSUMABLE';
      }

      switch (selectedType) {
        case 'SOUL_CRYSTAL':
          const amount = quality === 'LEGENDARY' ? 50 : (quality === 'EPIC' ? 20 : 5);
          return {
            type: 'soul_crystal',
            name: `${amount} çµé­‚æ°´æ™¶`,
            quality: quality,
            value: amount,
            icon: 'ğŸ’'
          };

        case 'RUNE':
          let runeRarity = 'COMMON';
          if (quality === 'LEGENDARY') runeRarity = 'LEGENDARY';
          else if (quality === 'EPIC') runeRarity = 'RARE';
          else if (quality === 'RARE') runeRarity = 'RARE';
          else if (quality === 'UNCOMMON') runeRarity = 'COMMON';
          
          const availableRunes = RUNE_POOL.filter(r => 
            r.rarity === runeRarity && r.type === 'STAT'
          );
          
          if (availableRunes.length > 0) {
            const selectedRune = availableRunes[Math.floor(Math.random() * availableRunes.length)];
            
            let desc = '';
            if (quality === 'LEGENDARY') {
              desc = `ä¼ è¯´çº§ç¬¦æ–‡ï¼Œè•´å«å¼ºå¤§çš„åŠ›é‡ã€‚${selectedRune.description}`;
            } else if (quality === 'EPIC') {
              desc = `å²è¯—çº§ç¬¦æ–‡ï¼Œæ•ˆæœæ˜¾è‘—ã€‚${selectedRune.description}`;
            } else if (quality === 'RARE') {
              desc = `ç¨€æœ‰ç¬¦æ–‡ï¼Œå…·æœ‰ä¸é”™çš„æ•ˆæœã€‚${selectedRune.description}`;
            } else {
              desc = `æ™®é€šç¬¦æ–‡ï¼Œæä¾›åŸºç¡€å±æ€§åŠ æˆã€‚${selectedRune.description}`;
            }
            
            return {
              type: 'rune',
              runeId: selectedRune.id,
              name: selectedRune.nameZh || selectedRune.name,
              quality: quality,
              data: selectedRune,
              icon: 'ğŸ“œ',
              desc: desc
            };
          }
          // Fallthrough

        case 'BUFF':
          const buff = BUFF_POOL[Math.floor(Math.random() * BUFF_POOL.length)];
          return {
            type: 'buff',
            name: `Buff: ${buff.name}`,
            quality: quality,
            data: buff,
            icon: 'âš¡'
          };

        case 'CONSUMABLE':
          const cons = getRandomConsumable();
          if (cons) return {
            type: 'consumable',
            itemId: cons.id,
            name: cons.nameZh || cons.name,
            quality: quality,
            data: cons,
            icon: 'ğŸ’Š'
          };
          // Fallthrough

        case 'EQUIPMENT':
        default:
          const equip = getEquipmentDropForFloor(floor);
          if (equip) {
            let icon = 'âš”ï¸';
            if (equip.type === 'ARMOR') icon = 'ğŸ›¡ï¸';
            if (equip.type === 'ACCESSORY') icon = 'ğŸ’';
            
            return {
              type: 'equipment',
              itemId: equip.id,
              name: equip.nameZh || equip.name,
              quality: quality,
              data: equip,
              icon: icon
            };
          }
          
          const gold = Math.floor(10 + Math.random() * 50);
          return {
            type: 'gold',
            name: `${gold} é‡‘å¸`,
            quality: quality,
            value: gold,
            icon: 'ğŸ’°'
          };
      }
    }

    function rollQuality(chances) {
      const total = Object.values(chances).reduce((sum, c) => sum + c, 0);
      if (total === 0) return 'COMMON';
      
      let roll = Math.random() * total;
      for (const [q, c] of Object.entries(chances)) {
        roll -= c;
        if (roll <= 0) return q;
      }
      return 'COMMON';
    }

    function displayReward(reward) {
      const resultsDiv = document.getElementById('results');
      const rewardDiv = document.createElement('div');
      rewardDiv.className = `reward-item quality-${reward.quality}`;
      
      let html = `
        <span class="reward-icon">${reward.icon}</span>
        <div style="display: inline-block; vertical-align: top;">
          <div class="reward-name">${reward.name} [${reward.quality}]</div>
          <div style="color: #888;">ç±»å‹: ${reward.type}</div>
      `;
      
      if (reward.desc) {
        html += `<div class="reward-desc">${reward.desc}</div>`;
      }
      
      if (reward.successRateBonus) {
        html += `<div class="reward-desc">å¼ºåŒ–æˆåŠŸç‡åŠ æˆ: +${(reward.successRateBonus * 100).toFixed(1)}%</div>`;
      }
      
      html += `</div>`;
      rewardDiv.innerHTML = html;
      resultsDiv.insertBefore(rewardDiv, resultsDiv.firstChild);
      
      // æ›´æ–°ç»Ÿè®¡
      stats[reward.type] = (stats[reward.type] || 0) + 1;
      updateStats();
    }

    window.testStandardSpin = function() {
      const tier = GAMBLE_TIERS.STANDARD;
      const quality = rollQuality(tier.chances);
      const reward = generateItemByQuality(quality, 'STANDARD');
      displayReward(reward);
    };

    window.testHighRollerSpin = function() {
      const tier = GAMBLE_TIERS.HIGH_ROLLER;
      const quality = rollQuality(tier.chances);
      const reward = generateItemByQuality(quality, 'HIGH_ROLLER');
      displayReward(reward);
    };

    window.testBatchGeneration = function() {
      for (let i = 0; i < 100; i++) {
        const tier = Math.random() < 0.5 ? GAMBLE_TIERS.STANDARD : GAMBLE_TIERS.HIGH_ROLLER;
        const quality = rollQuality(tier.chances);
        const reward = generateItemByQuality(quality, tier.id);
        stats[reward.type] = (stats[reward.type] || 0) + 1;
      }
      updateStats();
      alert('å·²ç”Ÿæˆ100æ¬¡ï¼ŒæŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯');
    };

    window.clearResults = function() {
      document.getElementById('results').innerHTML = '';
      Object.keys(stats).forEach(key => stats[key] = 0);
      updateStats();
    };

    console.log('âœ… æµ‹è¯•é¡µé¢å·²åŠ è½½');
    console.log('å¥–åŠ±æƒé‡é…ç½®:', GAMBLER_CONFIG.REWARD_WEIGHTS);
  </script>
</body>
</html>
