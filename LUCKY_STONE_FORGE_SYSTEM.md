# 幸运石强化系统实现文档

## 概述
为铁匠铺的武器强化功能添加了幸运石槽位系统，玩家可以放置幸运石来提升强化成功率。

## 功能特性

### 1. 幸运石槽位
- **数量无上限**：可以添加任意数量的幸运石
- **品质限制**：只能放置同一品质的幸运石
- **可视化显示**：每个幸运石都有独立的槽位卡片
- **实时计算**：自动计算总成功率加成

### 2. 幸运石品质与加成
| 品质 | 名称 | 成功率加成 |
|------|------|-----------|
| COMMON | 幸运石 | +0.05% |
| UNCOMMON | 优质幸运石 | +0.2% |
| RARE | 稀有幸运石 | +0.5% |
| EPIC | 史诗幸运石 | +0.8% |
| LEGENDARY | 传说幸运石 | +1% |

### 3. 使用规则
- **添加规则**：
  - 从背包中选择幸运石点击添加
  - 如果已有幸运石，只能添加相同品质的
  - 添加后幸运石从背包移除
  
- **移除规则**：
  - 点击槽位上的 ✕ 按钮移除单个幸运石
  - 点击"清空所有幸运石"按钮一次性移除全部
  - 移除的幸运石返还到背包

- **消耗规则**：
  - 强化成功或失败后，所有幸运石都会被消耗
  - 不会返还到背包

### 4. 成功率计算
```
最终成功率 = 基础成功率 + 祝福石加成 + 幸运石加成
上限：95%
```

## 实现细节

### 修改的文件

#### 1. `src/ui/ForgeUI.js`
- **renderEnhancePanel()**: 添加幸运石槽位显示
- **getLuckyStones()**: 获取背包中的幸运石
- **renderLuckyStoneSlots()**: 渲染幸运石槽位
- **renderLuckyStoneInventory()**: 渲染背包中的幸运石列表
- **setupLuckyStoneListeners()**: 设置事件监听器
- **addLuckyStone()**: 添加幸运石到槽位
- **removeLuckyStone()**: 从槽位移除幸运石
- **clearAllLuckyStones()**: 清空所有幸运石
- **handleEnhance()**: 修改强化逻辑，传递幸运石加成并在强化后消耗

#### 2. `src/systems/EnhancementEngine.js`
- **calculateSuccessProbability()**: 添加 `luckyStoneBonus` 参数
- **enhance()**: 添加 `options.luckyStoneBonus` 支持

### 数据结构

#### 装备对象新增字段
```javascript
item.luckyStoneSlots = [
  {
    name: '幸运石',
    quality: 'COMMON',
    successRateBonus: 0.0005,
    uid: 'stone_xxx'
  },
  // ... 更多幸运石
]
```

#### 幸运石物品结构
```javascript
{
  type: 'trash',
  name: '幸运石',
  quality: 'COMMON',
  successRateBonus: 0.0005,
  uid: 'stone_xxx',
  icon: '🪨'
}
```

## UI设计

### 强化面板布局
```
┌─────────────────────────────────────┐
│ 装备信息                             │
│ - 品质                               │
│ - 强化等级                           │
│ - 成功率 (显示幸运石加成)            │
├─────────────────────────────────────┤
│ 当前属性                             │
├─────────────────────────────────────┤
│ 基础属性                             │
├─────────────────────────────────────┤
│ 幸运石槽位 (同品质可叠加)            │
│ ┌────┐ ┌────┐ ┌────┐               │
│ │ 🪨 │ │ 🪨 │ │ 🪨 │               │
│ │名称│ │名称│ │名称│               │
│ │+X% │ │+X% │ │+X% │               │
│ └────┘ └────┘ └────┘               │
│ [清空所有幸运石]                     │
│                                     │
│ 背包中的幸运石:                      │
│ ┌─────────────────────────┐        │
│ │ 🪨 幸运石 +0.05%    ×3  │        │
│ └─────────────────────────┘        │
├─────────────────────────────────────┤
│ [强化] [重铸] [分解]                 │
└─────────────────────────────────────┘
```

### 样式特点
- **品质颜色**：槽位边框根据幸运石品质显示不同颜色
- **绿色主题**：幸运石区域使用绿色背景和边框
- **交互反馈**：
  - 悬停时高亮显示
  - 不可添加的幸运石显示为半透明
  - 移除按钮悬停时放大

## 使用流程

### 玩家操作流程
1. 打开铁匠铺，选择要强化的装备
2. 在"幸运石槽位"区域查看当前槽位状态
3. 在"背包中的幸运石"列表中点击要添加的幸运石
4. 幸运石被添加到槽位，成功率实时更新
5. 可以继续添加更多相同品质的幸运石
6. 点击"强化"按钮执行强化
7. 强化完成后，所有幸运石被消耗

### 管理幸运石
- **移除单个**：点击槽位右上角的 ✕ 按钮
- **清空全部**：点击"清空所有幸运石"按钮
- **更换品质**：先清空当前幸运石，再添加其他品质

## 技术要点

### 1. 品质限制实现
```javascript
// 检查是否已有不同品质的幸运石
if (item.luckyStoneSlots && item.luckyStoneSlots.length > 0) {
  const existingQuality = item.luckyStoneSlots[0].quality;
  if (existingQuality !== quality) {
    this.showMessage('只能添加相同品质的幸运石！', 'error');
    return;
  }
}
```

### 2. 成功率计算
```javascript
// 计算总幸运石加成
let totalLuckyBonus = 0;
item.luckyStoneSlots.forEach(stone => {
  totalLuckyBonus += stone.successRateBonus || 0;
});

// 计算最终成功率
const finalSuccessRate = Math.min(
  baseSuccessRate + totalLuckyBonus, 
  0.95
);
```

### 3. 强化后消耗
```javascript
// 强化成功或失败后都消耗幸运石
if (this.selectedItem.luckyStoneSlots) {
  this.selectedItem.luckyStoneSlots = [];
}
```

## 测试建议

### 功能测试
1. ✅ 添加单个幸运石
2. ✅ 添加多个相同品质幸运石
3. ✅ 尝试添加不同品质幸运石（应该失败）
4. ✅ 移除单个幸运石
5. ✅ 清空所有幸运石
6. ✅ 强化成功后幸运石被消耗
7. ✅ 强化失败后幸运石被消耗
8. ✅ 成功率正确计算和显示

### UI测试
1. ✅ 槽位显示正确的品质颜色
2. ✅ 背包列表正确分组显示
3. ✅ 不可添加的幸运石显示为禁用状态
4. ✅ 悬停效果正常
5. ✅ 移除按钮交互正常

### 边界测试
1. ✅ 背包中没有幸运石
2. ✅ 添加大量幸运石（测试无上限）
3. ✅ 成功率达到95%上限
4. ✅ 装备没有幸运石槽位时的显示

## 未来扩展

### 可能的改进
1. **幸运石合成**：低品质幸运石合成高品质
2. **特殊幸运石**：提供额外效果（如保护等级）
3. **幸运石套装**：特定组合提供额外加成
4. **幸运石商店**：NPC出售幸运石
5. **幸运石任务**：完成任务获得高品质幸运石

## 总结

幸运石系统为铁匠铺强化功能增加了策略深度：
- 玩家可以通过赌徒系统获得幸运石
- 使用幸运石提升强化成功率
- 需要权衡使用时机和数量
- 增加了资源管理的趣味性

系统设计简洁直观，易于理解和使用，同时为游戏增加了新的玩法循环。
